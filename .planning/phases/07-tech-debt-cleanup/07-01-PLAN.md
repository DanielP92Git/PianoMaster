---
phase: 07-tech-debt-cleanup
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - .planning/phases/05-parental-consent-email/05-VERIFICATION.md
  - src/components/trail/TrailNodeModal.jsx
  - src/locales/en/trail.json
  - src/locales/he/trail.json
  - src/services/apiScores.js
  - src/main.jsx
autonomous: true

must_haves:
  truths:
    - "Phase 05 has VERIFICATION.md documenting completion status"
    - "TrailNodeModal shows 'Memory Game' (en) / localized name for memory_game exercises"
    - "apiScores.js uses shared verifyStudentDataAccess from authorizationUtils.js"
    - "main.jsx has no window.supabase assignment"
  artifacts:
    - path: ".planning/phases/05-parental-consent-email/05-VERIFICATION.md"
      provides: "Phase 05 verification documentation"
      contains: "status: complete"
    - path: "src/components/trail/TrailNodeModal.jsx"
      provides: "Memory game case in getExerciseTypeName switch"
      contains: "case 'memory_game'"
    - path: "src/locales/en/trail.json"
      provides: "English translation for memory_game"
      contains: "memory_game"
    - path: "src/locales/he/trail.json"
      provides: "Hebrew translation for memory_game"
      contains: "memory_game"
    - path: "src/services/apiScores.js"
      provides: "Import from authorizationUtils"
      pattern: "import.*verifyStudentDataAccess.*authorizationUtils"
    - path: "src/main.jsx"
      provides: "Clean production code"
      not_contains: "window.supabase"
  key_links:
    - from: "src/services/apiScores.js"
      to: "src/services/authorizationUtils.js"
      via: "ES module import"
      pattern: "import.*verifyStudentDataAccess.*from.*authorizationUtils"
---

<objective>
Address 4 minor tech debt items identified in v1.2 milestone audit.

Purpose: Clean up documentation gaps, fix UI display issue, remove code duplication, and remove debug code before shipping v1.2.
Output: 4 tech debt items resolved with verified fixes.
</objective>

<execution_context>
@C:\Users\pagis\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\pagis\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-parental-consent-email/05-01-SUMMARY.md
@.planning/phases/05-parental-consent-email/05-02-SUMMARY.md
@src/components/trail/TrailNodeModal.jsx
@src/services/apiScores.js
@src/services/authorizationUtils.js
@src/main.jsx
@src/locales/en/trail.json
@src/locales/he/trail.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Phase 05 VERIFICATION.md</name>
  <files>.planning/phases/05-parental-consent-email/05-VERIFICATION.md</files>
  <action>
Create a verification document for Phase 05 (Parental Consent Email).

Based on 05-01-SUMMARY.md and 05-02-SUMMARY.md, document:
1. Phase status: complete
2. Requirements verified:
   - EMAIL-01: Edge Function sends consent email via Brevo API
   - EMAIL-02: Email contains child-friendly branding
   - EMAIL-03: Consent URL works end-to-end
   - FIX-01: No 406 errors during role detection
   - FIX-02: Resend button works, expired/invalid tokens show messages
3. Key files created/modified (from summaries)
4. Completion date: 2026-02-02

Use standard VERIFICATION.md format with frontmatter:
```yaml
---
phase: 05-parental-consent-email
status: complete
verified_date: 2026-02-02
---
```
  </action>
  <verify>File exists at .planning/phases/05-parental-consent-email/05-VERIFICATION.md with status: complete</verify>
  <done>Phase 05 has verification documentation matching v1.0-v1.1 phase patterns</done>
</task>

<task type="auto">
  <name>Task 2: Add memory_game case to TrailNodeModal</name>
  <files>
    - src/components/trail/TrailNodeModal.jsx
    - src/locales/en/trail.json
    - src/locales/he/trail.json
  </files>
  <action>
Fix the missing memory_game case in getExerciseTypeName() function (lines 19-32).

1. In TrailNodeModal.jsx, add case to switch statement:
```javascript
case 'memory_game':
  return t('trail:exerciseTypes.memory_game');
```
Insert before the default case.

2. In src/locales/en/trail.json, add to exerciseTypes object:
```json
"memory_game": "Memory Game"
```

3. In src/locales/he/trail.json, add to exerciseTypes object:
```json
"memory_game": "משחק זיכרון"
```

Note: The Hebrew translation means "Memory Game" (literally "game of memory").
  </action>
  <verify>
Search for "memory_game" in TrailNodeModal.jsx shows the new case.
Search for "memory_game" in both locale files shows translations.
  </verify>
  <done>TrailNodeModal displays "Memory Game" instead of raw "memory_game" for memory exercises</done>
</task>

<task type="auto">
  <name>Task 3: Remove duplicate verifyStudentDataAccess from apiScores.js</name>
  <files>src/services/apiScores.js</files>
  <action>
Replace the local verifyStudentDataAccess function with an import from authorizationUtils.js.

Current state (lines 1-36): apiScores.js has its own verifyStudentDataAccess that returns just `true`.
Target state: Import the canonical version from authorizationUtils.js that returns `{ userId, isOwner, isTeacher }`.

1. Remove the local function definition (lines 4-36, keeping the comment block about what it does is optional)
2. Add import at top of file:
```javascript
import { verifyStudentDataAccess } from './authorizationUtils';
```
3. Keep the existing import of supabase and checkRateLimit

The function is called on line 39 as `await verifyStudentDataAccess(studentId)`. Since the canonical version also returns (and throws on error), the call site requires no changes.

Note: The canonical version uses .maybeSingle() (more robust), while the local version uses .single() (can throw 406). This is an improvement.
  </action>
  <verify>
Grep apiScores.js for "import.*verifyStudentDataAccess.*authorizationUtils" shows the import.
Grep apiScores.js for "async function verifyStudentDataAccess" shows no local definition.
Run `npm run lint` to verify no import errors.
  </verify>
  <done>apiScores.js uses the shared verifyStudentDataAccess from authorizationUtils.js, eliminating duplication</done>
</task>

<task type="auto">
  <name>Task 4: Remove window.supabase debug code from main.jsx</name>
  <files>src/main.jsx</files>
  <action>
Remove the debug code that exposes supabase on the window object.

Current state (lines 53-54):
```javascript
// Expose supabase for debugging (remove in production)
window.supabase = supabase;
```

Action: Delete both lines (the comment and the assignment).

The import of supabase on line 51 should REMAIN since it may be used elsewhere or is part of the standard setup pattern. Only remove the window assignment.

Verify the supabase import is still present but window assignment is gone.
  </action>
  <verify>
Grep main.jsx for "window.supabase" shows no matches.
Grep main.jsx for "import supabase" confirms import is still present.
Run `npm run build` to verify no build errors.
  </verify>
  <done>main.jsx has no window.supabase assignment, removing debug code from production</done>
</task>

</tasks>

<verification>
After all tasks complete:
1. `ls .planning/phases/05-parental-consent-email/` shows 05-VERIFICATION.md
2. `grep -n "memory_game" src/components/trail/TrailNodeModal.jsx` shows the new case
3. `grep -n "memory_game" src/locales/en/trail.json src/locales/he/trail.json` shows both translations
4. `grep -n "authorizationUtils" src/services/apiScores.js` shows the import
5. `grep -n "window.supabase" src/main.jsx` returns empty (no matches)
6. `npm run lint` passes
7. `npm run build` succeeds
</verification>

<success_criteria>
1. Phase 05 has VERIFICATION.md file documenting completion
2. TrailNodeModal shows "Memory Game" instead of "memory_game" for memory exercises
3. apiScores.js imports verifyStudentDataAccess from authorizationUtils.js (no local definition)
4. main.jsx has no window.supabase assignment
5. All linting and build checks pass
</success_criteria>

<output>
After completion, create `.planning/phases/07-tech-debt-cleanup/07-01-SUMMARY.md`
</output>
