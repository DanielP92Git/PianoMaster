---
phase: 11-integration-cutover
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/data/skillTrail.js
  - supabase/migrations/20260204000001_reset_trail_progress_v13.sql
autonomous: true

must_haves:
  truths:
    - "SKILL_NODES exports only expandedNodes (no LEGACY_NODES)"
    - "Database migration resets trail progress but preserves XP totals"
    - "LEGACY_NODES array has deprecation comment for Phase 12"
  artifacts:
    - path: "src/data/skillTrail.js"
      provides: "Cutover SKILL_NODES export"
      contains: "export const SKILL_NODES = [...expandedNodes]"
    - path: "supabase/migrations/20260204000001_reset_trail_progress_v13.sql"
      provides: "Progress reset migration"
      contains: "DELETE FROM student_skill_progress"
  key_links:
    - from: "src/data/skillTrail.js"
      to: "src/data/expandedNodes.js"
      via: "default import"
      pattern: "import expandedNodes from './expandedNodes.js'"
---

<objective>
Execute the atomic cutover from legacy trail nodes to the redesigned 87-node system.

Purpose: This plan implements the core code and database changes required for the v1.3 trail system cutover. After this plan, SKILL_NODES will contain only the redesigned nodes (treble 1-3, bass 1-3, rhythm 1-6), and a database migration will be ready to reset user progress at deploy time.

Output: Updated skillTrail.js and Supabase migration file ready for single-commit deployment.
</objective>

<execution_context>
@C:\Users\pagis\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\pagis\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/11-integration-cutover/11-CONTEXT.md
@.planning/phases/11-integration-cutover/11-RESEARCH.md
@src/data/skillTrail.js
@src/data/expandedNodes.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create progress reset migration</name>
  <files>supabase/migrations/20260204000001_reset_trail_progress_v13.sql</files>
  <action>
Create a Supabase migration file that:

1. Uses transaction block (BEGIN/COMMIT) for atomicity
2. Logs pre-migration state (student count, progress records, total XP)
3. Deletes trail-specific progress:
   - DELETE FROM student_skill_progress
   - DELETE FROM student_daily_goals
   - DELETE FROM student_unit_progress (if exists)
4. Leaves XP totals untouched (students.total_xp, students.current_level)
5. Logs post-migration state (confirms XP preserved)
6. Adds table comment documenting the reset

Follow the pattern from 11-RESEARCH.md "Progress Reset Migration" example.
Timestamp format: YYYYMMDDHHMMSS (use 20260204000001).

WHY this approach:
- Transaction ensures all-or-nothing reset
- Logging aids debugging if issues arise
- XP preservation maintains user motivation per CONTEXT.md decision
  </action>
  <verify>
File exists at supabase/migrations/20260204000001_reset_trail_progress_v13.sql
File contains BEGIN/COMMIT transaction block
File contains DELETE FROM student_skill_progress
File does NOT contain DELETE FROM students or UPDATE students.total_xp
  </verify>
  <done>Migration file ready for deploy, deletes progress but preserves XP</done>
</task>

<task type="auto">
  <name>Task 2: Update skillTrail.js for cutover</name>
  <files>src/data/skillTrail.js</files>
  <action>
Modify skillTrail.js to complete the cutover:

1. Find the SKILL_NODES export (currently around line 847):
   ```javascript
   // Current:
   export const SKILL_NODES = [
     ...expandedNodes,
     ...LEGACY_NODES
   ];
   ```

2. Change to only spread expandedNodes:
   ```javascript
   // After cutover (v1.3):
   export const SKILL_NODES = [
     ...expandedNodes
   ];
   ```

3. Add deprecation comment above the LEGACY_NODES array (around line 254):
   ```javascript
   /**
    * DEPRECATED: Legacy trail nodes retained for Phase 12 cleanup.
    * DO NOT spread into SKILL_NODES - all nodes now come from expandedNodes.js
    * These 18 nodes were replaced by 87 redesigned nodes in v1.3.
    *
    * @deprecated Phase 12 will delete this array entirely.
    * @see .planning/phases/11-integration-cutover/11-CONTEXT.md
    */
   const LEGACY_NODES = [
   ```

4. Update the comment above SKILL_NODES to reflect cutover:
   ```javascript
   // v1.3: All nodes now come from expandedNodes (redesigned system)
   // LEGACY_NODES retained for reference but NOT included
   export const SKILL_NODES = [
     ...expandedNodes
   ];
   ```

WHY keep LEGACY_NODES in file:
- Phase 12 will handle deletion
- Keeps atomic change small
- Provides reference if rollback needed
  </action>
  <verify>
`grep -n "...LEGACY_NODES" src/data/skillTrail.js` returns NO matches (LEGACY_NODES not spread)
`grep -n "DEPRECATED" src/data/skillTrail.js` returns match (deprecation comment exists)
`grep -n "export const SKILL_NODES" src/data/skillTrail.js` shows only expandedNodes spread
  </verify>
  <done>skillTrail.js exports only expandedNodes, LEGACY_NODES marked deprecated</done>
</task>

</tasks>

<verification>
After both tasks complete:
1. `npm run verify:trail` passes (validates 87 nodes from expandedNodes)
2. `grep "LEGACY_NODES" src/data/skillTrail.js` shows array exists but is NOT spread
3. Migration file exists with correct structure
</verification>

<success_criteria>
- skillTrail.js exports SKILL_NODES with only expandedNodes spread
- LEGACY_NODES array has @deprecated JSDoc comment
- Migration file ready to reset progress while preserving XP
- Both files ready for single atomic commit
</success_criteria>

<output>
After completion, create `.planning/phases/11-integration-cutover/11-01-SUMMARY.md`
</output>
