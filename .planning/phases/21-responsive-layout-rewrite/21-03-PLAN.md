---
phase: 21-responsive-layout-rewrite
plan: 03
type: execute
wave: 3
depends_on: ["21-02"]
files_modified:
  - src/components/trail/TrailMap.jsx
  - src/pages/TrailMapPage.jsx
autonomous: false

must_haves:
  truths:
    - "Mobile (<768px) displays ZigzagTrailLayout, desktop (>=768px) displays HorizontalTrailLayout"
    - "Responsive breakpoint switching works via useMediaQuery or window.matchMedia"
    - "Active node auto-scrolls to center of viewport on page load"
    - "Tab switching between Treble/Bass/Rhythm still works with URL query param persistence"
    - "Node click opens TrailNodeModal (existing functionality preserved)"
    - "Trail scrolling maintains smooth performance (no layout thrashing)"
    - "All 93 nodes display correctly across both layouts"
  artifacts:
    - path: "src/components/trail/TrailMap.jsx"
      provides: "Refactored trail map with responsive layout switching"
      exports: ["default"]
    - path: "src/pages/TrailMapPage.jsx"
      provides: "Updated page wrapper (minimal changes)"
      exports: ["default"]
  key_links:
    - from: "src/components/trail/TrailMap.jsx"
      to: "src/components/trail/ZigzagTrailLayout.jsx"
      via: "Conditional render for mobile breakpoint"
      pattern: "ZigzagTrailLayout"
    - from: "src/components/trail/TrailMap.jsx"
      to: "src/components/trail/HorizontalTrailLayout.jsx"
      via: "Conditional render for desktop breakpoint"
      pattern: "HorizontalTrailLayout"
    - from: "src/components/trail/TrailMap.jsx"
      to: "src/components/trail/TrailNodeModal.jsx"
      via: "selectedNode state opens modal on node click"
      pattern: "TrailNodeModal"
---

<objective>
Refactor TrailMap.jsx to replace the current UnitSection/TrailSection layout with responsive layout switching: ZigzagTrailLayout on mobile, HorizontalTrailLayout on desktop. Add auto-scroll to active node on page load. Preserve all existing functionality (tab switching, node modal, progress display).

Purpose: This is the integration plan that wires everything together. After this, the trail page renders differently on mobile vs desktop while maintaining identical data flow and interaction patterns.

Output: Working responsive trail page with visual verification checkpoint.
</objective>

<execution_context>
@C:/Users/pagis/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/pagis/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/21-responsive-layout-rewrite/21-CONTEXT.md
@.planning/phases/21-responsive-layout-rewrite/21-01-SUMMARY.md
@.planning/phases/21-responsive-layout-rewrite/21-02-SUMMARY.md
@src/components/trail/TrailMap.jsx
@src/pages/TrailMapPage.jsx
@src/data/skillTrail.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Refactor TrailMap.jsx with responsive layout switching and auto-scroll</name>
  <files>src/components/trail/TrailMap.jsx</files>
  <action>
Refactor TrailMap.jsx to replace UnitSection and TrailSection with the new responsive layout components. This is a significant refactor but preserves all data fetching and state management logic.

**Step 1: Add responsive breakpoint detection**

Create an inline `useMediaQuery` hook at the top of the file (or as a small helper within the module â€” no need for a separate file for one hook):

```javascript
function useMediaQuery(query) {
  const [matches, setMatches] = useState(() => {
    if (typeof window !== 'undefined') {
      return window.matchMedia(query).matches;
    }
    return false;
  });

  useEffect(() => {
    const mql = window.matchMedia(query);
    const handler = (e) => setMatches(e.matches);
    mql.addEventListener('change', handler);
    return () => mql.removeEventListener('change', handler);
  }, [query]);

  return matches;
}
```

Use: `const isDesktop = useMediaQuery('(min-width: 768px)');`

**Step 2: Remove UnitSection and TrailSection components**

Delete the `UnitSection` and `TrailSection` component definitions from TrailMap.jsx. Also remove the inline `PathConnector` component (it's now a separate file from Plan 01).

**Step 3: Prepare unit data for layout components**

The current TrailSection already groups nodes by unit via `nodesByUnit` and `units`. Extract this logic into the main TrailMap component so it can be passed to either layout:

```javascript
// Inside TrailMap, for the active tab's nodes:
const activeNodes = activeTab === 'treble' ? trebleWithBoss :
                    activeTab === 'bass' ? bassWithBoss : rhythmWithBoss;
const activeCategory = activeTab === 'treble' ? NODE_CATEGORIES.TREBLE_CLEF :
                       activeTab === 'bass' ? NODE_CATEGORIES.BASS_CLEF :
                       NODE_CATEGORIES.RHYTHM;

// Group nodes by unit (same logic as current TrailSection.nodesByUnit)
const { nodesByUnit, units } = useMemo(() => {
  const grouped = {};
  activeNodes.forEach(node => {
    const unitNum = node.unit || 999;
    if (!grouped[unitNum]) grouped[unitNum] = [];
    grouped[unitNum].push(node);
  });
  // Sort within each unit by orderInUnit
  Object.values(grouped).forEach(arr => arr.sort((a, b) => (a.orderInUnit || 0) - (b.orderInUnit || 0)));

  const unitKeys = Object.keys(grouped).filter(k => k !== '999').map(Number).sort((a, b) => a - b);
  const unitsList = unitKeys.map(unitNum => {
    const unitKey = Object.keys(UNITS).find(key => {
      const unit = UNITS[key];
      return unit.category === activeCategory && unit.order === unitNum;
    });
    return unitKey ? UNITS[unitKey] : { order: unitNum, name: `Unit ${unitNum}`, icon: 'ðŸ“š' };
  });

  return { nodesByUnit: grouped, units: unitsList };
}, [activeNodes, activeCategory]);
```

**Step 4: Add active node ref for auto-scroll**

```javascript
const activeNodeRef = useRef(null);

// Auto-scroll to active node on initial load and tab change
useEffect(() => {
  const timer = setTimeout(() => {
    if (activeNodeRef.current) {
      activeNodeRef.current.scrollIntoView({
        behavior: 'smooth',
        block: 'center',
      });
    }
  }, 400); // Wait for layout to render
  return () => clearTimeout(timer);
}, [activeTab, loading]); // Re-scroll on tab change or when loading completes
```

**Step 5: Replace TrailSection render with responsive layouts**

In the tab panel render section, replace the three `<TrailSection>` blocks with:

```jsx
{/* Active Tab Panel */}
<div id={`${activeTab}-panel`} role="tabpanel" aria-labelledby={`${activeTab}-tab`}>
  {isDesktop ? (
    <HorizontalTrailLayout
      nodes={activeNodes}
      completedNodeIds={completedNodeIds}
      unlockedNodes={unlockedNodes}
      onNodeClick={setSelectedNode}
      getNodeProgress={getNodeProgress}
      activeNodeRef={activeNodeRef}
      units={units}
      nodesByUnit={nodesByUnit}
    />
  ) : (
    <ZigzagTrailLayout
      nodes={activeNodes}
      completedNodeIds={completedNodeIds}
      unlockedNodes={unlockedNodes}
      onNodeClick={setSelectedNode}
      getNodeProgress={getNodeProgress}
      activeNodeRef={activeNodeRef}
      units={units}
      nodesByUnit={nodesByUnit}
    />
  )}
</div>
```

**Step 6: Clean up imports**

- Remove: `ChevronDown`, `ChevronUp` (were for collapsible units), inline `PathConnector`
- Add: `import ZigzagTrailLayout from './ZigzagTrailLayout'`, `import HorizontalTrailLayout from './HorizontalTrailLayout'`
- Keep: All existing imports for data fetching, tabs, modal, etc.

**Step 7: Preserve everything else**

Keep exactly as-is:
- `TRAIL_TABS` configuration
- All `useEffect` for data fetching
- `handleTabChange`, `handleTabKeyDown`, `getPathProgress`
- Tab bar render (the ARIA tablist)
- `TrailNodeModal` render
- "Jump to Top" floating button
- `handleResetProgress` (dev tool)
- Loading state render

**Step 8: Remove the section header** from TrailSection

The current TrailSection renders a section header with icon + title + subtitle. This is no longer needed because the tab bar already identifies which path is active. The layout components render nodes directly. If we want category identification, it's handled by the tab.

Remove: The section header div and the `title`, `subtitle`, `icon` props that were passed to TrailSection.
  </action>
  <verify>
- `npm run build` succeeds
- TrailMap.jsx no longer contains `UnitSection` or `TrailSection` components
- TrailMap.jsx no longer contains inline `PathConnector` component
- `ZigzagTrailLayout` and `HorizontalTrailLayout` are imported
- `useMediaQuery` hook detects 768px breakpoint
- Tab switching still works (Treble/Bass/Rhythm with URL params)
- TrailNodeModal still opens on node click
- `npm run dev` and manually verify:
  - Desktop (>768px): nodes in horizontal rows
  - Mobile (<768px or browser resize): nodes in vertical zigzag
  </verify>
  <done>
TrailMap.jsx refactored to use responsive layout switching. Mobile renders ZigzagTrailLayout, desktop renders HorizontalTrailLayout. Auto-scroll centers active node on load. Tab switching, node modal, and all data flow preserved. UnitSection and TrailSection removed.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 2: Visual verification of responsive trail layouts</name>
  <what-built>
Complete responsive trail layout system:
- Mobile vertical zigzag with alternating left/right nodes, S-curve SVG connectors, and glass unit cards
- Desktop horizontal wavy rows per unit with larger nodes and always-visible labels
- Auto-scroll to current active node on page load
- Tab switching between Treble/Bass/Rhythm preserved
  </what-built>
  <how-to-verify>
1. Start dev server: `npm run dev`
2. Open http://localhost:5174/trail in a browser

**Desktop verification (>=768px):**
- [ ] Nodes display in horizontal wavy rows, grouped by unit
- [ ] 6-8 nodes visible per row without horizontal scrolling
- [ ] Node names visible below each node
- [ ] SVG path connectors show smooth curves between nodes
- [ ] Completed paths have subtle cyan glow, locked paths are dashed gray
- [ ] Glass unit cards appear between unit rows with unit name and completion count
- [ ] Completed unit cards have green border glow
- [ ] Page scrolls vertically (not horizontally)

**Mobile verification (<768px, use browser DevTools responsive mode):**
- [ ] Nodes alternate left/right in vertical zigzag pattern
- [ ] Spacing between nodes is comfortable (~110px)
- [ ] Zigzag feels natural (slight variation, not rigid grid)
- [ ] SVG S-curve paths flow smoothly between zigzag positions
- [ ] Glass unit cards span full width between units
- [ ] Node labels appear below each node

**Interaction verification (both sizes):**
- [ ] Clicking a node opens the TrailNodeModal with correct details
- [ ] Tab switching (Treble/Bass/Rhythm) works and URL updates
- [ ] Active node auto-scrolls to center on page load
- [ ] Locked nodes show prerequisite tooltip on tap
- [ ] "Jump to Top" button works

**Performance check:**
- [ ] Scroll through the full trail smoothly (no visible jank)
- [ ] Resize browser window â€” layout switches between zigzag and horizontal
  </how-to-verify>
  <resume-signal>Type "approved" to confirm trail layouts look correct, or describe any visual issues that need fixing.</resume-signal>
</task>

</tasks>

<verification>
1. `npm run build` â€” zero errors
2. `npm run dev` â€” trail page renders correctly at both breakpoints
3. Tab switching preserves URL query param (?path=treble|bass|rhythm)
4. Node click -> modal -> start practice flow works identically to pre-redesign
5. Auto-scroll centers current active node in viewport
6. All 93 nodes display (verify: treble count + bass count + rhythm count matches)
7. Glass unit cards show correct completion counts
8. Completed path sections glow cyan, locked sections are dashed gray
</verification>

<success_criteria>
Trail page displays responsive layouts: vertical zigzag on mobile, horizontal wavy rows on desktop. All existing functionality (tabs, modal, navigation) preserved. Auto-scroll centers active node. Visual verification confirms the enchanted forest trail looks and feels correct at both breakpoints.
</success_criteria>

<output>
After completion, create `.planning/phases/21-responsive-layout-rewrite/21-03-SUMMARY.md`
</output>
