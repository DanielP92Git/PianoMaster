---
phase: 21-responsive-layout-rewrite
plan: 02
type: execute
wave: 2
depends_on: ["21-01"]
files_modified:
  - src/components/trail/ZigzagTrailLayout.jsx
  - src/components/trail/HorizontalTrailLayout.jsx
autonomous: true

must_haves:
  truths:
    - "Mobile layout displays vertical zigzag with nodes alternating left/right at 20-30%/70-80% horizontal positions"
    - "Vertical spacing between nodes is 100-120px with deterministic variation"
    - "Node labels appear below each node (white, bold, centered)"
    - "SVG path connectors (from Plan 01) flow between zigzag nodes as smooth S-curves"
    - "UnitProgressCards appear after boss nodes as visual chapter breaks"
    - "Desktop layout displays horizontal wavy trail with nodes arranged in rows per unit"
    - "6-8 nodes visible horizontally on desktop without scrolling"
    - "Nodes scale larger on desktop (80px vs 64px mobile)"
    - "Node names always visible on desktop below each node"
  artifacts:
    - path: "src/components/trail/ZigzagTrailLayout.jsx"
      provides: "Mobile vertical zigzag layout for trail nodes"
      exports: ["default"]
    - path: "src/components/trail/HorizontalTrailLayout.jsx"
      provides: "Desktop horizontal wavy layout for trail nodes"
      exports: ["default"]
  key_links:
    - from: "src/components/trail/ZigzagTrailLayout.jsx"
      to: "src/components/trail/PathConnector.jsx"
      via: "SVG path rendering between zigzag nodes"
      pattern: "import PathConnector"
    - from: "src/components/trail/ZigzagTrailLayout.jsx"
      to: "src/components/trail/UnitProgressCard.jsx"
      via: "Glass cards between units"
      pattern: "import UnitProgressCard"
    - from: "src/components/trail/ZigzagTrailLayout.jsx"
      to: "src/components/trail/TrailNode.jsx"
      via: "Rendering individual nodes"
      pattern: "import TrailNode"
    - from: "src/components/trail/HorizontalTrailLayout.jsx"
      to: "src/components/trail/PathConnector.jsx"
      via: "SVG path rendering between horizontal nodes"
      pattern: "import PathConnector"
    - from: "src/components/trail/HorizontalTrailLayout.jsx"
      to: "src/components/trail/UnitProgressCard.jsx"
      via: "Glass cards between unit rows"
      pattern: "import UnitProgressCard"
---

<objective>
Create the two responsive layout components: ZigzagTrailLayout for mobile (<768px) vertical zigzag trail, and HorizontalTrailLayout for desktop (>=768px) horizontal wavy trail. Both consume PathConnector, TrailNode, and UnitProgressCard from Plan 01.

Purpose: These layout components replace the current UnitSection/TrailSection approach in TrailMap.jsx. The zigzag creates a winding forest path feel on mobile, while the horizontal layout provides spacious desktop viewing with nodes arranged in wavy rows per unit.

Output: Two layout components ready for TrailMap integration in Plan 03.
</objective>

<execution_context>
@C:/Users/pagis/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/pagis/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/21-responsive-layout-rewrite/21-CONTEXT.md
@.planning/phases/21-responsive-layout-rewrite/21-RESEARCH.md
@.planning/phases/21-responsive-layout-rewrite/21-01-SUMMARY.md
@src/components/trail/TrailMap.jsx
@src/components/trail/TrailNode.jsx
@src/components/trail/TrailNodeModal.jsx
@src/data/skillTrail.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create ZigzagTrailLayout for mobile vertical zigzag</name>
  <files>src/components/trail/ZigzagTrailLayout.jsx</files>
  <action>
Create the mobile vertical zigzag layout component. This replaces the current collapsible UnitSection approach with a single continuous vertical trail.

**Props:**
- `nodes` — array of node objects for the active tab (already filtered by category, includes boss nodes)
- `completedNodeIds` — array of completed node IDs
- `unlockedNodes` — Set of unlocked node IDs
- `onNodeClick` — callback when node is clicked (opens modal)
- `getNodeProgress` — function(nodeId) returning progress data
- `activeNodeRef` — ref to attach to the current/active node (for auto-scroll in Plan 03)
- `units` — array of unit metadata objects (from UNITS in skillTrail.js, sorted by order)
- `nodesByUnit` — object mapping unit order number to array of nodes in that unit

**Layout algorithm:**

1. **Flatten nodes by unit order** into a single continuous list, inserting unit card markers after each unit's boss node. Build a `layoutItems` array where each item is either `{ type: 'node', node, unitOrder }` or `{ type: 'unitCard', unit, nodes: unitNodes }`.

2. **Calculate zigzag positions** using `useMemo`:
   - Start Y at 60px (space for first node)
   - For each node item, increment Y by 110px (moderate spacing per user decision "100-120px")
   - Horizontal position alternates left/right with deterministic variation:
     ```javascript
     const isLeft = nodeIndex % 2 === 0;
     const basePercent = isLeft ? 25 : 75;
     const variation = Math.sin(nodeIndex * 1.7) * 5; // Deterministic +-5% variation
     const xPercent = basePercent + variation; // Results in ~20-30% / 70-80% range
     ```
   - For unit card items, position at center (50%) with Y incremented by 80px (card height + spacing)
   - Store positions as `{ item, xPercent, y }` array

3. **Determine current/active node**: Find the first node that is unlocked but not completed. If all completed, use the last completed node.

4. **Render structure:**
   ```jsx
   <div className="relative w-full" style={{ height: `${totalHeight}px` }}>
     {/* SVG layer for path connectors */}
     <svg className="absolute inset-0 w-full h-full pointer-events-none" style={{ overflow: 'visible' }}>
       {/* Render PathConnector between consecutive node items (skip unit cards) */}
     </svg>

     {/* Node and card layer */}
     {positions.map((pos) => {
       if (pos.item.type === 'unitCard') {
         return <UnitProgressCard ... positioned absolutely at pos.y />;
       }
       return <TrailNode ... positioned absolutely at pos.xPercent, pos.y />;
     })}
   </div>
   ```

5. **Node positioning**: Each node is wrapped in a `<div>` with:
   - `position: absolute`, `left: ${xPercent}%`, `top: ${y}px`, `transform: translate(-50%, -50%)`
   - Width constraint for node + label: `w-20` (80px to fit node + name below)

6. **Node labels**: Below each node, show node name in `text-[10px] font-semibold text-white text-center leading-tight max-w-[80px]`. Use `translateNodeName` for i18n. On mobile, names are always visible (this is fine — they're small enough).

7. **SVG path coordinates**: PathConnector needs pixel coordinates. For the SVG, convert xPercent to actual pixel position. Since the parent container is `w-full`, use a `containerRef` and measure width with `useEffect` + `ResizeObserver`. Convert: `xPixel = (xPercent / 100) * containerWidth`. Pass pixel coordinates to PathConnector.

8. **Path connector logic**: Only draw paths between consecutive NODE items (not between a node and a unit card). When a unit card sits between two nodes, draw the path from the node above the card to the node below it — the path will pass behind the card, which sits at a higher z-index.

9. **Attach `activeNodeRef`** to the div wrapping the current/active node (for scroll-into-view in Plan 03).

**Important details:**
- Do NOT use `Math.random()` — use `Math.sin(index * 1.7) * 5` for deterministic variation
- Node size on mobile: use existing TrailNode sizing (the component handles its own size via `sizeClass`)
- Import `useTranslation` for the 'trail' namespace
- Import `translateNodeName` from `../../utils/translateNodeName`
- Use ResizeObserver (not window resize event) for container width measurement
  </action>
  <verify>
- `npm run build` succeeds
- ZigzagTrailLayout.jsx exports a default component
- No `Math.random()` in the file (deterministic layout)
- PathConnector imported and rendered between consecutive nodes
- UnitProgressCard imported and rendered at unit boundaries
- Horizontal positions stay within 20-80% range
- Vertical spacing is ~110px between nodes
  </verify>
  <done>
ZigzagTrailLayout renders a continuous vertical trail with nodes alternating left/right (20-30%/70-80%) connected by S-curve SVG paths. Unit progress cards appear as glass chapter breaks after boss nodes. Layout is deterministic across reloads. Node labels visible below each node.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create HorizontalTrailLayout for desktop wavy trail</name>
  <files>src/components/trail/HorizontalTrailLayout.jsx</files>
  <action>
Create the desktop horizontal layout. Per research recommendation (and Claude's discretion), use **vertical scroll with horizontal wavy layout per unit** — NOT horizontal scroll. Each unit is a horizontal row of nodes with wavy vertical offset, separated by full-width UnitProgressCards.

**Props:** Same as ZigzagTrailLayout (nodes, completedNodeIds, unlockedNodes, onNodeClick, getNodeProgress, activeNodeRef, units, nodesByUnit).

**Layout structure:**

```
[Unit 1 Header Card]
  node1 ── node2 ── node3 ── node4 ── node5 ── boss_node
           (wavy vertical offset within row)
[Unit 1 Summary Card]

[Unit 2 Header Card]
  node1 ── node2 ── node3 ── ...
[Unit 2 Summary Card]
```

Wait — per user decision, cards appear AFTER the boss node ("boss is the gate, card is the unit summary"). So the structure is:

```
Unit 1 nodes in horizontal wavy row (including boss at end)
[Unit 1 Glass Summary Card]
Unit 2 nodes in horizontal wavy row (including boss at end)
[Unit 2 Glass Summary Card]
...
```

**Implementation:**

1. **Per-unit rendering**: Iterate over `units` array. For each unit, get its nodes from `nodesByUnit[unit.order]`. Render:
   - A `<div>` containing the horizontal node row + SVG paths
   - A `<UnitProgressCard>` below each row

2. **Horizontal node positioning** within each unit row:
   - Container: `max-w-5xl mx-auto px-8` (centered, ~1024px, leaves room for 6-8 nodes)
   - Use `relative` container with fixed height (~200px to accommodate wave + labels)
   - Nodes spaced evenly: `xPixel = padding + index * (availableWidth / (numNodes - 1))`
   - Wavy vertical offset: `yOffset = Math.sin(index * 0.8) * 20` (gentle wave amplitude +-20px)
   - Center Y at ~90px within the 200px container
   - Each node positioned absolutely

3. **Node size on desktop**: Add a `desktopSize` prop or className override. TrailNode's `sizeClass` comes from `getNodeStateConfig`. For desktop, wrap the TrailNode in a container with `scale-110` or explicitly set `w-20 h-20` (80px). Research recommended 64px mobile / 80px desktop = 1.25x.

   Actually, since TrailNode uses `sizeClass` from nodeTypeStyles, the simplest approach: wrap each TrailNode in a `<div className="transform scale-110 origin-center">` to scale up 1.1x on desktop. This avoids modifying TrailNode internals.

4. **Node labels always visible on desktop**: Below each node, render the node name in `text-xs font-semibold text-white text-center max-w-[90px] mt-1`. This is always visible on desktop per user decision ("node names always visible on desktop").

5. **SVG paths within each unit row**: Render an `<svg>` overlay within each unit's container. Draw PathConnector between consecutive nodes in the row. The paths follow the wavy positions.

6. **SVG path coordinate calculation**: Same ResizeObserver pattern as ZigzagTrailLayout to measure container width for pixel positions.

7. **UnitProgressCard placement**: After each unit row, render `<UnitProgressCard>` with `max-w-5xl mx-auto my-4` — full container width, acts as visual separator.

8. **Active node ref**: Attach `activeNodeRef` to the current/active node wrapper, same logic as zigzag.

**Important details:**
- Vertical scroll, NOT horizontal scroll (research: "Duolingo abandoned horizontal scroll")
- Use `Math.sin(index * 0.8) * 20` for wave offset (deterministic)
- Import PathConnector, UnitProgressCard, TrailNode, translateNodeName
- Use `useTranslation` for i18n
- Each unit row is self-contained (no cross-unit path connectors)
  </action>
  <verify>
- `npm run build` succeeds
- HorizontalTrailLayout.jsx exports a default component
- Nodes arranged horizontally within each unit row
- Wavy vertical offset uses `Math.sin` (deterministic)
- UnitProgressCards appear between unit rows
- Node names always rendered (not hidden behind hover/tap)
- No horizontal scrollbar on the page
- PathConnector rendered between consecutive nodes within each unit
  </verify>
  <done>
HorizontalTrailLayout renders a spacious desktop trail with nodes in horizontal wavy rows per unit, separated by glass UnitProgressCards. Nodes scale larger (1.1x), names always visible. Vertical scroll with no horizontal overflow. Each unit self-contained with its own SVG path connectors.
  </done>
</task>

</tasks>

<verification>
1. `npm run build` — zero new errors
2. Both layout files exist and export default components:
   - `src/components/trail/ZigzagTrailLayout.jsx`
   - `src/components/trail/HorizontalTrailLayout.jsx`
3. Both import PathConnector, UnitProgressCard, and TrailNode
4. ZigzagTrailLayout uses ~110px vertical spacing and 20-30%/70-80% horizontal positions
5. HorizontalTrailLayout uses wavy offset within horizontal rows
6. Neither component uses `Math.random()`
7. Both components accept and forward `activeNodeRef` prop
</verification>

<success_criteria>
Two responsive layout components are built and build-verified. ZigzagTrailLayout produces a mobile vertical zigzag trail with alternating left/right positioning and S-curve path connectors. HorizontalTrailLayout produces a desktop vertical-scroll layout with horizontal wavy node rows per unit. Both use UnitProgressCards as chapter breaks between units. Both ready for TrailMap integration in Plan 03.
</success_criteria>

<output>
After completion, create `.planning/phases/21-responsive-layout-rewrite/21-02-SUMMARY.md`
</output>
