---
phase: 21-responsive-layout-rewrite
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/components/trail/PathConnector.jsx
  - src/components/trail/UnitProgressCard.jsx
  - src/hooks/useVisibleNodes.js
  - src/styles/trail-effects.css
autonomous: true

must_haves:
  truths:
    - "SVG path connectors render smooth S-curves between nodes using cubic Bezier calculations"
    - "Completed path sections display subtle cyan glow (2-4px blur), locked sections use dashed gray stroke"
    - "Path connector glow effects only apply when element is visible in viewport (Intersection Observer)"
    - "Unit progress cards display as frosted glass panels with unit name, icon, and completion count"
    - "Glass panels meet WCAG 4.5:1 contrast with semi-opaque overlay"
    - "Completed unit cards show subtle cyan/green border glow"
  artifacts:
    - path: "src/components/trail/PathConnector.jsx"
      provides: "SVG S-curve path connector with viewport-optimized glow"
      exports: ["default"]
    - path: "src/components/trail/UnitProgressCard.jsx"
      provides: "Glass-morphism unit summary card"
      exports: ["default"]
    - path: "src/hooks/useVisibleNodes.js"
      provides: "Intersection Observer hook for viewport visibility tracking"
      exports: ["useVisibleNodes"]
    - path: "src/styles/trail-effects.css"
      provides: "Updated CSS with path glow and glass card styles"
      contains: "path-connector-glow"
  key_links:
    - from: "src/components/trail/PathConnector.jsx"
      to: "src/hooks/useVisibleNodes.js"
      via: "useVisibleNodes hook for viewport detection"
      pattern: "useVisibleNodes"
    - from: "src/components/trail/PathConnector.jsx"
      to: "src/styles/trail-effects.css"
      via: "CSS classes for path glow styling"
      pattern: "path-connector"
    - from: "src/components/trail/UnitProgressCard.jsx"
      to: "src/styles/trail-effects.css"
      via: "trail-glass-panel CSS class"
      pattern: "trail-glass-panel"
---

<objective>
Create the three shared primitive components that both mobile and desktop layouts will consume: a rewritten SVG PathConnector with smooth Bezier S-curves, an Intersection Observer hook for viewport-based rendering optimization, and a glass-morphism UnitProgressCard component.

Purpose: These are the foundational building blocks. PathConnector and UnitProgressCard will be imported by both ZigzagTrailLayout (mobile) and HorizontalTrailLayout (desktop) in Plan 02. Building them first ensures consistent visuals across breakpoints.

Output: 3 new/rewritten components + updated CSS ready for layout integration.
</objective>

<execution_context>
@C:/Users/pagis/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/pagis/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/21-responsive-layout-rewrite/21-CONTEXT.md
@.planning/phases/21-responsive-layout-rewrite/21-RESEARCH.md
@src/components/trail/TrailMap.jsx
@src/components/trail/TrailNode.jsx
@src/styles/trail-effects.css
@src/data/skillTrail.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create useVisibleNodes hook and rewrite PathConnector with S-curve Bezier logic</name>
  <files>src/hooks/useVisibleNodes.js, src/components/trail/PathConnector.jsx</files>
  <action>
**useVisibleNodes hook** (`src/hooks/useVisibleNodes.js`):
Create a custom hook that uses Intersection Observer to track which elements are visible in the viewport. The hook should:
- Accept a single ref (not an array) and return a boolean `isVisible`
- Use `rootMargin: '50px'` to start detecting 50px before element enters viewport
- Use `threshold: 0.1` (10% visibility triggers)
- Clean up observer on unmount
- Export as named export `useVisibleNodes`

Simple API: `const isVisible = useVisibleNodes(elementRef);`

**PathConnector component** (`src/components/trail/PathConnector.jsx`):
Create as a standalone component file (currently inline in TrailMap.jsx). The component receives coordinates and renders an SVG `<g>` element containing the path. Props:
- `startX`, `startY`, `endX`, `endY` (pixel coordinates, NOT percentages)
- `isCompleted` (boolean - determines glow vs dashed)
- `isLocked` (boolean - determines if section is locked/upcoming)

Implementation details:
1. **S-curve Bezier calculation**: For the path `d` attribute, use cubic Bezier `C` command:
   - Detect whether connection is primarily vertical (zigzag mobile) or horizontal (desktop)
   - For vertical connections (dy > dx): control points offset horizontally at 40% distance
     ```
     cp1x = startX, cp1y = startY + dy * 0.4
     cp2x = endX, cp2y = endY - dy * 0.4
     ```
   - For horizontal connections (dx > dy): control points offset vertically
     ```
     cp1x = startX + dx * 0.4, cp1y = startY
     cp2x = endX - dx * 0.4, cp2y = endY
     ```
   - This produces gentle flowing curves per user decision ("winding river, not sharp zigzag")

2. **Viewport-optimized glow**: Use `useVisibleNodes` hook with a ref on the `<g>` element:
   - When visible AND completed: render a background glow `<path>` with `stroke: rgba(0, 242, 255, 0.3)`, `strokeWidth: 8`, CSS `filter: blur(3px)` (2-4px per user decision, "forest-firefly feel, not neon")
   - When visible AND completed: main path with `stroke: #00FFFF`, `strokeWidth: 2` (thin per user decision "2-3px")
   - When NOT completed (locked/upcoming): `stroke: rgba(255, 255, 255, 0.15)`, `strokeWidth: 2`, `strokeDasharray: "12 8"` (dashed gray per user decision)
   - When NOT visible: render path without glow filter (static stroke only, no filter computation)

3. **Performance**: Do NOT add `will-change` to all paths. Only apply CSS `filter` when `isVisible && isCompleted`. Use `strokeLinecap="round"` for smooth ends.

Do NOT use `useMemo` for the path calculation — it's a simple string concatenation that doesn't benefit from memoization overhead.
  </action>
  <verify>
- `npm run build` succeeds with no errors
- PathConnector.jsx exports a default React component
- useVisibleNodes.js exports a named `useVisibleNodes` function
- No `window.innerWidth` usage in PathConnector (all pixel coordinates from parent)
- Glow path only renders when `isVisible && isCompleted`
  </verify>
  <done>
PathConnector renders smooth S-curve SVG paths between any two coordinate pairs. Completed sections show subtle cyan glow (only when in viewport). Locked sections show dashed gray lines. useVisibleNodes hook provides boolean viewport detection via Intersection Observer.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create UnitProgressCard glass-morphism component</name>
  <files>src/components/trail/UnitProgressCard.jsx, src/styles/trail-effects.css</files>
  <action>
**UnitProgressCard component** (`src/components/trail/UnitProgressCard.jsx`):
A purely informational (no click/tap interactivity per user decision) glass-morphism card that acts as a chapter break between trail units. Props:
- `unit` — unit metadata object from UNITS in skillTrail.js (has `name`, `icon`, `description`, `theme`)
- `completedCount` — number of completed nodes in this unit
- `totalCount` — total nodes in the unit
- `totalStars` — total stars earned across unit nodes
- `maxStars` — maximum possible stars (totalCount * 3)
- `isUnitComplete` — boolean, all nodes in unit completed

Structure (all within a single `<div>` with `relative w-full rounded-2xl overflow-hidden`):

1. **Glass background layer**: `<div>` with `absolute inset-0`, inline styles for `backdropFilter: 'blur(10px)'` and `WebkitBackdropFilter: 'blur(10px)'`, background: `linear-gradient(135deg, rgba(255,255,255,0.12) 0%, rgba(255,255,255,0.04) 100%)`. Use 10px blur (within user's 8-12px range).

2. **Semi-opaque contrast overlay**: `<div className="absolute inset-0 bg-slate-900/40" />` — ensures WCAG 4.5:1 contrast for white text on any background.

3. **Content layer** (`relative z-10 px-4 py-3`):
   - Left side: unit icon (from `unit.icon`, rendered as text emoji `text-2xl`) + unit name (`text-white font-bold text-sm drop-shadow-md font-quicksand`) + completion text (`text-white/80 text-xs`, e.g., "4/6 complete")
   - Right side: star display showing `totalStars`/`maxStars` with a small star icon
   - Use `flex items-center justify-between` layout
   - Use `useTranslation` hook with 'trail' namespace for translatable unit names (use `translateUnitName` from `src/utils/translateNodeName.js`)

4. **Completed unit border glow** (conditional): When `isUnitComplete`, add a `<div>` with `absolute inset-0 rounded-2xl pointer-events-none` and inline style: `border: '1.5px solid rgba(74, 222, 128, 0.5)'`, `boxShadow: '0 0 10px rgba(74, 222, 128, 0.3), inset 0 0 6px rgba(74, 222, 128, 0.15)'` — subtle cyan/green per user decision.

**trail-effects.css updates** — Add to Section 5 (Glass Panel) area:

```css
/* Unit progress card - backdrop fallback */
@supports not (backdrop-filter: blur(10px)) {
  .trail-unit-card-fallback {
    background: rgba(30, 20, 60, 0.92);
  }
}

/* Path connector glow classes */
.path-connector-glow {
  filter: drop-shadow(0 0 3px rgba(0, 242, 255, 0.4));
}
```

Add the `.trail-unit-card-fallback` class to the glass background div as an additional class, so the `@supports` fallback applies.

Important: Do NOT add `backdrop-filter` to trail-effects.css for the unit card — it's inline in the component to allow conditional rendering. The CSS only provides the fallback.
  </action>
  <verify>
- `npm run build` succeeds
- UnitProgressCard.jsx exports a default component
- Component renders unit name, icon, completion count, and star count
- Semi-opaque overlay (`bg-slate-900/40`) is present for WCAG contrast
- Completed unit glow only renders when `isUnitComplete` is true
- No onClick/onTap handlers on the card (purely informational)
- trail-effects.css has `@supports not` fallback for backdrop-filter
  </verify>
  <done>
UnitProgressCard renders as a frosted glass panel showing unit name, theme icon, completion count, and star progress. Completed units display a subtle green border glow. Text meets WCAG 4.5:1 contrast via semi-opaque overlay. Fallback styles exist for browsers without backdrop-filter support.
  </done>
</task>

</tasks>

<verification>
1. `npm run build` — zero new errors
2. All three files exist and export correctly:
   - `src/hooks/useVisibleNodes.js` — named export `useVisibleNodes`
   - `src/components/trail/PathConnector.jsx` — default export
   - `src/components/trail/UnitProgressCard.jsx` — default export
3. PathConnector uses cubic Bezier `C` command (not straight lines or quadratic `Q`)
4. PathConnector glow is conditional on `isVisible && isCompleted`
5. UnitProgressCard has `bg-slate-900/40` overlay for contrast
6. trail-effects.css has backdrop-filter fallback
7. No `window.innerWidth` or `Math.random()` in any new file
</verification>

<success_criteria>
Three shared primitive components are built and build-verified. PathConnector renders smooth S-curve Bezier paths with viewport-optimized cyan glow for completed sections and dashed gray for locked sections. UnitProgressCard renders as a WCAG-compliant glass panel with unit metadata. useVisibleNodes provides Intersection Observer boolean detection. All ready for layout component consumption in Plan 02.
</success_criteria>

<output>
After completion, create `.planning/phases/21-responsive-layout-rewrite/21-01-SUMMARY.md`
</output>
