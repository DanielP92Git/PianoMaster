---
phase: 18-code-cleanup
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - vite.config.js
  - package.json
  - package-lock.json
  - src/utils/progressMigration.js
  - src/assets/trail-assets/
  - .planning/phases/14-node-type-visual-distinction/REMAINING_ISSUES.md
autonomous: true

must_haves:
  truths:
    - "progressMigration.js no longer exists in the codebase"
    - "Unused trail-assets images are removed (not committed to git)"
    - "Stale planning artifact REMAINING_ISSUES.md is removed"
    - "rollup-plugin-visualizer is installed as permanent dev dependency"
    - "Baseline bundle size is captured before any cleanup"
    - "Automated audit has identified all dead code candidates"
  artifacts:
    - path: "vite.config.js"
      provides: "Bundle visualizer configuration"
      contains: "visualizer"
    - path: "dist/bundle-stats.html"
      provides: "Interactive bundle treemap"
  key_links:
    - from: "vite.config.js"
      to: "rollup-plugin-visualizer"
      via: "plugin import and configuration"
      pattern: "import.*visualizer.*rollup-plugin-visualizer"
---

<objective>
Install bundle analysis tooling, capture baseline metrics, remove known dead code, and run automated audits to discover all remaining dead code candidates.

Purpose: Establish tooling infrastructure for ongoing bundle health monitoring, remove confirmed orphaned code with atomic commits, and generate a comprehensive candidate list for Plan 02's cleanup sweep.

Output: rollup-plugin-visualizer permanently added, progressMigration.js and other known dead code removed, audit results documented for Plan 02.
</objective>

<execution_context>
@C:\Users\pagis\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\pagis\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/18-code-cleanup/18-CONTEXT.md
@.planning/phases/18-code-cleanup/18-RESEARCH.md
@vite.config.js
@package.json
@src/utils/progressMigration.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install rollup-plugin-visualizer and capture baseline bundle metrics</name>
  <files>vite.config.js, package.json, package-lock.json</files>
  <action>
    1. Install rollup-plugin-visualizer as a permanent dev dependency:
       ```
       npm install -D rollup-plugin-visualizer
       ```

    2. Update vite.config.js to add the visualizer plugin as the LAST plugin:
       - Import: `import { visualizer } from 'rollup-plugin-visualizer';`
       - Add to plugins array (after svgr):
         ```javascript
         visualizer({
           filename: 'dist/bundle-stats.html',
           open: false,
           gzipSize: true,
           brotliSize: true,
           template: 'treemap',
           title: 'PianoApp2 Bundle Analysis'
         })
         ```
       - The visualizer should only run during build (it's a Rollup plugin, not active in dev).

    3. Add `dist/bundle-stats.html` to .gitignore if not already ignored (dist/ is likely already ignored).

    4. Run a baseline production build to capture before-cleanup metrics:
       ```
       npm run build
       ```
    5. Record the baseline bundle size output (total JS size from Vite build output). Save this to a temporary file `.planning/phases/18-code-cleanup/BASELINE_METRICS.txt` with the exact build output.

    6. Commit the tooling additions:
       ```
       git add vite.config.js package.json package-lock.json
       git commit -m "chore(18): add rollup-plugin-visualizer for permanent bundle analysis"
       ```
  </action>
  <verify>
    - `npm run build` succeeds without errors
    - `dist/bundle-stats.html` file is generated after build
    - vite.config.js imports and configures visualizer plugin
    - BASELINE_METRICS.txt contains build size output
  </verify>
  <done>rollup-plugin-visualizer installed as devDependency, configured in vite.config.js, baseline build metrics captured</done>
</task>

<task type="auto">
  <name>Task 2: Remove known dead code with atomic commits</name>
  <files>src/utils/progressMigration.js, src/assets/trail-assets/, .planning/phases/14-node-type-visual-distinction/REMAINING_ISSUES.md</files>
  <action>
    Remove three known dead artifacts with one atomic commit per logical unit. For each removal, verify safety first.

    **Removal 1: progressMigration.js (confirmed orphaned, 241 lines)**

    1. Double-check no imports exist:
       ```
       grep -rn "progressMigration" src/ --include="*.js" --include="*.jsx"
       ```
       Expected: zero results (only .planning/ docs reference it).

    2. Remove the file:
       ```
       git rm src/utils/progressMigration.js
       ```

    3. Run tests to verify no breakage:
       ```
       npm run test:run
       ```

    4. Commit:
       ```
       git commit -m "chore(18): remove orphaned progressMigration.js (241 lines)

       Migration utility no longer imported after Phase 12 removed legacy
       trail migration logic. All users migrated during v1.3 restructuring.

       Evidence: grep confirms zero imports in src/ directory.
       Impact: 241 lines removed, no test coverage to update."
       ```

    **Removal 2: Unused trail-assets images**

    The `src/assets/trail-assets/` directory contains 4 images (bass-node-webp.webp, treble-node-webp.webp, and 2 Gemini-generated PNGs) that are NOT referenced anywhere in src/. These are untracked design exploration artifacts from Phase 14.

    1. Verify no references:
       ```
       grep -rn "trail-assets\|bass-node-webp\|treble-node-webp\|uwcimcuwcimcuwci\|wbtif2wbtif2wbti" src/ --include="*.js" --include="*.jsx" --include="*.css"
       ```
       Expected: zero results.

    2. Delete the directory entirely:
       ```
       rm -rf src/assets/trail-assets/
       ```
       These files are untracked, so no git rm needed. They will simply disappear from `git status`.

    **Removal 3: Stale REMAINING_ISSUES.md planning artifact**

    `.planning/phases/14-node-type-visual-distinction/REMAINING_ISSUES.md` is a leftover checkpoint tracking file from Phase 14. Phase 14 completed successfully on 2026-02-08. This file serves no further purpose.

    1. Remove and commit:
       ```
       git rm .planning/phases/14-node-type-visual-distinction/REMAINING_ISSUES.md
       git commit -m "chore(18): remove stale Phase 14 checkpoint tracking file

       REMAINING_ISSUES.md was a checkpoint resume artifact from Phase 14.
       Phase 14 completed successfully on 2026-02-08."
       ```
  </action>
  <verify>
    - `src/utils/progressMigration.js` no longer exists
    - `src/assets/trail-assets/` directory no longer exists
    - `.planning/phases/14-node-type-visual-distinction/REMAINING_ISSUES.md` no longer exists
    - `npm run test:run` passes
    - `npm run build` succeeds
    - git log shows atomic commits for each removal
  </verify>
  <done>All 3 known dead artifacts removed with atomic commits, tests pass, build succeeds</done>
</task>

<task type="auto">
  <name>Task 3: Run automated dead code audits and document findings</name>
  <files>.planning/phases/18-code-cleanup/AUDIT_RESULTS.md</files>
  <action>
    Run three automated analysis tools and compile findings for Plan 02.

    **Audit 1: Knip - Dead files and unused exports**

    1. Run Knip without installing (npx):
       ```
       npx knip --entry src/main.jsx --include files,exports,dependencies
       ```
       If Knip needs configuration, create a temporary knip.json:
       ```json
       {
         "entry": ["src/main.jsx", "index.html"],
         "project": ["src/**/*.{js,jsx}"],
         "ignore": ["**/*.test.js", "**/*.test.jsx", "scripts/**"],
         "ignoreDependencies": ["@fontsource/*", "vite-plugin-*"]
       }
       ```

    2. Capture Knip output. For each finding, note:
       - File path or export name
       - Category (unused file / unused export / unused dependency)

    **Audit 2: depcheck - Unused npm dependencies**

    1. Run depcheck:
       ```
       npx depcheck --ignores="@fontsource/*,vite-plugin-svgr,@vitejs/plugin-react,eslint*,prettier*,husky,lint-staged,postcss,autoprefixer,tailwindcss,vitest,jsdom,@testing-library/*,globals,vite,vite-plugin-static-copy,rollup-plugin-visualizer"
       ```
       The ignores list covers devDependencies and tools that are used via config files rather than direct imports.

    2. Capture output. Note any production dependencies flagged as unused.

    **Audit 3: Translation key audit**

    1. Grep for all translation keys used in code. Compare with keys in en/common.json and en/trail.json:
       - Extract all `t('...')` and `t("...")` calls from src/:
         ```
         grep -rhoP "t\(['\"]([^'\"]+)['\"]\)" src/ --include="*.js" --include="*.jsx" | sort -u
         ```
       - Compare against keys in locale JSON files.
       - Note any keys present in JSON but never referenced in code.

    2. Be careful of dynamically constructed keys (template literals in t() calls). Search for these patterns:
       ```
       grep -rn "t(\`" src/ --include="*.js" --include="*.jsx"
       ```
       Keys matching dynamic patterns should NOT be flagged for removal.

    **Compile results:**

    Write findings to `.planning/phases/18-code-cleanup/AUDIT_RESULTS.md` with structure:
    ```markdown
    # Audit Results

    ## Dead Files
    - [list from Knip]

    ## Unused Exports
    - [list from Knip]

    ## Unused Dependencies
    - [list from depcheck]

    ## Unused Translation Keys
    - [list from comparison]

    ## False Positive Notes
    - [any dynamic imports, template literal keys, etc. that should NOT be removed]
    ```

    Do NOT commit the audit results file to git (it's a working document for Plan 02).
  </action>
  <verify>
    - Knip ran successfully and produced output
    - depcheck ran successfully and produced output
    - Translation key comparison completed
    - AUDIT_RESULTS.md exists with categorized findings
    - False positives identified and documented
  </verify>
  <done>Comprehensive dead code audit complete, findings documented in AUDIT_RESULTS.md for Plan 02 consumption</done>
</task>

</tasks>

<verification>
- rollup-plugin-visualizer installed and generating bundle-stats.html on build
- progressMigration.js deleted, zero imports confirmed
- trail-assets/ deleted, zero references confirmed
- REMAINING_ISSUES.md deleted
- All tests pass after removals
- Build succeeds after removals
- AUDIT_RESULTS.md contains categorized findings from 3 tools
- BASELINE_METRICS.txt contains pre-cleanup bundle sizes
</verification>

<success_criteria>
1. Bundle analysis tooling permanently installed and configured
2. All known dead code removed with atomic commits
3. Automated audit results documented for Plan 02
4. Zero test failures, zero build failures after changes
</success_criteria>

<output>
After completion, create `.planning/phases/18-code-cleanup/18-01-SUMMARY.md`
</output>
