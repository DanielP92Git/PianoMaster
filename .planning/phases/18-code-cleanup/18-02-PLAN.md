---
phase: 18-code-cleanup
plan: 02
type: execute
wave: 2
depends_on: ["18-01"]
files_modified:
  - package.json
  - package-lock.json
  - public/sw.js
  - src/locales/en/common.json
  - src/locales/he/common.json
  - src/locales/en/trail.json
  - src/locales/he/trail.json
autonomous: true

must_haves:
  truths:
    - "No dead code remains from previous milestones (validated via automated tools)"
    - "Bundle size analysis shows no unused production dependencies"
    - "Service worker has no redundant code or dead stubs"
    - "Translation files contain no orphaned keys"
    - "All tests pass, build succeeds, lint is clean"
    - "Before/after bundle size comparison documented"
  artifacts:
    - path: "public/sw.js"
      provides: "Cleaned service worker without duplicate guards"
    - path: "package.json"
      provides: "Clean dependency list with no unused production packages"
  key_links:
    - from: "public/sw.js"
      to: "fetch event handler"
      via: "single JS exclusion block (no duplicate)"
      pattern: "endsWith.*\\.js"
---

<objective>
Remove all dead code discovered by Plan 01's automated audits, clean up the service worker, and produce final before/after bundle comparison metrics.

Purpose: Complete the codebase cleanup by addressing every dead code candidate from the audit, optimizing the service worker, and validating the final state with comprehensive checks.

Output: Clean codebase with no dead code, optimized service worker, documented bundle size delta.
</objective>

<execution_context>
@C:\Users\pagis\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\pagis\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/18-code-cleanup/18-CONTEXT.md
@.planning/phases/18-code-cleanup/18-RESEARCH.md
@.planning/phases/18-code-cleanup/18-01-SUMMARY.md
@.planning/phases/18-code-cleanup/AUDIT_RESULTS.md
@.planning/phases/18-code-cleanup/BASELINE_METRICS.txt
@public/sw.js
@package.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Remove discovered dead code from audit results</name>
  <files>Varies based on AUDIT_RESULTS.md findings</files>
  <action>
    Read `.planning/phases/18-code-cleanup/AUDIT_RESULTS.md` from Plan 01 and process each category of findings.

    **For each unused production dependency found by depcheck/knip:**

    1. Verify the dependency is truly unused:
       - Search for import/require statements in src/
       - Check if used in config files (vite.config.js, tailwind.config.js, postcss.config.js, etc.)
       - Check if it's a peer dependency of another installed package
    2. If confirmed unused, uninstall:
       ```
       npm uninstall <package-name>
       ```
    3. Run `npm run test:run && npm run build` after each removal
    4. Atomic commit per dependency:
       ```
       git commit -m "chore(18): remove unused dependency <package-name>

       Detected by depcheck/knip. No imports found in codebase.
       Verified not required as peer dependency."
       ```

    **For each unused export found by knip:**

    1. Verify the export is truly unused:
       - Search for the function/variable name across all src/ files
       - Check for dynamic references (string-based access, destructuring patterns)
    2. If confirmed unused, remove the export. If removing the export leaves the function unused entirely, remove the function.
    3. If the file becomes empty after removing unused exports, delete the file.
    4. Group related unused exports by file for a single commit per file:
       ```
       git commit -m "chore(18): remove unused exports from <filename>

       Removed: <list of exports>
       Detected by knip, verified with grep."
       ```

    **For unused translation keys:**

    1. Read AUDIT_RESULTS.md for the list of unused keys (respecting the false positive notes about dynamic keys).
    2. Remove unused keys from BOTH en/ and he/ locale files.
    3. Ensure Hebrew and English files stay in sync (same key structure).
    4. Commit all translation key removals together:
       ```
       git commit -m "chore(18): remove unused translation keys

       Removed N keys from en/common.json, en/trail.json, he/common.json, he/trail.json.
       Detected via static analysis of t() calls vs locale file keys.
       Dynamic keys preserved (template literal patterns verified)."
       ```

    **Important safety rules:**
    - NEVER remove something flagged by tools without manual grep verification
    - Skip anything in the "False Positive Notes" section of AUDIT_RESULTS.md
    - If uncertain about a candidate, SKIP it (conservative approach)
    - Run tests after each logical removal group
    - If no candidates are found in a category, document "No candidates found" and move on
  </action>
  <verify>
    - `npm run test:run` passes after all removals
    - `npm run build` succeeds after all removals
    - `npm run lint` passes (or only pre-existing warnings remain)
    - Each removal has its own atomic commit
    - No false positives were removed
  </verify>
  <done>All audit-discovered dead code removed with atomic commits, verified by tests and build</done>
</task>

<task type="auto">
  <name>Task 2: Service worker cleanup and final validation with bundle comparison</name>
  <files>public/sw.js</files>
  <action>
    **Part A: Service worker cleanup**

    The service worker (`public/sw.js`) has two issues to address:

    1. **Duplicate JavaScript file exclusion (lines ~164-176 and ~193-200):**
       The fetch handler has TWO blocks that check for JS files:
       - First block (lines 164-176): Checks `.jsx`, `.tsx`, `.ts`, `.js` extensions AND `destination === "script"` AND `destination === "module"`
       - Second block (lines 193-200): Checks `destination === "script"` AND `destination === "module"` AND `.js` AND `.mjs`

       The second block is UNREACHABLE because the first block already returns for all these cases.

       **Action:** Remove the second duplicate block (lines 193-200 area with the comment "Never intercept JavaScript or module requests"). Keep the first block intact since it handles all JS exclusion correctly.

    2. **Stub syncPracticeSessions function (lines ~524-531):**
       This is a placeholder function that only logs "Syncing practice sessions..." and does nothing. It's referenced by the `sync` event handler (lines ~302-308) which is also a placeholder.

       **Action:** The `sync` event listener and `syncPracticeSessions` function are both placeholders ("for future use"). Leave them as-is since they have zero runtime impact (background sync events don't fire without explicit registration) and removing them could break future plans. Add a comment clarifying the stub status if one doesn't exist already.

    3. **General review:** Read through the service worker to confirm:
       - Auth endpoint exclusion is comprehensive (already verified in Phase 3)
       - Cache version is current (`pianomaster-v3`)
       - No celebration-specific exclusions exist (confirmed by research - the SW excludes ALL JS which is correct for Vite SPA)
       - Static cache URLs are still valid

    4. Commit service worker changes:
       ```
       git commit -m "chore(18): remove duplicate JS exclusion block in service worker

       The fetch handler had two blocks checking for JavaScript files.
       The second block (script/module destination + .js/.mjs extension) was
       unreachable because the first block already returns for all JS requests.

       Removed the redundant second block. No behavioral change."
       ```

    **Part B: Final validation and bundle comparison**

    1. Run the full test suite:
       ```
       npm run test:run
       ```

    2. Run lint:
       ```
       npm run lint
       ```

    3. Run production build (this also generates updated bundle-stats.html):
       ```
       npm run build
       ```

    4. Compare build output against baseline captured in `.planning/phases/18-code-cleanup/BASELINE_METRICS.txt`:
       - Note total JS bundle size change
       - Note any chunks that were removed or significantly reduced
       - If rollup-plugin-visualizer generated stats, compare the treemap

    5. Create a final commit documenting the before/after comparison:
       ```
       git commit --allow-empty -m "docs(18): code cleanup complete - bundle comparison

       Before cleanup: [baseline total JS size from BASELINE_METRICS.txt]
       After cleanup: [current total JS size from build output]
       Delta: [difference]

       Removals:
       - progressMigration.js (241 lines)
       - [list other removals from Plan 01 and Task 1]

       Tooling added:
       - rollup-plugin-visualizer (permanent dev dependency)

       Phase 18 complete."
       ```
       Note: Use `--allow-empty` only if all file changes were already committed. If there are remaining unstaged changes, stage and commit them normally.

    6. Clean up working files:
       - Delete `.planning/phases/18-code-cleanup/BASELINE_METRICS.txt` (temporary)
       - Delete `.planning/phases/18-code-cleanup/AUDIT_RESULTS.md` (temporary)
       - These were working documents, not permanent planning artifacts.
  </action>
  <verify>
    - `npm run test:run` passes (zero failures)
    - `npm run build` succeeds (zero errors)
    - `npm run lint` passes (or only pre-existing warnings)
    - Service worker no longer has duplicate JS exclusion block
    - Before/after bundle size documented in commit message
    - dist/bundle-stats.html generated for visual inspection
  </verify>
  <done>Service worker cleaned up, full validation passed, before/after bundle comparison documented, Phase 18 complete</done>
</task>

</tasks>

<verification>
- Zero test failures across entire test suite
- Production build succeeds with no errors
- ESLint passes with no new warnings
- Service worker has single JS exclusion block (no duplicate)
- Before/after bundle size comparison documented
- All removals have individual atomic commits
- dist/bundle-stats.html available for visual bundle inspection
- No dead code flagged by knip/depcheck after cleanup (re-run confirms clean)
</verification>

<success_criteria>
1. All dead code candidates from audit either removed or explicitly documented as false positives
2. Service worker optimized with redundant code removed
3. Test suite, build, and lint all pass cleanly
4. Before/after bundle size delta documented in commit history
5. rollup-plugin-visualizer generates bundle-stats.html on every future build
</success_criteria>

<output>
After completion, create `.planning/phases/18-code-cleanup/18-02-SUMMARY.md`
</output>
