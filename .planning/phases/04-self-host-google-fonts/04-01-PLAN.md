---
phase: 04-self-host-google-fonts
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - package.json
  - src/main.jsx
  - index.html
  - public/sw.js
autonomous: true

must_haves:
  truths:
    - "All fonts render correctly with the same appearance as before migration"
    - "No external requests to fonts.googleapis.com or fonts.gstatic.com appear in Network tab"
    - "App loads fonts from self-hosted assets (localhost/assets/*.woff2)"
    - "Service worker cache is updated and no longer references Google Fonts CDN"
  artifacts:
    - path: "package.json"
      provides: "@fontsource/* packages installed"
      contains: "@fontsource/outfit"
    - path: "src/main.jsx"
      provides: "Font CSS imports before React imports"
      contains: "@fontsource/outfit/400.css"
    - path: "index.html"
      provides: "No external Google Fonts links"
      min_lines: 40
    - path: "public/sw.js"
      provides: "Service worker without Google Fonts caching patterns"
      contains: "pianomaster-v3"
  key_links:
    - from: "src/main.jsx"
      to: "node_modules/@fontsource/*"
      via: "import statements"
      pattern: "import '@fontsource/"
    - from: "public/sw.js"
      to: "RUNTIME_CACHE_PATTERNS"
      via: "Cache pattern array"
      pattern: "RUNTIME_CACHE_PATTERNS"
---

<objective>
Self-host all Google Fonts to eliminate third-party data collection from under-13 users, completing COPPA-06 compliance.

Purpose: Google Fonts CDN shares user IP addresses with Google's servers. For COPPA compliance with children under 13, all fonts must be served locally to prevent third-party data collection.

Output: Application serves all fonts from self-hosted assets with zero external CDN requests.
</objective>

<execution_context>
@C:\Users\pagis\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\pagis\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-self-host-google-fonts/04-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install fontsource packages and add imports to main.jsx</name>
  <files>
    package.json
    src/main.jsx
  </files>
  <action>
    1. Install 7 fontsource packages as dev dependencies:
       ```bash
       npm install --save-dev @fontsource/outfit @fontsource/comic-neue @fontsource/nunito @fontsource/fredoka-one @fontsource/dancing-script @fontsource/heebo @fontsource/assistant
       ```
       NOTE: Skip @fontsource/material-icons-round - research found ZERO usage of icon font in codebase.

    2. Edit src/main.jsx to add font imports at the VERY TOP of the file, BEFORE all other imports.
       Add these imports (in order):

       ```javascript
       // === SELF-HOSTED FONTS (COPPA-06 compliance) ===
       // Import fonts FIRST, before any other imports

       // Outfit: Primary sans-serif (font-outfit)
       import '@fontsource/outfit/400.css';
       import '@fontsource/outfit/500.css';
       import '@fontsource/outfit/600.css';
       import '@fontsource/outfit/700.css';

       // Comic Neue: Playful/comic font (font-comic)
       import '@fontsource/comic-neue/300.css';
       import '@fontsource/comic-neue/400.css';
       import '@fontsource/comic-neue/700.css';

       // Nunito: Rounded sans-serif (font-rounded)
       import '@fontsource/nunito/300.css';
       import '@fontsource/nunito/400.css';
       import '@fontsource/nunito/600.css';
       import '@fontsource/nunito/700.css';
       import '@fontsource/nunito/800.css';

       // Fredoka One: Display/playful font (font-playful)
       import '@fontsource/fredoka-one/400.css';

       // Dancing Script: Signature/cursive font (font-signature)
       import '@fontsource/dancing-script/400.css';
       import '@fontsource/dancing-script/500.css';
       import '@fontsource/dancing-script/600.css';
       import '@fontsource/dancing-script/700.css';

       // Heebo: Hebrew/RTL font (font-hebrew)
       import '@fontsource/heebo/400.css';
       import '@fontsource/heebo/500.css';
       import '@fontsource/heebo/600.css';
       import '@fontsource/heebo/700.css';
       import '@fontsource/heebo/800.css';

       // Assistant: Hebrew/RTL font (font-hebrew)
       import '@fontsource/assistant/400.css';
       import '@fontsource/assistant/500.css';
       import '@fontsource/assistant/600.css';
       import '@fontsource/assistant/700.css';
       import '@fontsource/assistant/800.css';
       ```

       The existing imports (StrictMode, createRoot, etc.) should come AFTER these font imports.
  </action>
  <verify>
    Run `npm ls @fontsource/outfit` - should show the package installed.
    Run `grep -c "@fontsource" src/main.jsx` - should return 30 (number of font weight imports).
  </verify>
  <done>
    7 fontsource packages installed in package.json devDependencies.
    30 font weight imports added to top of src/main.jsx.
  </done>
</task>

<task type="auto">
  <name>Task 2: Remove external font links and update service worker</name>
  <files>
    index.html
    public/sw.js
  </files>
  <action>
    1. Edit index.html to REMOVE these external font references:
       - Lines 12-13: Delete preconnect/dns-prefetch hints for fonts.googleapis.com
         ```html
         <!-- DELETE THESE -->
         <link rel="preconnect" href="https://fonts.googleapis.com" />
         <link rel="dns-prefetch" href="https://fonts.googleapis.com" />
         ```

       - Lines 53-55: Delete the Google Fonts stylesheet links
         ```html
         <!-- DELETE THESE -->
         <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=..." />
         <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet" />
         ```

    2. Edit public/sw.js:
       - Line 4: Bump CACHE_NAME from "pianomaster-v2" to "pianomaster-v3"
         This invalidates old caches that contain Google Fonts entries.

       - Lines 22-24: Remove Google Fonts patterns from RUNTIME_CACHE_PATTERNS:
         ```javascript
         // BEFORE
         const RUNTIME_CACHE_PATTERNS = [
           // Cache Google Fonts
           /^https:\/\/fonts\.googleapis\.com/,
           /^https:\/\/fonts\.gstatic\.com/,
           // Cache Supabase API endpoints...
           /^https:\/\/.*\.supabase\.co/,
         ];

         // AFTER
         const RUNTIME_CACHE_PATTERNS = [
           // Cache Supabase API endpoints (excluding auth - see AUTH_EXCLUDED_PATTERNS)
           /^https:\/\/.*\.supabase\.co/,
         ];
         ```

         Remove the two Google Fonts regex patterns and their comment.
  </action>
  <verify>
    Run `grep -c "fonts.googleapis" index.html` - should return 0.
    Run `grep -c "fonts.gstatic" public/sw.js` - should return 0.
    Run `grep "pianomaster-v3" public/sw.js` - should show the updated cache version.
  </verify>
  <done>
    index.html contains no external Google Fonts links (preconnect hints or stylesheet links).
    public/sw.js CACHE_NAME bumped to "pianomaster-v3".
    public/sw.js RUNTIME_CACHE_PATTERNS no longer includes Google Fonts patterns.
  </done>
</task>

</tasks>

<verification>
After completing both tasks:

1. Run `npm run dev` to start the development server.

2. Open browser DevTools > Network tab > Filter by "Font":
   - ZERO requests should go to fonts.googleapis.com or fonts.gstatic.com
   - Requests should go to localhost:5174/assets/*.woff2 (self-hosted fonts)

3. Visual verification:
   - Navigate through the app (Dashboard, Trail Map, Settings)
   - Verify all text renders with correct fonts (no fallback system fonts)
   - Check Hebrew text (if language switched to Hebrew) renders correctly

4. Service worker verification:
   - Open DevTools > Application > Service Workers
   - Check "Update on reload"
   - Reload page
   - Verify cache version updated to "pianomaster-v3" in Cache Storage

5. Run `npm run build` to ensure production build succeeds with bundled fonts.
</verification>

<success_criteria>
- Network tab shows ZERO requests to googleapis.com or gstatic.com
- All fonts render correctly (Outfit, Comic Neue, Nunito, Fredoka One, Dancing Script, Heebo, Assistant)
- Service worker cache updated to v3
- Production build succeeds
- COPPA-06 requirement fulfilled: no third-party font CDN data collection
</success_criteria>

<output>
After completion, create `.planning/phases/04-self-host-google-fonts/04-01-SUMMARY.md`
</output>
