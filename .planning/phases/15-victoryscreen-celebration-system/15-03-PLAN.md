---
phase: 15-victoryscreen-celebration-system
plan: 03
type: execute
wave: 2
depends_on: ["15-01", "15-02"]
files_modified:
  - src/components/games/VictoryScreen.jsx
autonomous: true

must_haves:
  truths:
    - "VictoryScreen shows tiered celebrations (minimal/standard/full/epic) based on achievement"
    - "Confetti effects trigger for 3-star completions and boss wins"
    - "Celebration messaging is node-type-specific (8 different messages for 8 node types)"
    - "XP breakdown displays Stars earned and bonus sources"
    - "Progress comparison shows Better than X% of your previous scores when data is available"
    - "Free play mode (no nodeId) still works with generic messages and no confetti"
    - "All animations respect reducedMotion accessibility setting"
  artifacts:
    - path: "src/components/games/VictoryScreen.jsx"
      provides: "Enhanced VictoryScreen with tiered celebrations, confetti, messages, XP breakdown, percentile"
      contains: "determineCelebrationTier"
  key_links:
    - from: "src/components/games/VictoryScreen.jsx"
      to: "src/utils/celebrationTiers.js"
      via: "import determineCelebrationTier, getCelebrationConfig"
      pattern: "from.*celebrationTiers"
    - from: "src/components/games/VictoryScreen.jsx"
      to: "src/utils/celebrationMessages.js"
      via: "import getCelebrationMessage"
      pattern: "from.*celebrationMessages"
    - from: "src/components/games/VictoryScreen.jsx"
      to: "src/components/celebrations/ConfettiEffect.jsx"
      via: "import ConfettiEffect"
      pattern: "from.*ConfettiEffect"
    - from: "src/components/games/VictoryScreen.jsx"
      to: "src/services/scoreComparisonService.js"
      via: "import calculateScorePercentile, getPercentileMessage"
      pattern: "from.*scoreComparisonService"
---

<objective>
Integrate all celebration features into VictoryScreen: tiered celebrations, confetti, node-type-specific messages, XP breakdown display, and percentile comparison.

Purpose: This is the convergence plan that wires together the utilities from Plan 01 and the percentile service from Plan 02 into the existing VictoryScreen component. This delivers all 5 requirements (CELEB-01, CELEB-02, CELEB-05, CELEB-08, CELEB-09).

Output: Enhanced VictoryScreen.jsx that shows tiered celebrations with all features.
</objective>

<execution_context>
@C:\Users\pagis\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\pagis\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/15-victoryscreen-celebration-system/15-RESEARCH.md
@.planning/phases/15-victoryscreen-celebration-system/15-01-SUMMARY.md
@.planning/phases/15-victoryscreen-celebration-system/15-02-SUMMARY.md

Key existing files:
@src/components/games/VictoryScreen.jsx
@src/utils/celebrationTiers.js
@src/utils/celebrationMessages.js
@src/components/celebrations/ConfettiEffect.jsx
@src/services/scoreComparisonService.js
@src/utils/celebrationConstants.js
@src/components/celebrations/CelebrationWrapper.jsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add tiered celebrations, confetti, and messages to VictoryScreen</name>
  <files>src/components/games/VictoryScreen.jsx</files>
  <action>
Modify the existing VictoryScreen.jsx to integrate tiered celebrations, confetti, node-type messages, XP breakdown, and percentile comparison. This is a modification of an existing ~820-line file -- be surgical, preserve all existing functionality.

**New imports to add (at top of file):**
```javascript
import { determineCelebrationTier, getCelebrationConfig } from '../../utils/celebrationTiers';
import { getCelebrationMessage } from '../../utils/celebrationMessages';
import { ConfettiEffect } from '../celebrations/ConfettiEffect';
import { calculateScorePercentile, getPercentileMessage } from '../../services/scoreComparisonService';
```

**New state to add (near existing state declarations around line 196-204):**
```javascript
const [showConfetti, setShowConfetti] = useState(false);
const [percentileMessage, setPercentileMessage] = useState(null);
```

**Celebration tier calculation (add after stars are calculated, around where `setStars(earnedStars)` is called ~line 328):**

The tier and message need to be available in the render section. Since stars, nodeData, and xpData are all set in the processTrailCompletion useEffect, we need derived values. The cleanest approach:

Add a `useMemo` that computes celebration data from existing state:
```javascript
// Celebration tier and messaging (derived from existing state)
const celebrationData = useMemo(() => {
  const node = nodeId ? getNodeById(nodeId) : null;
  const isBoss = node?.isBoss || false;
  const nodeType = node?.nodeType || null;

  const tier = determineCelebrationTier(
    stars,
    isBoss,
    xpData?.leveledUp || false,
    scorePercentage
  );
  const config = getCelebrationConfig(tier);
  const message = getCelebrationMessage(nodeType, stars, isBoss);

  return { tier, config, message, isBoss, nodeType };
}, [nodeId, stars, xpData?.leveledUp, scorePercentage]);
```

Place this useMemo AFTER the existing state declarations and BEFORE the useEffects.

**Confetti trigger (new useEffect):**
```javascript
// Trigger confetti for full/epic tiers (non-blocking, after trail processing)
useEffect(() => {
  if (!isProcessingTrail && celebrationData.config.confetti && !reducedMotion) {
    setShowConfetti(true);
  }
}, [isProcessingTrail, celebrationData.config.confetti, reducedMotion]);
```

This waits for trail processing to complete before showing confetti, preventing confetti on a loading state.

**Percentile calculation (new useEffect):**
```javascript
// Calculate percentile in background (non-blocking, never delays rendering)
useEffect(() => {
  if (!nodeId || !user?.id || isProcessingTrail) return;

  const loadPercentile = async () => {
    const percentile = await calculateScorePercentile(
      user.id,
      Math.round(Math.min(scorePercentage, 100)),
      nodeId
    );
    const message = getPercentileMessage(percentile);
    setPercentileMessage(message);
  };

  loadPercentile();
}, [nodeId, user?.id, scorePercentage, isProcessingTrail]);
```

IMPORTANT: This useEffect waits for `isProcessingTrail` to be false. The percentile query happens in the background and never blocks rendering.

**Render changes -- Confetti overlay:**

Add BEFORE the main content container (inside the outermost div, before the `flex w-full max-w-md` div):
```jsx
{/* Confetti overlay for full/epic celebrations */}
{showConfetti && (
  <ConfettiEffect
    tier={celebrationData.tier}
    onComplete={() => setShowConfetti(false)}
  />
)}
```

**Render changes -- Victory title (replace existing h2 ~line 620-626):**

Replace the existing hardcoded title with node-type-specific messaging:
```jsx
<h2 className="bg-gradient-to-r from-purple-400 via-pink-500 to-red-500 bg-clip-text text-xl font-bold text-transparent sm:text-2xl">
  {rateLimited
    ? 'Great Practice!'
    : isProcessingTrail
      ? 'Loading...'
      : celebrationData.message.title}
</h2>

{/* Subtitle (only for trail nodes after processing completes) */}
{!isProcessingTrail && !rateLimited && nodeId && (
  <p className="text-sm text-white/80">
    {celebrationData.message.subtitle}
  </p>
)}
```

Keep the existing exercise indicator (line 629-636) as-is, right after the subtitle.

For FREE PLAY mode (when nodeId is null), the celebrationData.message will use generic star-based messages because nodeType will be null. The existing "Victory!" title for free play mode should be replaced by the star-based messages from celebrationMessages.js. But we need to handle the case where stars might be 0 in free play (no star calculation happens for non-trail). Solution: In the useMemo, when nodeId is null, use the scorePercentage to calculate stars locally:

Update the useMemo to handle free play:
```javascript
const celebrationData = useMemo(() => {
  const node = nodeId ? getNodeById(nodeId) : null;
  const isBoss = node?.isBoss || false;
  const nodeType = node?.nodeType || null;

  // For free play, calculate stars from score percentage
  const effectiveStars = nodeId ? stars : calculateStars(scorePercentage);

  const tier = determineCelebrationTier(
    effectiveStars,
    isBoss,
    xpData?.leveledUp || false,
    scorePercentage
  );
  const config = getCelebrationConfig(tier);
  const message = getCelebrationMessage(nodeType, effectiveStars, isBoss);

  return { tier, config, message, isBoss, nodeType, effectiveStars };
}, [nodeId, stars, xpData?.leveledUp, scorePercentage]);
```

**Render changes -- XP Breakdown (enhance existing XP display ~lines 668-692):**

Replace the existing XP display block with a more detailed breakdown. The existing block shows "+{xpData.totalXP}" and "(+{xpData.bonusXP} bonus)". Enhance it:

```jsx
{/* XP gained display with breakdown (if trail node) */}
{xpData && xpData.totalXP > 0 && (
  <div className="relative mt-1 sm:mt-2">
    <div className="absolute inset-0 bg-gradient-to-r from-blue-200/40 via-purple-200/30 to-pink-200/40 opacity-70 blur-lg" />
    <div className="relative space-y-1.5 rounded-xl border-white/60 bg-white/90 px-3 py-2 shadow-lg sm:px-4 sm:py-2.5">
      {/* Total XP header */}
      <div className="text-center">
        <p className="text-sm font-bold text-blue-600 sm:text-base">
          +{xpData.totalXP} XP Earned
        </p>
      </div>

      {/* XP Breakdown */}
      <div className="space-y-0.5 text-xs text-gray-600">
        {/* Stars earned */}
        <div className="flex justify-between">
          <span>Stars earned ({xpData.stars}):</span>
          <span className="font-semibold text-blue-600">+{xpData.baseXP}</span>
        </div>

        {/* Bonus: First time */}
        {xpData.bonuses?.firstTime && (
          <div className="flex justify-between text-purple-600">
            <span>First time bonus:</span>
            <span className="font-semibold">+25</span>
          </div>
        )}

        {/* Bonus: Perfect score */}
        {xpData.bonuses?.perfect && (
          <div className="flex justify-between text-amber-600">
            <span>Perfect score:</span>
            <span className="font-semibold">+50</span>
          </div>
        )}

        {/* Bonus: Three stars */}
        {xpData.bonuses?.threeStars && (
          <div className="flex justify-between text-yellow-600">
            <span>Three stars:</span>
            <span className="font-semibold">+50</span>
          </div>
        )}
      </div>

      {/* Level up indicator */}
      {xpData.leveledUp && (
        <div className={`${reducedMotion ? '' : 'animate-bounce'} mt-1 rounded-lg bg-gradient-to-r from-purple-500 to-pink-500 px-2 py-1 text-center text-xs font-bold text-white shadow-lg`}>
          Level {xpData.newLevel}!
        </div>
      )}
    </div>
  </div>
)}
```

**Render changes -- Percentile comparison (add AFTER XP breakdown, BEFORE timed mode info):**

```jsx
{/* Score percentile comparison (loads async, trail nodes only) */}
{percentileMessage && (
  <div className="mt-1 rounded-lg bg-white/20 px-3 py-1.5 text-center text-sm text-white/90 sm:mt-2">
    {percentileMessage}
  </div>
)}
```

**Star rating display enhancement:**

The existing star display (lines 644-665) shows stars only when `nodeId && stars > 0`. Update the condition to also show stars in free play mode when celebrationData.effectiveStars > 0:

```jsx
{/* Star rating display */}
{(nodeId ? stars > 0 : celebrationData.effectiveStars > 0) && (
  <div className="flex items-center justify-center gap-1 py-1">
    {[1, 2, 3].map((starNum) => {
      const earned = nodeId ? stars : celebrationData.effectiveStars;
      return (
        <span
          key={starNum}
          className={`text-3xl ${
            starNum <= earned
              ? reducedMotion
                ? 'text-yellow-400 drop-shadow-lg'
                : 'animate-bounce text-yellow-400 drop-shadow-lg'
              : 'text-gray-400/30'
          } ${!reducedMotion ? 'transition-all duration-300' : 'transition-opacity duration-100'}`}
          style={reducedMotion ? {} : {
            animationDelay: `${starNum * 100}ms`,
            animationDuration: '600ms'
          }}
        >
          &#11088;
        </span>
      );
    })}
  </div>
)}
```

Wait -- on second thought, showing stars in free play might be a bigger change than intended. The requirements only specify tiered celebrations for trail nodes. Keep the star display condition as `nodeId && stars > 0` to avoid changing free play behavior. The free play title message will still come from celebrationMessages (generic star-based), which is sufficient.

So KEEP the existing star display condition: `{nodeId && stars > 0 && (`. Do NOT change it.

**Summary of all changes:**
1. 4 new imports at top
2. 2 new state variables (showConfetti, percentileMessage)
3. 1 new useMemo (celebrationData)
4. 2 new useEffects (confetti trigger, percentile calculation)
5. Confetti overlay added to render (before main content)
6. Victory title replaced with celebrationData.message.title
7. Subtitle added below title
8. XP display enhanced with breakdown details
9. Percentile message added after XP breakdown

**What NOT to change:**
- All existing button logic, navigation, exercise tracking
- All existing accessory unlock detection
- All existing rate limiting behavior
- All existing points celebration
- All existing timed mode info display
- useCountUp hook and its animation logic
- Score display ("Final Score: X/Y")
- Exercise indicator for multi-exercise nodes
  </action>
  <verify>
1. `npm run lint` passes
2. `npm run build` succeeds
3. Verify imports: `grep "celebrationTiers\|celebrationMessages\|ConfettiEffect\|scoreComparisonService" src/components/games/VictoryScreen.jsx` should show 4 imports
4. Verify confetti rendered: `grep "ConfettiEffect" src/components/games/VictoryScreen.jsx` should appear in both import and JSX
5. Verify tier calculation: `grep "determineCelebrationTier" src/components/games/VictoryScreen.jsx`
6. Verify message usage: `grep "celebrationData.message" src/components/games/VictoryScreen.jsx`
7. Verify XP breakdown: `grep "baseXP\|bonuses.firstTime\|bonuses.perfect\|bonuses.threeStars" src/components/games/VictoryScreen.jsx`
8. Verify percentile: `grep "percentileMessage" src/components/games/VictoryScreen.jsx`
9. Start dev server (`npm run dev`) and verify no console errors on load
  </verify>
  <done>
- VictoryScreen shows tiered celebrations (minimal/standard/full/epic) based on stars, boss status, and level-up
- Confetti triggers for full tier (3-star) and epic tier (boss wins), skipped in reducedMotion
- Victory title and subtitle are node-type-specific for all 8 node types
- Free play mode shows generic star-based messages (no crash on null nodeType)
- XP breakdown shows "Stars earned: +X" and individual bonus lines
- Percentile comparison message appears asynchronously when data is available
- All existing VictoryScreen functionality preserved (buttons, navigation, rate limiting, accessory unlocks)
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Complete tiered VictoryScreen celebration system with confetti, node-type messages, XP breakdown, and percentile comparison</what-built>
  <how-to-verify>
1. Start dev server: `npm run dev`
2. Navigate to Trail Map (/trail)
3. Play a trail node and complete it with different scores:
   - Score below 60% (0 stars): Should see "Nice Effort!" title, no confetti, minimal celebration
   - Score 60-79% (1 star): Should see "Good Try!" title, no confetti, standard celebration
   - Score 80-94% (2 stars): Should see "Great Job!" title, no confetti
   - Score 95%+ (3 stars): Should see node-type-specific title (e.g., "NEW NOTES MASTERED!" for discovery nodes), confetti triggers
4. If you can test a boss node: Should see "BOSS DEFEATED!" or "PERFECT VICTORY!" with more intense confetti
5. Check XP breakdown: After completing a trail node, XP section should show "Stars earned (X): +Y" plus any bonus lines
6. After 3+ completions on different nodes, check if percentile message appears below XP breakdown
7. Play a free play game (not from trail): Should see generic star-based messages, no confetti, no XP breakdown
8. If accessibility settings available: Enable reduced motion and verify confetti does not appear
  </how-to-verify>
  <resume-signal>Type "approved" if celebrations look correct, or describe any issues</resume-signal>
</task>

</tasks>

<verification>
- `npm run lint` passes with no errors
- `npm run build` succeeds
- VictoryScreen renders without console errors
- All 5 requirements delivered:
  - CELEB-01: Tiered celebrations based on achievement
  - CELEB-02: Confetti for 3-star and boss wins
  - CELEB-05: Node-type-specific messaging
  - CELEB-08: XP breakdown display
  - CELEB-09: Percentile comparison
- Free play mode unaffected (no crashes, no trail-specific features)
- Reduced motion mode suppresses confetti
</verification>

<success_criteria>
VictoryScreen shows different celebration intensities based on achievement. 3-star completions and boss wins trigger confetti. Each of the 8 node types shows unique celebration messages. XP section breaks down into stars earned, first time bonus, perfect score bonus, and three star bonus. After sufficient history, a "Better than X% of your previous scores" message appears. All existing VictoryScreen features (buttons, navigation, rate limiting, unlocks) continue to work.
</success_criteria>

<output>
After completion, create `.planning/phases/15-victoryscreen-celebration-system/15-03-SUMMARY.md`
</output>
