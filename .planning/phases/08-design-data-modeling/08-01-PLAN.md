---
phase: 08-design-data-modeling
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - scripts/validateTrail.mjs
  - package.json
autonomous: true

must_haves:
  truths:
    - "Running npm run build fails on invalid prerequisite cycles"
    - "Running npm run build fails on invalid NODE_TYPES"
    - "Running npm run build shows XP totals per path"
    - "Running npm run verify:trail works as standalone validation"
  artifacts:
    - path: "scripts/validateTrail.mjs"
      provides: "Build-time trail validation"
      exports: ["validatePrerequisiteChains", "validateNodeTypes", "validateXPEconomy"]
      min_lines: 80
    - path: "package.json"
      provides: "npm lifecycle integration"
      contains: "prebuild"
  key_links:
    - from: "scripts/validateTrail.mjs"
      to: "src/data/skillTrail.js"
      via: "ESM import"
      pattern: "import.*SKILL_NODES.*skillTrail"
    - from: "scripts/validateTrail.mjs"
      to: "src/data/nodeTypes.js"
      via: "ESM import"
      pattern: "import.*NODE_TYPES.*nodeTypes"
    - from: "package.json"
      to: "scripts/validateTrail.mjs"
      via: "prebuild script"
      pattern: '"prebuild".*validateTrail'
---

<objective>
Create build-time validation script that catches trail data errors before deploy.

Purpose: Establish validation infrastructure that prevents broken prerequisite chains, invalid node types, and XP economy drift from reaching production. This is the foundation for Phases 9-12.

Output:
- `scripts/validateTrail.mjs` - Standalone ESM validation script
- Updated `package.json` with prebuild hook
</objective>

<execution_context>
@C:\Users\pagis\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\pagis\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/08-design-data-modeling/08-CONTEXT.md
@.planning/phases/08-design-data-modeling/08-RESEARCH.md

@src/data/skillTrail.js
@src/data/nodeTypes.js
@src/data/constants.js
@scripts/patternVerifier.mjs
@package.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create validateTrail.mjs with full validation suite</name>
  <files>scripts/validateTrail.mjs</files>
  <action>
Create a Node.js ESM script (`scripts/validateTrail.mjs`) that validates the trail data structure.

**Implement these validation functions:**

1. **validatePrerequisiteChains()** - DFS cycle detection using three-state tracking:
   - UNVISITED (0), VISITING (1), VISITED (2)
   - Check ALL nodes as starting points (not just entry nodes)
   - Log clear error: `Cycle detected: nodeA -> nodeB -> nodeC -> nodeA`
   - Also check for missing prerequisites (references to non-existent nodes)

2. **validateNodeTypes()** - Verify all nodes have valid NODE_TYPES:
   - Import NODE_TYPES from `../src/data/nodeTypes.js`
   - For each node with `nodeType` field, verify value is in NODE_TYPES
   - Log error: `Invalid nodeType in {node.id}: "{node.nodeType}"`
   - Note: Legacy nodes may not have nodeType field - skip those (no error)

3. **validateXPEconomy()** - Calculate and compare XP totals per category:
   - Sum xpReward by category (treble_clef, bass_clef, rhythm)
   - Calculate variance from maximum path
   - If variance > 10%, log warning (NOT error - XP balance will be fixed in Phase 11)
   - Always log XP totals: `Treble: {N} XP | Bass: {N} XP | Rhythm: {N} XP`

4. **validateDuplicateIds()** - Check for duplicate node IDs:
   - Collect all node IDs
   - Report any duplicates: `Duplicate node ID: {id}`

**Script structure:**
```javascript
#!/usr/bin/env node

import { SKILL_NODES } from '../src/data/skillTrail.js';
import { NODE_TYPES } from '../src/data/nodeTypes.js';

let hasErrors = false;
let hasWarnings = false;

// ... validation functions ...

console.log('Validating trail nodes...');
validatePrerequisiteChains();
validateNodeTypes();
validateDuplicateIds();
validateXPEconomy();

if (hasErrors) {
  console.error('\nValidation FAILED. Build aborted.\n');
  process.exit(1);
}

if (hasWarnings) {
  console.log('\nValidation passed with warnings.\n');
} else {
  console.log('\nTrail validation passed.\n');
}
```

**Style notes:**
- Use console.log for info, console.error for errors, console.warn for warnings
- Keep output concise and developer-friendly (no emoji spam - just at summary)
- Follow existing script conventions from patternVerifier.mjs
  </action>
  <verify>
Run the script manually:
```bash
node scripts/validateTrail.mjs
```
Should output validation results without errors (current data should pass).
  </verify>
  <done>
validateTrail.mjs exists with all 4 validation functions, runs successfully on current trail data, and would catch introduced errors (test by temporarily adding a cycle).
  </done>
</task>

<task type="auto">
  <name>Task 2: Integrate validation into npm build lifecycle</name>
  <files>package.json</files>
  <action>
Update package.json scripts to run validation automatically before build.

**Add these scripts:**

1. `"prebuild": "node scripts/validateTrail.mjs"` - Runs automatically before `build`
2. `"verify:trail": "node scripts/validateTrail.mjs"` - Standalone command for development

**Placement:** Add `prebuild` immediately before `build`, add `verify:trail` near other verify scripts.

**Result:**
```json
"scripts": {
  "dev": "vite",
  "prebuild": "node scripts/validateTrail.mjs",
  "build": "vite build",
  ...
  "verify:patterns": "node scripts/patternVerifier.mjs",
  "verify:trail": "node scripts/validateTrail.mjs",
  ...
}
```

**Why prebuild works:** npm automatically runs scripts prefixed with `pre` before the main script. `prebuild` runs before `build`. If validation fails (exit code 1), build never starts.
  </action>
  <verify>
Run full build to verify integration:
```bash
npm run build
```
Should show validation output followed by Vite build.

Also verify standalone command works:
```bash
npm run verify:trail
```
Should run validation only.
  </verify>
  <done>
`npm run build` automatically validates trail before building. `npm run verify:trail` works as standalone command. Validation failure prevents build from starting.
  </done>
</task>

</tasks>

<verification>
1. `npm run verify:trail` completes without errors on current trail data
2. `npm run build` shows validation output before Vite build starts
3. Introducing a cycle (edit a node's prerequisites temporarily) causes build to fail
4. Introducing an invalid nodeType causes build to fail
5. XP imbalance logs a warning but does not fail the build
</verification>

<success_criteria>
- Build-time validation catches invalid prerequisite chains before deploy
- Build-time validation verifies all node types are valid NODE_TYPES
- XP economy audit shows totals per path (warning on imbalance, not failure)
- Validation integrated into `npm run build` via prebuild hook
- `npm run verify:trail` available for standalone validation
</success_criteria>

<output>
After completion, create `.planning/phases/08-design-data-modeling/08-01-SUMMARY.md`
</output>
