---
phase: 04-platform-specific-android-enhancement
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/hooks/useLandscapeLock.js
  - src/hooks/useRotatePrompt.js
autonomous: true

must_haves:
  truths:
    - "useLandscapeLock hook enters fullscreen then locks to landscape on Android PWA"
    - "useLandscapeLock hook does nothing on iOS, desktop, or non-PWA contexts"
    - "useLandscapeLock cleanup unlocks orientation and exits fullscreen on unmount"
    - "Escape key exiting fullscreen also unlocks orientation via fullscreenchange listener"
    - "useRotatePrompt suppresses the rotate prompt on Android PWA (no double prompting)"
  artifacts:
    - path: "src/hooks/useLandscapeLock.js"
      provides: "Android PWA landscape lock hook"
      exports: ["useLandscapeLock"]
    - path: "src/hooks/useRotatePrompt.js"
      provides: "Rotate prompt with Android PWA suppression"
      contains: "isAndroidDevice"
  key_links:
    - from: "src/hooks/useLandscapeLock.js"
      to: "src/utils/pwaDetection.js"
      via: "isAndroidDevice and isInStandaloneMode imports"
      pattern: "import.*isAndroidDevice.*isInStandaloneMode.*pwaDetection"
    - from: "src/hooks/useRotatePrompt.js"
      to: "src/utils/pwaDetection.js"
      via: "isAndroidDevice and isInStandaloneMode imports"
      pattern: "import.*isAndroidDevice.*pwaDetection"
---

<objective>
Create the `useLandscapeLock` hook for Android PWA orientation locking and update `useRotatePrompt` to suppress the rotate prompt when landscape lock is available.

Purpose: Android PWA users should get API-based landscape locking (superior UX) instead of the CSS-based rotate prompt (iOS fallback). The hook must handle the fullscreen prerequisite, orientation lock sequence, Escape key edge case, and proper cleanup on unmount.

Output: Two hook files ready for game component integration in Plan 04-02.
</objective>

<execution_context>
@C:/Users/pagis/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/pagis/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-platform-specific-android-enhancement/04-RESEARCH.md
@src/utils/pwaDetection.js
@src/hooks/useOrientation.js
@src/hooks/useRotatePrompt.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create useLandscapeLock hook for Android PWA</name>
  <files>src/hooks/useLandscapeLock.js</files>
  <action>
Create `src/hooks/useLandscapeLock.js` that exports a `useLandscapeLock` function. The hook must:

1. **Platform guard**: Import `isAndroidDevice` and `isInStandaloneMode` from `../utils/pwaDetection`. Only proceed if BOTH return true (Android + PWA). Return early otherwise (iOS/desktop/browser get no-op).

2. **API support guard**: Check that `document.documentElement.requestFullscreen` exists AND `screen.orientation?.lock` exists. Log a warning and return early if either is missing.

3. **Lock sequence** (async function called inside useEffect):
   - `await document.documentElement.requestFullscreen({ navigationUI: "hide" })` — fullscreen first (required for orientation lock on Android)
   - Set a local `didEnterFullscreen` flag to `true`
   - `await screen.orientation.lock("landscape")` — lock to landscape after fullscreen
   - Wrap in try/catch, log errors to console.error with message "Orientation lock failed:"

4. **Escape key handling**: Add a `fullscreenchange` event listener inside the same useEffect. When fired, check `!document.fullscreenElement` — if user exited fullscreen (Escape key), call `screen.orientation.unlock()` if available. This prevents the device staying in landscape after the user manually exits fullscreen.

5. **Cleanup function** (useEffect return):
   - Remove the `fullscreenchange` event listener
   - Call `screen.orientation.unlock()` if available
   - If `didEnterFullscreen && document.fullscreenElement`, call `document.exitFullscreen().catch(() => {})` (swallow error since component is unmounting)

6. **Empty dependency array** `[]` — run once on mount, cleanup on unmount.

The hook takes no parameters and returns nothing (void). It is purely a side-effect hook.

Do NOT use `useCallback` or `useMemo` — this is a fire-and-forget effect.
  </action>
  <verify>
File exists at `src/hooks/useLandscapeLock.js`. Verify:
- Imports `isAndroidDevice` and `isInStandaloneMode` from pwaDetection
- Exports `useLandscapeLock` function
- Contains `requestFullscreen` call BEFORE `screen.orientation.lock`
- Contains `fullscreenchange` event listener
- Cleanup function calls `unlock()` and `exitFullscreen()`
- Has empty dependency array `[]`

Run: `npx vitest run --passWithNoTests` to confirm no existing tests break.
  </verify>
  <done>
`useLandscapeLock.js` exists, exports the hook, handles the full lock sequence (fullscreen → orientation lock), handles Escape key via fullscreenchange listener, and cleans up on unmount. No existing tests break.
  </done>
</task>

<task type="auto">
  <name>Task 2: Suppress rotate prompt on Android PWA</name>
  <files>src/hooks/useRotatePrompt.js</files>
  <action>
Update `src/hooks/useRotatePrompt.js` to suppress the rotate prompt when the Android landscape lock is active.

1. Add import at top: `import { isAndroidDevice, isInStandaloneMode } from "../utils/pwaDetection";`

2. Inside the `useRotatePrompt` function, add a platform check. Use a state initializer (same pattern as `permanentlyDismissed`) to compute once:
   ```javascript
   const [isAndroidPWA] = useState(() => isAndroidDevice() && isInStandaloneMode());
   ```

3. Update the `shouldShowPrompt` logic to include the Android PWA suppression. The current logic is:
   ```javascript
   const shouldShowPrompt =
     !permanentlyDismissed &&
     isMobile &&
     isPortrait &&
     !(hasAutoDismissed && reshowUsed.current);
   ```

   Add `!isAndroidPWA` to the condition:
   ```javascript
   const shouldShowPrompt =
     !isAndroidPWA &&
     !permanentlyDismissed &&
     isMobile &&
     isPortrait &&
     !(hasAutoDismissed && reshowUsed.current);
   ```

   This ensures Android PWA users NEVER see the rotate prompt (they get API-based lock from `useLandscapeLock` instead). `!isAndroidPWA` is placed first for early short-circuit.

Do NOT change the `dismissPrompt` function or any other existing logic. Only add the import and the `isAndroidPWA` check.
  </action>
  <verify>
Read `src/hooks/useRotatePrompt.js` and verify:
- Import of `isAndroidDevice` and `isInStandaloneMode` exists
- `isAndroidPWA` state is computed
- `shouldShowPrompt` includes `!isAndroidPWA` condition
- All other existing logic is unchanged

Run: `npx vitest run --passWithNoTests` to confirm no existing tests break.
  </verify>
  <done>
`useRotatePrompt` suppresses the rotate prompt on Android PWA. iOS and non-PWA users continue seeing the prompt as before. No existing tests break.
  </done>
</task>

</tasks>

<verification>
1. `src/hooks/useLandscapeLock.js` exists and exports `useLandscapeLock`
2. Hook imports from `pwaDetection.js` and uses `isAndroidDevice()` + `isInStandaloneMode()`
3. Hook calls `requestFullscreen()` BEFORE `screen.orientation.lock()`
4. Hook has `fullscreenchange` event listener for Escape key handling
5. Hook cleanup calls `unlock()` and `exitFullscreen()`
6. `useRotatePrompt.js` suppresses prompt when `isAndroidPWA` is true
7. `npx vitest run --passWithNoTests` passes (no regressions)
</verification>

<success_criteria>
- useLandscapeLock hook created with fullscreen + orientation lock sequence for Android PWA
- useRotatePrompt updated to suppress prompt on Android PWA
- No existing tests broken
- Both hooks ready for game component integration in Plan 04-02
</success_criteria>

<output>
After completion, create `.planning/phases/04-platform-specific-android-enhancement/04-01-SUMMARY.md`
</output>
