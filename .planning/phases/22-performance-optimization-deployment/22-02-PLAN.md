---
phase: 22-performance-optimization-deployment
plan: 02
type: execute
wave: 2
depends_on: ["22-01"]
files_modified: []
autonomous: false

must_haves:
  truths:
    - "Trail page scrolling maintains smooth performance with no visible jank"
    - "Trail -> game -> VictoryScreen -> trail navigation flow works for all exercise types"
    - "All 93 nodes display correctly with correct states (locked/available/completed)"
    - "RTL layout visually mirrors LTR layout when switching to Hebrew"
    - "Screen reader can navigate through tabs and nodes with meaningful announcements"
    - "Focus indicators visible when tabbing through trail elements"
    - "Locked nodes use lock icon, completed nodes show stars, active nodes have visual indicator beyond color alone"
  artifacts: []
  key_links:
    - from: "TrailMapPage"
      to: "TrailMap -> ZigzagTrailLayout -> TrailNode"
      via: "Component hierarchy renders all 93 nodes"
      pattern: "ZigzagTrailLayout"
    - from: "TrailNodeModal"
      to: "Game routes"
      via: "navigateToExercise with location.state"
      pattern: "navigate.*notes-master-mode|rhythm-mode"
---

<objective>
Verify the complete trail page works correctly in production conditions: performance, accessibility, RTL, and game navigation flow.

Purpose: This is the final verification checkpoint before shipping v1.5. All code changes are complete from Plan 01. This plan verifies everything works together through manual testing.

Output: Verified, production-ready trail page.
</objective>

<execution_context>
@C:/Users/pagis/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/pagis/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/22-performance-optimization-deployment/22-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Automated verification checks</name>
  <files></files>
  <action>
Run the following automated checks before human verification:

1. **Build verification:** Run `npm run build` and confirm exit code 0
2. **Lint check:** Run `npm run lint` and compare error count against known baseline (24 errors, 415 warnings). Flag only NEW errors.
3. **Test run:** Run `npm run test:run` and compare against known baseline (SightReadingGame.micRestart.test.jsx failure is known). Flag only NEW failures.
4. **Pattern validation:** Run `npm run verify:patterns` and confirm exit code 0
5. **Service worker verification:** Run these grep commands and confirm output:
   - `grep "pianomaster-v4" public/sw.js` -- must match CACHE_NAME and CACHE_WHITELIST
   - `grep "skipWaiting" public/sw.js` -- must match
   - `grep "clients.claim" public/sw.js` -- must match
6. **Node count verification:** Run `grep -c "id:" src/data/expandedNodes.js` or count SKILL_NODES array length to confirm 93 nodes
7. **Trail navigation state verification:** Run `grep -n "location.state" src/components/trail/TrailNodeModal.jsx` and confirm the navigate call passes all required fields: nodeId, exerciseIndex, totalExercises, exerciseType. Also run `grep -n "nodeConfig\|nodeId\|exerciseIndex\|totalExercises\|exerciseType" src/components/trail/TrailNodeModal.jsx` to verify all fields are present.
8. **Start dev server** in background: Run `npm run dev` -- needed for human verification in Task 2
  </action>
  <verify>
  - `npm run build` exits with code 0
  - `npm run lint` shows no NEW errors beyond baseline 24
  - `npm run test:run` shows no NEW failures beyond known baseline
  - `npm run verify:patterns` exits with code 0
  - `grep "pianomaster-v4" public/sw.js` returns 2 matches (CACHE_NAME + CACHE_WHITELIST)
  - `grep -n "location.state" src/components/trail/TrailNodeModal.jsx` shows nodeId, exerciseIndex, totalExercises, exerciseType in navigate calls
  - Dev server running on port 5174
  </verify>
  <done>All automated checks pass, dev server running for human verification</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 2: Human verification of trail page production readiness</name>
  <what-built>Complete trail page with accessibility fixes, RTL support, focus indicators, and service worker cache bump from Plan 01</what-built>
  <how-to-verify>
Dev server should be running on http://localhost:5174/trail from Task 1.

**1. Visual correctness:**
   - Open http://localhost:5174/trail
   - All 3 tabs (Treble, Bass, Rhythm) display nodes in zigzag layout
   - Nodes show correct states: locked (greyed/dimmed), available (bright), completed (with stars)

**2. Touch targets:**
   - Right-click a tab button > Inspect > verify computed height >= 48px
   - Right-click a trail node > Inspect > verify computed width and height >= 48px

**3. Keyboard navigation:**
   - Press Tab key to move focus to trail elements -- white focus ring should appear
   - Use Arrow Left/Right keys to switch between tabs
   - Press Enter on a node to open its modal

**4. Game navigation flow:**
   - Click an available node > modal opens > click "Start Practice"
   - Complete the game (or cancel) > VictoryScreen appears > click "Back to Trail"
   - Verify you return to the trail page with the node state updated

**5. RTL verification:**
   - Open browser console, run: `document.documentElement.dir = 'rtl'`
   - Zigzag pattern should mirror (left nodes become right, right become left)
   - Tab arrow keys should swap direction (ArrowLeft = next, ArrowRight = previous)

**6. Performance:**
   - Rapidly scroll up and down on the trail page -- no visible jank or stutter
   - Rapidly switch between tabs -- transitions are smooth

**7. Accessibility - color not sole indicator (A11Y-01c):**
   - Verify locked nodes show a lock icon (not just grey color)
   - Verify completed nodes show star icons (not just green color)
   - Verify active/available nodes have a visual indicator beyond color alone (e.g., glow, border, or icon)
  </how-to-verify>
  <resume-signal>Type "approved" or describe issues found in any of the 7 verification areas</resume-signal>
</task>

</tasks>

<verification>
1. All automated checks pass (build, lint delta, tests delta, patterns)
2. Human confirms visual correctness of all 93 nodes across 3 tabs
3. Human confirms keyboard navigation with visible focus indicators
4. Human confirms game navigation round-trip works
5. Human confirms RTL mirroring works
6. Human confirms no performance jank during scrolling
7. Human confirms color is not the sole indicator for node states (A11Y-01c)
</verification>

<success_criteria>
- Build, lint, and tests show no new regressions
- Trail page displays correctly with all node states visible
- Keyboard navigation works with visible focus rings
- Game navigation flow (trail -> game -> victory -> trail) completes successfully
- RTL layout mirrors correctly
- Scrolling and tab switching are smooth (no jank)
- Node states use icons/visual indicators beyond color alone
- Human approves the trail page as production-ready
</success_criteria>

<output>
After completion, create `.planning/phases/22-performance-optimization-deployment/22-02-SUMMARY.md`
</output>
