---
phase: 22-performance-optimization-deployment
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - public/sw.js
  - src/components/trail/TrailMap.jsx
  - src/components/trail/ZigzagTrailLayout.jsx
  - src/components/trail/TrailNode.jsx
  - src/styles/trail-effects.css
autonomous: true

must_haves:
  truths:
    - "Service worker cache version is bumped and old caches are cleaned on activate"
    - "All interactive trail elements (nodes, tabs, buttons) have minimum 48x48px touch targets"
    - "Tab keyboard navigation respects RTL direction (ArrowRight goes to next in LTR, ArrowLeft goes to next in RTL)"
    - "ZigzagTrailLayout node positions mirror correctly in RTL mode"
    - "Screen reader announces node name, state, and position for each trail node"
    - "Focus indicators are visible on all interactive trail elements"
  artifacts:
    - path: "public/sw.js"
      provides: "Bumped cache version with old cache cleanup"
      contains: "pianomaster-v4"
    - path: "src/components/trail/TrailMap.jsx"
      provides: "RTL-aware tab keyboard navigation and min-height tab targets"
      contains: "handleTabKeyDown"
    - path: "src/components/trail/ZigzagTrailLayout.jsx"
      provides: "RTL-aware node positioning"
      contains: "isRTL"
    - path: "src/components/trail/TrailNode.jsx"
      provides: "Enhanced ARIA labels with position context"
      contains: "aria-label"
    - path: "src/styles/trail-effects.css"
      provides: "Focus-visible styles for trail nodes"
      contains: "focus-visible"
  key_links:
    - from: "src/components/trail/TrailMap.jsx"
      to: "src/components/trail/ZigzagTrailLayout.jsx"
      via: "isRTL prop passed through"
      pattern: "isRTL"
    - from: "public/sw.js"
      to: "caches API"
      via: "CACHE_WHITELIST filter in activate event"
      pattern: "pianomaster-v4"
---

<objective>
Fix accessibility gaps, RTL support, and bump service worker cache for v1.5 deployment.

Purpose: Ensure trail page meets WCAG 2.2 AA standards, works correctly for Hebrew (RTL) users, and service worker properly invalidates old cached assets when the redesigned trail ships to production.

Output: Updated trail components with RTL support, enhanced ARIA, 48px touch targets, visible focus indicators, and bumped service worker cache version.
</objective>

<execution_context>
@C:/Users/pagis/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/pagis/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/22-performance-optimization-deployment/22-RESEARCH.md
@public/sw.js
@src/components/trail/TrailMap.jsx
@src/components/trail/ZigzagTrailLayout.jsx
@src/components/trail/TrailNode.jsx
@src/components/trail/TrailNodeModal.jsx
@src/pages/TrailMapPage.jsx
@src/styles/trail-effects.css
</context>

<tasks>

<task type="auto">
  <name>Task 1: Service worker cache bump + accessibility and RTL fixes</name>
  <files>
    public/sw.js
    src/components/trail/TrailMap.jsx
    src/components/trail/ZigzagTrailLayout.jsx
    src/components/trail/TrailNode.jsx
    src/styles/trail-effects.css
  </files>
  <action>
1. **Service worker cache bump (public/sw.js):**
   - Change `CACHE_NAME` from `"pianomaster-v3"` to `"pianomaster-v4"` (line 4)
   - Update `CACHE_WHITELIST` array accordingly (line 6) to include `"pianomaster-v4"`
   - Verify `skipWaiting()` and `clients.claim()` are still present (they are)
   - No other changes to sw.js logic
   - **Why v3 to v4:** Phases 19-21 redesigned the trail system, changing bundled assets for trail-effects.css, TrailMap.jsx, ZigzagTrailLayout.jsx (new file), and HorizontalTrailLayout.jsx (new file). The v3 cache was set during earlier deployment and still serves stale versions of these assets. Bumping to v4 forces the activate handler to delete the v3 cache, ensuring production users receive the new responsive zigzag trail layout instead of the old cached horizontal layout.

2. **Tab touch targets and RTL keyboard nav (src/components/trail/TrailMap.jsx):**
   - Add `min-h-[48px]` to tab button className (currently `px-5 py-2.5` which may be under 48px height)
   - Pass `isRTL` prop from TrailMapPage through to TrailMap. TrailMapPage already computes `isRTL = i18n.dir() === 'rtl'` but does not pass it. Two options: (a) compute isRTL inside TrailMap using useTranslation, or (b) have TrailMapPage pass it as prop. Use option (a) since TrailMap already has useTranslation.
   - Add `const isRTL = i18n.dir() === 'rtl';` in TrailMap component (i18n is already destructured from useTranslation)
   - Fix `handleTabKeyDown` to swap ArrowLeft/ArrowRight behavior when RTL:
     ```
     const nextKey = isRTL ? 'ArrowLeft' : 'ArrowRight';
     const prevKey = isRTL ? 'ArrowRight' : 'ArrowLeft';
     ```
     Then use `prevKey`/`nextKey` instead of hardcoded 'ArrowLeft'/'ArrowRight'
   - Pass `isRTL` to `ZigzagTrailLayout` as a prop (alongside existing `isDesktop`)
   - Add `role="region"` and `aria-label` to the tab panel div for screen reader context

3. **RTL-aware zigzag layout (src/components/trail/ZigzagTrailLayout.jsx):**
   - Accept `isRTL` prop (add to destructured props, default `false`)
   - In the positions calculation, when `isRTL` is true, mirror the `xPercent` values: `const finalXPercent = isRTL ? (100 - xPercent) : xPercent`. This flips the zigzag so left nodes become right nodes and vice versa for RTL users.
   - Apply this mirroring when setting node `left` style and when computing PathConnector startX/endX coordinates.
   - Unit cards remain centered (`xPercent: 50`) so no change needed for cards.

4. **Enhanced screen reader labels (src/components/trail/TrailNode.jsx):**
   - Enhance the `aria-label` on the button (line 102) to include position context:
     Current: `aria-label={...node.name - nodeState}`
     Change to: `aria-label={...node.name, nodeState, stars if completed}`
     Format: `"C, D, E - completed - 3 stars"` or `"F, G - locked"` or `"A, B - available - start here"`
   - Add `aria-roledescription="skill node"` to the button for screen readers to announce it as a skill node rather than generic "button"

5. **Focus-visible styles (src/styles/trail-effects.css):**
   - Add focus-visible outlines for all node state classes. After the existing node styles, add:
     ```css
     .node-3d-active:focus-visible,
     .node-3d-completed:focus-visible,
     .node-3d-available:focus-visible,
     .node-3d-locked:focus-visible,
     .node-3d-locked-boss:focus-visible {
       outline: 3px solid #fff;
       outline-offset: 3px;
     }
     ```
   - This ensures keyboard users can see which node is focused. White outline is visible against the dark forest background.
  </action>
  <verify>
  - `npm run build` completes without errors
  - Grep `public/sw.js` for `pianomaster-v4` confirms cache bump
  - Grep `TrailMap.jsx` for `isRTL` confirms RTL awareness
  - Grep `ZigzagTrailLayout.jsx` for `isRTL` confirms mirrored positioning
  - Grep `trail-effects.css` for `focus-visible` confirms focus styles
  - Grep `TrailNode.jsx` for `aria-roledescription` confirms enhanced labels
  </verify>
  <done>
  - Service worker cache at v4 with whitelist updated
  - Tab buttons have 48px minimum height
  - Tab keyboard navigation swaps direction for RTL
  - Zigzag layout mirrors node positions in RTL mode
  - Trail nodes have descriptive screen reader labels with state and stars
  - All node states have visible focus-visible outlines
  </done>
</task>

</tasks>

<verification>
1. `npm run build` passes (no compilation errors from changes)
2. `grep -n "pianomaster-v4" public/sw.js` returns cache name line
3. `grep -n "isRTL" src/components/trail/TrailMap.jsx` shows RTL keyboard logic
4. `grep -n "isRTL" src/components/trail/ZigzagTrailLayout.jsx` shows mirrored positioning
5. `grep -n "focus-visible" src/styles/trail-effects.css` shows focus styles
6. `grep -n "aria-roledescription" src/components/trail/TrailNode.jsx` shows enhanced labels
</verification>

<success_criteria>
- Service worker bumped from v3 to v4 with old cache cleanup preserved
- All trail tab buttons have minimum 48x48px touch targets
- RTL mode mirrors zigzag layout and swaps keyboard arrow direction
- Screen reader labels include node name, state, and star count
- Focus-visible outlines visible on all interactive trail nodes
- Build passes without errors
</success_criteria>

<output>
After completion, create `.planning/phases/22-performance-optimization-deployment/22-01-SUMMARY.md`
</output>
