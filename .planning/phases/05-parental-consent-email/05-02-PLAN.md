---
phase: 05-parental-consent-email
plan: 02
type: execute
wave: 2
depends_on: ["05-01"]
files_modified:
  - src/services/consentService.js
  - src/services/apiAuth.js
  - src/pages/ConsentVerifyPage.jsx
autonomous: false

must_haves:
  truths:
    - "Child signup triggers email to parent within 30 seconds"
    - "Parent clicking consent link activates child account"
    - "No 406 errors in browser console during auth flow"
    - "Resend button invalidates previous tokens and sends new email"
    - "Expired/invalid tokens show helpful error message"
  artifacts:
    - path: "src/services/consentService.js"
      provides: "Edge Function invocation for email sending"
      contains: "supabase.functions.invoke"
    - path: "src/services/apiAuth.js"
      provides: "Fixed role detection queries"
      contains: "maybeSingle"
    - path: "src/pages/ConsentVerifyPage.jsx"
      provides: "Enhanced error handling"
      contains: "resend"
  key_links:
    - from: "src/services/consentService.js"
      to: "supabase/functions/send-consent-email"
      via: "supabase.functions.invoke"
      pattern: "invoke.*send-consent-email"
    - from: "src/services/apiAuth.js"
      to: "supabase.from('teachers')"
      via: "maybeSingle instead of single"
      pattern: "\\.maybeSingle\\(\\)"
---

<objective>
Integrate Edge Function with client code, fix 406 errors, and complete consent flow end-to-end.

Purpose: Wire up the email delivery so the full COPPA consent flow works from signup to account activation.
Output: Working end-to-end consent flow with fixed auth queries and proper error handling.
</objective>

<execution_context>
@C:\Users\pagis\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\pagis\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/05-parental-consent-email/05-RESEARCH.md
@.planning/phases/05-parental-consent-email/05-01-SUMMARY.md

# Files to modify
@src/services/consentService.js
@src/services/apiAuth.js
@src/pages/ConsentVerifyPage.jsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update consentService.js to call Edge Function</name>
  <files>src/services/consentService.js</files>
  <action>
Modify sendParentalConsentEmail() to invoke the Edge Function after creating the token:

1. After building consentUrl, call Edge Function:
```javascript
// Send email via Edge Function
const { data: emailResult, error: emailError } = await supabase.functions.invoke('send-consent-email', {
  body: {
    parentEmail,
    consentUrl,
    childName: 'your child' // Generic for privacy
  }
});

if (emailError) {
  console.error('Failed to send consent email:', emailError);
  // Don't throw - token was created successfully
  // Email failure should be logged but not block the flow
}
```

2. Remove the development-only console.log of consent URL (or gate it properly)

3. Add error handling for FunctionsHttpError, FunctionsRelayError, FunctionsFetchError:
```javascript
import { FunctionsHttpError, FunctionsRelayError, FunctionsFetchError } from '@supabase/supabase-js';
```

4. In resendConsentEmail(), ensure it also calls the Edge Function after creating new token

Do NOT:
- Remove the token creation logic (that stays as-is)
- Change the verifyParentalConsent function (already working)
- Expose implementation details in error messages to users
  </action>
  <verify>
1. grep for "supabase.functions.invoke" in consentService.js returns matches
2. grep for "send-consent-email" in consentService.js returns matches
3. Both sendParentalConsentEmail and resendConsentEmail call the Edge Function
  </verify>
  <done>
consentService.js updated to invoke Edge Function for email delivery in both send and resend flows.
  </done>
</task>

<task type="auto">
  <name>Task 2: Fix 406 errors in apiAuth.js</name>
  <files>src/services/apiAuth.js</files>
  <action>
Fix the 406 Not Acceptable errors by changing .single() to .maybeSingle() for role detection queries.

In getCurrentUser() function, find all instances of:
```javascript
.single();
```

Change to:
```javascript
.maybeSingle();
```

Specifically fix these queries (around lines 101-106 and 113-118, 128-132, 140-144):
1. Teacher role check: `await supabase.from("teachers").select("*").eq("id", user.id).single()`
2. Student role check: `await supabase.from("students").select("*").eq("id", user.id).single()`

After changing to .maybeSingle():
- Returns { data: null, error: null } when no rows found (instead of 406 error)
- Still returns { data: record, error: null } when exactly 1 row found
- Still returns error when multiple rows found (shouldn't happen with id PK)

The existing `if (teacherData && !teacherError)` checks will continue to work correctly because:
- With .maybeSingle(), data is null when no match, so teacherData is falsy
- The condition correctly falls through to check students table

Do NOT:
- Change the logic flow (if/else structure stays the same)
- Add new error handling (the existing checks are sufficient)
- Modify any other functions in apiAuth.js
  </action>
  <verify>
1. grep for ".single()" in apiAuth.js returns 0 matches in getCurrentUser function (may exist elsewhere)
2. grep for ".maybeSingle()" in apiAuth.js returns at least 4 matches (teacher/student checks)
3. No 406 errors appear when opening browser dev console and refreshing app
  </verify>
  <done>
All role detection queries in getCurrentUser() use .maybeSingle() eliminating 406 console errors.
  </done>
</task>

<task type="auto">
  <name>Task 3: Enhance error handling in ConsentVerifyPage</name>
  <files>src/pages/ConsentVerifyPage.jsx</files>
  <action>
Improve error messages and add resend suggestion:

1. Update error handling to provide more specific messages:
```javascript
} catch (err) {
  console.error('Consent verification failed:', err);
  setStatus('error');

  const errorMsg = err.message?.toLowerCase() || '';

  if (errorMsg.includes('expired')) {
    setError(t('consent.verify.expired', 'This verification link has expired. Please ask your child to send a new verification email from their PianoMaster account.'));
  } else if (errorMsg.includes('invalid') || errorMsg.includes('not found')) {
    setError(t('consent.verify.invalid', 'This verification link is invalid or has already been used. If you need a new link, your child can request one from their account.'));
  } else if (errorMsg.includes('network') || errorMsg.includes('fetch')) {
    setError(t('consent.verify.network', 'Unable to connect. Please check your internet connection and try again.'));
  } else {
    setError(t('consent.verify.genericError', 'Something went wrong. Please try again or contact support if the problem continues.'));
  }
}
```

2. In the error state UI, update suggestions to be more actionable:
```jsx
<ul className="text-sm text-white/70 space-y-1.5">
  <li>
    {t('consent.verify.suggestion1', '1. Have your child log in to PianoMaster and click "Resend Email"')}
  </li>
  <li>
    {t('consent.verify.suggestion2', '2. Check if you have a newer verification email')}
  </li>
  <li>
    {t('consent.verify.suggestion3', '3. Make sure you clicked the most recent email link')}
  </li>
</ul>
```

Do NOT:
- Change the success state rendering
- Modify the COPPA data collection summary
- Change the verification logic flow
  </action>
  <verify>
1. ConsentVerifyPage.jsx contains 'network' in error handling
2. ConsentVerifyPage.jsx contains 'Resend Email' in suggestions
3. File compiles without errors: npm run build completes successfully
  </verify>
  <done>
ConsentVerifyPage error handling improved with specific messages for expired, invalid, and network errors, plus actionable suggestions.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Complete parental consent email flow: Edge Function deployment, client integration, 406 fix, and error handling improvements</what-built>
  <how-to-verify>
**Prerequisites:**
- Resend account created with verified domain
- RESEND_API_KEY set in Supabase secrets: `supabase secrets set RESEND_API_KEY=re_xxx`
- Edge Function deployed: `supabase functions deploy send-consent-email`

**Test the full flow:**

1. **Test email sending:**
   - Create a test under-13 account or use existing one with `account_status = 'suspended_consent'`
   - Enter parent email and submit
   - Check parent email inbox within 30 seconds
   - Verify email has:
     - "PianoMaster" branding
     - Clear "Verify Consent" button
     - 7-day expiry notice
     - Renders correctly (no broken layout)

2. **Test consent verification:**
   - Click "Verify Consent" button in email
   - Should land on /consent/verify page
   - Should show success message
   - Child account should now be active

3. **Test error cases:**
   - Click same link again -> should show "already used" error
   - Modify token in URL -> should show "invalid" error
   - Wait 7 days (or manually expire token in DB) -> should show "expired" error

4. **Test 406 fix:**
   - Open browser dev tools console
   - Log out and log in as student
   - Log out and log in as teacher
   - Check console for any 406 errors -> should be NONE

5. **Test resend flow:**
   - For under-13 account awaiting consent
   - Click "Resend Email"
   - New email should arrive
   - Old link should show "invalid or used" error
   - New link should work
  </how-to-verify>
  <resume-signal>Type "approved" if all tests pass, or describe issues found</resume-signal>
</task>

</tasks>

<verification>
1. npm run build completes without errors
2. npm run lint shows no new errors in modified files
3. Console shows no 406 errors during auth flows
4. Email arrives within 30 seconds of request
5. Full consent flow works end-to-end
</verification>

<success_criteria>
- Parent receives branded email within 30 seconds of child requesting consent
- Email displays correctly in Gmail, Outlook, Apple Mail
- Clicking consent link activates child account
- No 406 errors in browser console
- Resend button works and invalidates previous tokens
- Expired/invalid token links show helpful error messages
</success_criteria>

<output>
After completion, create `.planning/phases/05-parental-consent-email/05-02-SUMMARY.md`
</output>
