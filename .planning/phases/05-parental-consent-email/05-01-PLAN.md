---
phase: 05-parental-consent-email
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - supabase/functions/send-consent-email/index.ts
autonomous: true
user_setup:
  - service: resend
    why: "Transactional email delivery"
    env_vars:
      - name: RESEND_API_KEY
        source: "Resend Dashboard (resend.com) -> API Keys -> Create API Key"
    dashboard_config:
      - task: "Verify sending domain"
        location: "Resend Dashboard -> Domains -> Add Domain -> Add DNS records"

must_haves:
  truths:
    - "Edge Function accepts email parameters and returns success/error"
    - "Email sent via Resend API with child-friendly HTML template"
    - "CORS headers allow browser invocation from app domain"
  artifacts:
    - path: "supabase/functions/send-consent-email/index.ts"
      provides: "Deno Edge Function for email delivery"
      contains: "Deno.serve"
    - path: "supabase/functions/send-consent-email/index.ts"
      provides: "HTML email template with inline CSS"
      contains: "Verify Consent"
  key_links:
    - from: "supabase/functions/send-consent-email/index.ts"
      to: "https://api.resend.com/emails"
      via: "fetch POST with Authorization header"
      pattern: "api\\.resend\\.com"
---

<objective>
Create Supabase Edge Function that sends parental consent verification emails via Resend API.

Purpose: Parents must receive email with verification link to activate under-13 child accounts (COPPA compliance).
Output: Edge Function deployable to Supabase with child-friendly HTML email template.
</objective>

<execution_context>
@C:\Users\pagis\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\pagis\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/05-parental-consent-email/05-RESEARCH.md

# Existing consent infrastructure
@src/services/consentService.js
@src/pages/ConsentVerifyPage.jsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Edge Function directory and index.ts</name>
  <files>supabase/functions/send-consent-email/index.ts</files>
  <action>
Create the Edge Function with these requirements:

1. Use modern Deno.serve() pattern (NOT deprecated serve import)
2. Accept JSON body: { parentEmail: string, consentUrl: string, childName?: string }
3. Handle CORS preflight (OPTIONS request)
4. Get RESEND_API_KEY from Deno.env.get()
5. Call Resend API via fetch():
   - POST to https://api.resend.com/emails
   - Authorization: Bearer ${RESEND_API_KEY}
   - from: "PianoMaster <noreply@pianomaster.app>" (or configured domain)
   - to: [parentEmail]
   - subject: "Your Child Needs Your Permission to Use PianoMaster"
   - html: generateConsentEmailHTML(consentUrl, childName)

6. Implement generateConsentEmailHTML() with:
   - Table-based layout (NOT flexbox/grid - Outlook compatibility)
   - Inline CSS only (email clients strip style tags)
   - Child-friendly branding (purple/indigo gradient feel, friendly tone)
   - Clear CTA button "Verify Consent" with consentUrl
   - 7-day expiry notice
   - Brief explanation of what PianoMaster is
   - Footer noting they can ignore if unexpected

7. Add 30-second timeout using AbortController for fetch

8. Return JSON response:
   - Success: { success: true, id: resendEmailId }
   - Error: { success: false, error: errorMessage }

CORS headers for all responses:
```
'Access-Control-Allow-Origin': '*',
'Access-Control-Allow-Methods': 'POST, OPTIONS',
'Access-Control-Allow-Headers': 'authorization, x-client-info, apikey, content-type'
```

Do NOT:
- Use deprecated `import { serve } from 'https://deno.land/std/http/server.ts'`
- Use external CSS or flexbox/grid in email template
- Expose API key in error messages
  </action>
  <verify>
1. File exists at supabase/functions/send-consent-email/index.ts
2. File contains Deno.serve() (modern pattern)
3. File contains 'api.resend.com/emails' (correct endpoint)
4. File contains table-based HTML layout
5. File contains 'Verify Consent' CTA text
6. File handles OPTIONS method for CORS
  </verify>
  <done>
Edge Function file created with Resend API integration and child-friendly HTML email template using table-based layout with inline CSS.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add local development environment setup</name>
  <files>supabase/functions/.env.example</files>
  <action>
Create .env.example file for Edge Function development:

```
# Resend API Key for sending consent emails
# Get from: https://resend.com/api-keys
RESEND_API_KEY=re_xxxxxxxxxx

# Optional: Override sender email (must be verified domain)
# SENDER_EMAIL=noreply@yourdomain.com
```

This file:
- Documents required environment variables
- Provides placeholder format for API key
- Does NOT contain real secrets
- Guides developers on where to get credentials
  </action>
  <verify>
1. File exists at supabase/functions/.env.example
2. File contains RESEND_API_KEY placeholder
3. File does NOT contain real API key (no 're_' followed by actual key)
  </verify>
  <done>
Environment example file created documenting required secrets for local development.
  </done>
</task>

</tasks>

<verification>
1. Edge Function structure follows Supabase conventions
2. Email template renders correctly (can test by copying HTML to browser)
3. No hardcoded secrets in committed files
4. CORS headers present for browser invocation
</verification>

<success_criteria>
- supabase/functions/send-consent-email/index.ts exists with complete implementation
- Edge Function uses Deno.serve() pattern
- HTML email template uses table layout with inline CSS
- Environment example documents required RESEND_API_KEY
- Code ready for deployment after user sets up Resend account
</success_criteria>

<output>
After completion, create `.planning/phases/05-parental-consent-email/05-01-SUMMARY.md`
</output>
