---
phase: 03-production-hardening
plan: 04
type: execute
wave: 2
depends_on: ["03-03"]
files_modified:
  - src/App.jsx
  - src/components/auth/LoginForm.jsx
  - src/components/games/notes-master-games/NotesRecognitionGame.jsx
  - src/components/games/sight-reading-game/SightReadingGame.jsx
  - src/components/games/rhythm-games/MetronomeTrainer.jsx
autonomous: true

must_haves:
  truths:
    - "SessionTimeoutProvider wraps authenticated parts of the app"
    - "Login page shows inactivity message when redirected from timeout"
    - "Timer pauses during active gameplay (exercise in-progress)"
    - "Timer resumes when game ends or user returns to settings"
  artifacts:
    - path: "src/App.jsx"
      provides: "SessionTimeoutProvider integration"
      contains: "SessionTimeoutProvider"
    - path: "src/components/auth/LoginForm.jsx"
      provides: "Inactivity logout message display"
      contains: "logoutReason"
  key_links:
    - from: "src/App.jsx"
      to: "src/contexts/SessionTimeoutContext.jsx"
      via: "import and render provider"
      pattern: "SessionTimeoutProvider"
    - from: "src/components/games/notes-master-games/NotesRecognitionGame.jsx"
      to: "useSessionTimeout"
      via: "pause/resume timer calls"
      pattern: "useSessionTimeout|pauseTimer|resumeTimer"
---

<objective>
Integrate the session timeout system into the app and game components.

Purpose: Complete the session timeout feature by wiring the provider into the app tree and ensuring games pause the timer during active gameplay.
Output: Working session timeout system that protects shared device users while not interrupting active practice.
</objective>

<execution_context>
@C:\Users\pagis\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\pagis\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/03-production-hardening/03-RESEARCH.md
@.planning/phases/03-production-hardening/03-03-SUMMARY.md

@src/App.jsx
@src/components/auth/LoginForm.jsx

Key decisions from context:
- Timer pauses during active exercise gameplay (not settings or victory screens)
- After logout: "You were logged out due to inactivity" message on login page
- Timer extends automatically during active game play
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add SessionTimeoutProvider to App.jsx</name>
  <files>src/App.jsx</files>
  <action>
Import and add SessionTimeoutProvider to the provider tree in App.jsx:

1. Import: `import { SessionTimeoutProvider } from './contexts/SessionTimeoutContext';`

2. Add the provider INSIDE QueryClientProvider but wrapping the authenticated content.
   It should be nested after AccessibilityProvider and SettingsProvider, but BEFORE ModalProvider.
   This ensures it has access to user auth state from QueryClient.

The provider tree order should be:
```jsx
<QueryClientProvider>
  <AccessibilityProvider>
    <SettingsProvider>
      <SessionTimeoutProvider>  {/* NEW */}
        <ModalProvider>
          <RhythmProvider>
            <SightReadingSessionProvider>
              {/* ... app content ... */}
            </SightReadingSessionProvider>
          </RhythmProvider>
        </ModalProvider>
      </SessionTimeoutProvider>
    </SettingsProvider>
  </AccessibilityProvider>
</QueryClientProvider>
```

The SessionTimeoutProvider internally handles the isAuthenticated check, so it's safe to wrap everything.
  </action>
  <verify>Check that import is added. Verify SessionTimeoutProvider is in the correct position in the tree.</verify>
  <done>SessionTimeoutProvider is integrated into the app's provider hierarchy.</done>
</task>

<task type="auto">
  <name>Task 2: Show inactivity message on login page</name>
  <files>src/components/auth/LoginForm.jsx</files>
  <action>
Add logic to display a message when user was logged out due to inactivity:

1. In the component, check sessionStorage for 'logoutReason' on mount:
   ```javascript
   const [logoutMessage, setLogoutMessage] = useState(null);

   useEffect(() => {
     const reason = sessionStorage.getItem('logoutReason');
     if (reason === 'inactivity') {
       setLogoutMessage('You were logged out due to inactivity');
       sessionStorage.removeItem('logoutReason'); // Clear it
     }
   }, []);
   ```

2. Render the message if present, above the login form:
   ```jsx
   {logoutMessage && (
     <div className="mb-4 p-3 bg-blue-50 border border-blue-200 rounded-lg text-blue-700 text-sm">
       {logoutMessage}
     </div>
   )}
   ```

Use a neutral/informational color (blue) rather than error (red) since this is expected behavior.
  </action>
  <verify>Check that sessionStorage is read on mount. Verify the message clears after showing.</verify>
  <done>Login page shows friendly inactivity message when applicable.</done>
</task>

<task type="auto">
  <name>Task 3: Integrate timer pause/resume in game components</name>
  <files>src/components/games/notes-master-games/NotesRecognitionGame.jsx, src/components/games/sight-reading-game/SightReadingGame.jsx, src/components/games/rhythm-games/MetronomeTrainer.jsx</files>
  <action>
For each game component, add timer pause/resume logic:

1. Import useSessionTimeout:
   ```javascript
   import { useSessionTimeout } from '../../../contexts/SessionTimeoutContext';
   // OR for SightReadingGame:
   import { useSessionTimeout } from '../../contexts/SessionTimeoutContext';
   ```

2. Get timer controls (with try-catch for when not in provider):
   ```javascript
   let pauseTimer = () => {};
   let resumeTimer = () => {};
   try {
     const sessionTimeout = useSessionTimeout();
     pauseTimer = sessionTimeout.pauseTimer;
     resumeTimer = sessionTimeout.resumeTimer;
   } catch (e) {
     // Not in SessionTimeoutProvider, timer controls are no-ops
   }
   ```

3. Pause timer when game starts/exercise begins:
   - In NotesRecognitionGame: pause when `gameState.isPlaying` becomes true
   - In SightReadingGame: pause when `sessionState === 'in-progress'`
   - In MetronomeTrainer: pause when `isPlaying` becomes true

4. Resume timer when game ends/exercise completes:
   - Resume when returning to settings/idle state
   - Resume when game session ends
   - Resume when component unmounts

Use useEffect for the pause/resume logic:
```javascript
useEffect(() => {
  if (isPlaying) {
    pauseTimer();
  } else {
    resumeTimer();
  }
  return () => resumeTimer(); // Always resume on unmount
}, [isPlaying, pauseTimer, resumeTimer]);
```

This ensures the inactivity timer doesn't log users out during active practice, but resumes when they stop playing.
  </action>
  <verify>Check that all three game components import useSessionTimeout. Verify pause/resume is called based on game state.</verify>
  <done>Game components pause inactivity timer during active gameplay.</done>
</task>

</tasks>

<verification>
1. SessionTimeoutProvider is imported and rendered in App.jsx
2. LoginForm shows "You were logged out due to inactivity" message when redirected from timeout
3. All three game components import and use useSessionTimeout
4. Timer pauses when games are actively playing
5. Timer resumes when games end or user leaves game

Manual testing checklist:
- [ ] Login as student, wait 25 minutes, see warning modal at 5 min remaining
- [ ] Click "Stay Logged In", timer resets
- [ ] Start a game, timer should pause (no warning during active play)
- [ ] End game, timer should resume
- [ ] Let timer expire, should redirect to login with message
</verification>

<success_criteria>
- Session timeout system is fully integrated and functional
- Users see warning before automatic logout
- Active gameplay doesn't trigger timeout
- Login page shows appropriate message after inactivity logout
</success_criteria>

<output>
After completion, create `.planning/phases/03-production-hardening/03-04-SUMMARY.md`
</output>
