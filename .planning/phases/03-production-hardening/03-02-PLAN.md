---
phase: 03-production-hardening
plan: 02
type: execute
wave: 2
depends_on: ["03-01"]
files_modified:
  - src/components/ui/RateLimitBanner.jsx
  - src/services/skillProgressService.js
  - src/services/apiScores.js
  - src/components/games/VictoryScreen.jsx
autonomous: true

must_haves:
  truths:
    - "Score submissions check rate limit before saving to database"
    - "Rate-limited students see 'Take a breather!' banner with countdown"
    - "Rate limit is per-node (students can play different nodes while rate-limited on one)"
    - "Teachers bypass rate limiting entirely (no check performed)"
  artifacts:
    - path: "src/components/ui/RateLimitBanner.jsx"
      provides: "Practice mode banner with countdown timer"
      contains: "Take a breather"
    - path: "src/services/skillProgressService.js"
      provides: "Rate-limited score saving"
      contains: "checkRateLimit"
  key_links:
    - from: "src/services/skillProgressService.js"
      to: "src/services/rateLimitService.js"
      via: "import and call checkRateLimit"
      pattern: "import.*rateLimitService"
    - from: "src/components/games/VictoryScreen.jsx"
      to: "RateLimitBanner"
      via: "conditional render when rate limited"
      pattern: "RateLimitBanner"
---

<objective>
Integrate rate limiting into the score submission flow and provide user feedback when rate-limited.

Purpose: Students need clear feedback when rate-limited, and the system must allow continued practice without saving scores. This maintains engagement while preventing XP farming.
Output: RateLimitBanner component, updated score services with rate limit checks, VictoryScreen integration.
</objective>

<execution_context>
@C:\Users\pagis\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\pagis\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/03-production-hardening/03-RESEARCH.md
@.planning/phases/03-production-hardening/03-01-SUMMARY.md

@src/services/skillProgressService.js
@src/services/apiScores.js
@src/components/games/VictoryScreen.jsx

Key decisions from context:
- "Take a breather! You can continue in X:XX" (child-friendly)
- "Practice Mode — scores won't be saved" banner
- Teachers have no rate limits (skip check entirely, not early return TRUE)
- Rate limit status hidden until hit (no proactive counter shown)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create RateLimitBanner component</name>
  <files>src/components/ui/RateLimitBanner.jsx</files>
  <action>
Install react-countdown first: `npm install react-countdown`

Create a banner component that shows when user is rate-limited:

```jsx
import React from 'react';
import Countdown from 'react-countdown';
import { Coffee } from 'lucide-react';

export default function RateLimitBanner({ resetTime, onComplete }) {
  // countdownRenderer: shows minutes:seconds, calls onComplete when done
  // Uses kidsWarning color scheme (yellow/amber) for friendly appearance
  // Shows:
  // - "Take a breather!" heading with star emoji
  // - "You can continue in M:SS" countdown
  // - "Practice Mode — scores won't be saved" note
  // - Coffee icon from lucide-react
}
```

Follow existing component patterns (see src/components/ui/ for styling conventions).
Use Tailwind classes matching the kids design system (kidsWarning-*, rounded-lg, etc.).
  </action>
  <verify>Check that react-countdown is in package.json. Verify component uses Countdown from react-countdown and exports default.</verify>
  <done>RateLimitBanner component renders countdown timer with friendly messaging.</done>
</task>

<task type="auto">
  <name>Task 2: Integrate rate limiting into score services</name>
  <files>src/services/skillProgressService.js, src/services/apiScores.js</files>
  <action>
Modify both services to check rate limit before saving scores:

**In skillProgressService.js:**

Add to updateNodeProgress and updateExerciseProgress functions:
1. Import { checkRateLimit } from './rateLimitService'
2. Before the database upsert, call checkRateLimit(studentId, nodeId)
3. If not allowed, return { rateLimited: true, resetTime } instead of saving
4. If allowed, proceed with existing logic

Note: These functions already have verifyStudentDataAccess which confirms the user.
Add a comment explaining that teachers are checked via caller (VictoryScreen).

**In apiScores.js:**

Add to updateStudentScore function:
1. Import { checkRateLimit } from './rateLimitService'
2. Add optional parameter nodeId (can be null for non-trail games)
3. If nodeId is provided, check rate limit before insert
4. If rate limited, return { rateLimited: true, resetTime, newScore: null }
5. If no nodeId (legacy/non-trail), skip rate check

Return types should include rateLimited boolean so callers know the outcome.
  </action>
  <verify>Check that both services import checkRateLimit. Verify return types include rateLimited field.</verify>
  <done>Score services check rate limit before saving and return rateLimited status.</done>
</task>

<task type="auto">
  <name>Task 3: Update VictoryScreen to handle rate limiting</name>
  <files>src/components/games/VictoryScreen.jsx</files>
  <action>
Modify VictoryScreen to:

1. Import RateLimitBanner from '../ui/RateLimitBanner'
2. Add state: rateLimited (boolean), resetTime (Date|null)
3. In the score saving effect/function:
   - Check if user is teacher (via useUser hook) - if so, skip rate limit entirely
   - For students, check the response from score service
   - If rateLimited: true, set state and show banner instead of success message
4. Conditionally render RateLimitBanner when rate limited:
   - Show banner at top of victory screen
   - Change success message to reflect practice mode
   - Keep "Back to Trail" / "Play Again" buttons functional
5. When countdown completes (onComplete), clear rateLimited state

The victory screen should still show the score/stars earned (for the current game), but indicate that the score wasn't saved due to rate limiting.

Important: Keep existing XP awarding logic but make it conditional on not being rate limited.
  </action>
  <verify>Check that RateLimitBanner is imported and rendered conditionally. Verify teachers skip rate limit check.</verify>
  <done>VictoryScreen shows rate limit banner when applicable and handles practice mode gracefully.</done>
</task>

</tasks>

<verification>
1. `npm ls react-countdown` shows it's installed
2. RateLimitBanner.jsx exists and exports default component
3. skillProgressService.js and apiScores.js import checkRateLimit
4. VictoryScreen.jsx imports RateLimitBanner and conditionally renders it
5. Rate limit check is skipped for teachers (isTeacher check before calling checkRateLimit)
</verification>

<success_criteria>
- Students see friendly rate limit banner when limit exceeded
- Score submissions are blocked at service layer when rate limited
- Teachers never encounter rate limiting
- Practice mode allows continued gameplay without score saving
</success_criteria>

<output>
After completion, create `.planning/phases/03-production-hardening/03-02-SUMMARY.md`
</output>
