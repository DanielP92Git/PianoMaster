---
phase: 03-production-hardening
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - src/hooks/useInactivityTimeout.js
  - src/components/ui/InactivityWarningModal.jsx
  - src/contexts/SessionTimeoutContext.jsx
autonomous: true

must_haves:
  truths:
    - "Inactivity timer runs with role-based duration (students 30min, teachers 2hr)"
    - "5-minute warning modal appears before automatic logout"
    - "Stay Logged In button resets the timer with single click"
    - "Timer syncs across browser tabs via BroadcastChannel"
  artifacts:
    - path: "src/hooks/useInactivityTimeout.js"
      provides: "React hook wrapping react-idle-timer"
      contains: "useIdleTimer"
    - path: "src/components/ui/InactivityWarningModal.jsx"
      provides: "Warning modal with countdown"
      contains: "Still there"
    - path: "src/contexts/SessionTimeoutContext.jsx"
      provides: "Context for session timeout state"
      exports: ["SessionTimeoutProvider", "useSessionTimeout"]
  key_links:
    - from: "src/hooks/useInactivityTimeout.js"
      to: "react-idle-timer"
      via: "import useIdleTimer"
      pattern: "import.*useIdleTimer.*react-idle-timer"
    - from: "src/contexts/SessionTimeoutContext.jsx"
      to: "src/hooks/useInactivityTimeout.js"
      via: "uses hook for timer logic"
      pattern: "useInactivityTimeout"
---

<objective>
Create the session timeout infrastructure using react-idle-timer for cross-tab synchronized inactivity detection.

Purpose: Automatic logout protects shared device users from forgotten sessions. 5-minute warning prevents frustrating mid-activity logouts.
Output: Inactivity timeout hook, warning modal component, and session context provider.
</objective>

<execution_context>
@C:\Users\pagis\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\pagis\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/03-production-hardening/03-RESEARCH.md

@src/features/authentication/useUser.js
@src/features/authentication/useLogout.js
@src/components/ui/Modal.jsx

Key decisions from context:
- Students: 30 minutes, Teachers: 2 hours
- Activity triggers: clicks and keypresses only (NOT mousemove)
- crossTab: true with leaderElection: true
- "Still there?" modal with countdown
- After logout: login page with "You were logged out due to inactivity"
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install react-idle-timer and create hook</name>
  <files>src/hooks/useInactivityTimeout.js</files>
  <action>
First install: `npm install react-idle-timer`

Create the hook:

```javascript
import { useIdleTimer } from 'react-idle-timer';
import { useState, useCallback } from 'react';

export function useInactivityTimeout({ isStudent, onLogout }) {
  // State for warning modal visibility
  const [showWarning, setShowWarning] = useState(false);

  // Calculate timeout based on role
  // Student: 30 minutes (30 * 60 * 1000 = 1,800,000 ms)
  // Teacher: 2 hours (2 * 60 * 60 * 1000 = 7,200,000 ms)
  const timeout = isStudent ? 30 * 60 * 1000 : 2 * 60 * 60 * 1000;
  const promptBeforeIdle = 5 * 60 * 1000; // 5 minutes warning

  // Handlers
  const handlePrompt = useCallback(() => setShowWarning(true), []);
  const handleIdle = useCallback(() => {
    setShowWarning(false);
    onLogout();
  }, [onLogout]);

  // Configure useIdleTimer
  const { getRemainingTime, activate, pause, start, isIdle } = useIdleTimer({
    timeout,
    promptBeforeIdle,
    onPrompt: handlePrompt,
    onIdle: handleIdle,
    events: ['click', 'keydown'], // Only clicks and keypress per requirements
    crossTab: true, // Sync across tabs
    leaderElection: true, // One tab coordinates
    throttle: 500, // Process events at most every 500ms
    startManually: false, // Auto-start
  });

  // Stay logged in handler
  const stayLoggedIn = useCallback(() => {
    setShowWarning(false);
    activate();
  }, [activate]);

  return {
    showWarning,
    timeRemaining: getRemainingTime(),
    stayLoggedIn,
    pauseTimer: pause,
    resumeTimer: start,
    activate,
    isIdle,
  };
}
```

The hook takes isStudent boolean and onLogout callback. Returns timer controls and warning state.
  </action>
  <verify>Check that react-idle-timer is in package.json. Verify hook imports useIdleTimer from 'react-idle-timer'.</verify>
  <done>useInactivityTimeout hook wraps react-idle-timer with role-based configuration.</done>
</task>

<task type="auto">
  <name>Task 2: Create InactivityWarningModal component</name>
  <files>src/components/ui/InactivityWarningModal.jsx</files>
  <action>
Create a modal component using the existing Modal component:

```jsx
import React, { useEffect, useState } from 'react';
import { Modal, ModalHeader, ModalTitle, ModalContent, ModalFooter } from './Modal';

export default function InactivityWarningModal({ isOpen, onStayLoggedIn, getRemainingTime }) {
  // State for countdown display
  const [remainingTime, setRemainingTime] = useState(getRemainingTime());

  // Update countdown every second while modal is open
  useEffect(() => {
    if (!isOpen) return;
    const interval = setInterval(() => {
      setRemainingTime(getRemainingTime());
    }, 1000);
    return () => clearInterval(interval);
  }, [isOpen, getRemainingTime]);

  // Format time as M:SS
  const formatTime = (ms) => {
    const totalSeconds = Math.max(0, Math.floor(ms / 1000));
    const minutes = Math.floor(totalSeconds / 60);
    const seconds = totalSeconds % 60;
    return `${minutes}:${seconds.toString().padStart(2, '0')}`;
  };

  return (
    <Modal
      isOpen={isOpen}
      closeOnOverlayClick={false}
      closeOnEscape={false}
      showCloseButton={false}
      size="default"
    >
      {/* Use ModalHeader, ModalTitle, ModalContent, ModalFooter */}
      {/* Title: "Still there?" */}
      {/* Content: "You'll be logged out in X:XX due to inactivity." */}
      {/* Subtext: "Click below to stay logged in and keep practicing!" */}
      {/* Footer: Large "Stay Logged In" button with primary styling */}
    </Modal>
  );
}
```

Use kidsPrimary color scheme for the countdown text.
Make the button large and prominent (min-h-touch for accessibility).
  </action>
  <verify>Check that Modal is imported from './Modal'. Verify countdown formatting produces M:SS format.</verify>
  <done>InactivityWarningModal shows countdown and Stay Logged In button.</done>
</task>

<task type="auto">
  <name>Task 3: Create SessionTimeoutContext</name>
  <files>src/contexts/SessionTimeoutContext.jsx</files>
  <action>
Create a context provider that:

1. Uses useUser hook to get isStudent/isTeacher
2. Uses useLogout hook to get logout function
3. Uses useInactivityTimeout hook with role-based config
4. Wraps child components and provides timer controls

```jsx
import React, { createContext, useContext, useEffect, useCallback } from 'react';
import { useUser } from '../features/authentication/useUser';
import { useLogout } from '../features/authentication/useLogout';
import { useInactivityTimeout } from '../hooks/useInactivityTimeout';
import { useNavigate } from 'react-router-dom';
import InactivityWarningModal from '../components/ui/InactivityWarningModal';

const SessionTimeoutContext = createContext(null);

export function SessionTimeoutProvider({ children }) {
  const { isStudent, isAuthenticated } = useUser();
  const { logout } = useLogout();
  const navigate = useNavigate();

  // Handle logout with inactivity message
  const handleInactivityLogout = useCallback(() => {
    logout();
    // Store flag for login page to show message
    sessionStorage.setItem('logoutReason', 'inactivity');
  }, [logout]);

  // Only run timer when authenticated
  const {
    showWarning,
    timeRemaining,
    stayLoggedIn,
    pauseTimer,
    resumeTimer,
    getRemainingTime,
  } = useInactivityTimeout({
    isStudent,
    onLogout: handleInactivityLogout,
  });

  // Context value for game components to pause/resume timer
  const value = {
    pauseTimer,
    resumeTimer,
    isTimerActive: isAuthenticated,
  };

  // Don't render modal or provide timer when not authenticated
  if (!isAuthenticated) {
    return (
      <SessionTimeoutContext.Provider value={{ pauseTimer: () => {}, resumeTimer: () => {}, isTimerActive: false }}>
        {children}
      </SessionTimeoutContext.Provider>
    );
  }

  return (
    <SessionTimeoutContext.Provider value={value}>
      {children}
      <InactivityWarningModal
        isOpen={showWarning}
        onStayLoggedIn={stayLoggedIn}
        getRemainingTime={getRemainingTime}
      />
    </SessionTimeoutContext.Provider>
  );
}

export function useSessionTimeout() {
  const context = useContext(SessionTimeoutContext);
  if (!context) {
    throw new Error('useSessionTimeout must be used within SessionTimeoutProvider');
  }
  return context;
}
```

The provider only activates when user is authenticated.
Games can use pauseTimer/resumeTimer from context to control timer during gameplay.
  </action>
  <verify>Check that all imports resolve. Verify provider conditionally renders based on isAuthenticated.</verify>
  <done>SessionTimeoutContext provides timer controls and renders warning modal.</done>
</task>

</tasks>

<verification>
1. `npm ls react-idle-timer` shows it's installed
2. useInactivityTimeout.js exports the hook with correct configuration
3. InactivityWarningModal.jsx uses existing Modal component and formats time
4. SessionTimeoutContext.jsx exports SessionTimeoutProvider and useSessionTimeout
5. Timer is only active when user is authenticated
</verification>

<success_criteria>
- react-idle-timer installed and configured correctly
- Timer uses role-based durations (30min student, 2hr teacher)
- Warning modal appears 5 minutes before logout
- Stay Logged In button resets timer with single click
- Timer syncs across browser tabs
</success_criteria>

<output>
After completion, create `.planning/phases/03-production-hardening/03-03-SUMMARY.md`
</output>
