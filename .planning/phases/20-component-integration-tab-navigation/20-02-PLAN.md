---
phase: 20-component-integration-tab-navigation
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/components/trail/TrailMap.jsx
autonomous: true

must_haves:
  truths:
    - "Tab switcher shows Treble/Bass/Rhythm buttons with only one path visible at a time"
    - "Active tab persists in URL query param (?path=treble) and supports browser back button"
    - "Tab buttons show path name and progress count (e.g., Treble 12/23)"
    - "Boss nodes are integrated into their respective category tabs (not separate section)"
    - "Keyboard navigation works with ArrowLeft/ArrowRight between tabs"
    - "TrailNodeModal functionality unchanged (click node -> details -> start practice)"
  artifacts:
    - path: "src/components/trail/TrailMap.jsx"
      provides: "Tab-based path switching with URL persistence and ARIA tablist"
      contains: "useSearchParams"
  key_links:
    - from: "src/components/trail/TrailMap.jsx"
      to: "react-router-dom"
      via: "useSearchParams hook"
      pattern: "searchParams.get.*path"
    - from: "src/components/trail/TrailMap.jsx"
      to: "src/data/skillTrail.js"
      via: "getNodesByCategory, getBossNodes"
      pattern: "getNodesByCategory|getBossNodes"
---

<objective>
Replace the three-paths-visible-at-once TrailMap layout with a tab-based switcher showing one path at a time. Active tab persists in URL (?path=treble), supports browser back button, has ARIA tablist pattern for accessibility, and shows progress counts per path.

Purpose: Mobile screens are too narrow for 3 parallel paths. Tabs focus attention on one learning path at a time, improving usability for 8-year-old learners.
Output: Restructured TrailMap.jsx with tab switcher, URL-persisted state, and boss node integration per category.
</objective>

<execution_context>
@C:/Users/pagis/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/pagis/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@src/components/trail/TrailMap.jsx
@src/data/skillTrail.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement tab switcher with URL persistence and ARIA pattern</name>
  <files>src/components/trail/TrailMap.jsx</files>
  <action>
Restructure TrailMap.jsx to show one path at a time with a tab switcher. This is a significant refactor of the component's render section.

**1. Add useSearchParams import:**
```jsx
import { useSearchParams } from 'react-router-dom';
```

**2. Define tab configuration constant (top of file, after imports):**
```jsx
const TRAIL_TABS = [
  { id: 'treble', label: 'Treble', categoryKey: 'TREBLE_CLEF' },
  { id: 'bass', label: 'Bass', categoryKey: 'BASS_CLEF' },
  { id: 'rhythm', label: 'Rhythm', categoryKey: 'RHYTHM' },
];
```

**3. Inside TrailMap component, add URL state:**
```jsx
const [searchParams, setSearchParams] = useSearchParams();
const activeTab = searchParams.get('path') || 'treble'; // Default to treble
```
- URL is single source of truth (NEVER duplicate in useState -- pitfall from research)

**4. Tab change handler:**
```jsx
const handleTabChange = (tabId) => {
  setSearchParams({ path: tabId });
};
```

**5. Keyboard navigation with useRef for tab focus management:**
```jsx
const tabRefs = useRef([]);

const handleTabKeyDown = (e, index) => {
  if (e.key === 'ArrowLeft') {
    e.preventDefault();
    const prevIndex = (index - 1 + TRAIL_TABS.length) % TRAIL_TABS.length;
    tabRefs.current[prevIndex]?.focus();
    handleTabChange(TRAIL_TABS[prevIndex].id);
  } else if (e.key === 'ArrowRight') {
    e.preventDefault();
    const nextIndex = (index + 1) % TRAIL_TABS.length;
    tabRefs.current[nextIndex]?.focus();
    handleTabChange(TRAIL_TABS[nextIndex].id);
  }
};
```

**6. Calculate progress per path (after existing node categorization):**
```jsx
const getPathProgress = (nodes) => {
  const completed = nodes.filter(n => completedNodeIds.includes(n.id)).length;
  return `${completed}/${nodes.length}`;
};
```

**7. Integrate boss nodes into their respective categories:**
Currently, boss nodes render as a separate 4th section. Instead, merge boss nodes into the category they belong to.

**IMPORTANT DATA MODEL FACT:** Boss nodes have `category: 'boss'` (NOT `treble_clef`/`bass_clef`/`rhythm`). They CANNOT be filtered by `NODE_CATEGORIES.TREBLE_CLEF` etc. However, boss nodes DO have:
- An `id` with prefix indicating their parent path: `boss_treble_1`, `boss_bass_2`, `boss_rhythm_3`, etc.
- A `unit` field matching the unit number they belong to (e.g., unit 1, 2, 3)
- They are already included within their unit's node array in `getNodesInUnit()` (see skillTrail.js line 333-337)

**The existing UnitSection/TrailSection already handles boss nodes correctly** because `TrailSection` groups nodes by `unit` field. Boss nodes share the same `unit` number as their parent category's unit, so they already appear inside the correct collapsible unit section. The separate "Boss Battles" section at the bottom of TrailMap is redundant.

**What to do:**
- Boss nodes are NOT returned by `getNodesByCategory(NODE_CATEGORIES.TREBLE_CLEF)` etc. since their category is `'boss'`.
- Map boss nodes to their parent path using the `id` prefix:
```jsx
const bossNodes = getBossNodes();

const trebleWithBoss = useMemo(() => {
  const trebleBosses = bossNodes.filter(b => b.id.startsWith('boss_treble'));
  return [...trebleNodes, ...trebleBosses].sort((a, b) => a.order - b.order);
}, [trebleNodes, bossNodes]);

const bassWithBoss = useMemo(() => {
  const bassBosses = bossNodes.filter(b => b.id.startsWith('boss_bass'));
  return [...bassNodes, ...bassBosses].sort((a, b) => a.order - b.order);
}, [bassNodes, bossNodes]);

const rhythmWithBoss = useMemo(() => {
  const rhythmBosses = bossNodes.filter(b => b.id.startsWith('boss_rhythm'));
  return [...rhythmNodes, ...rhythmBosses].sort((a, b) => a.order - b.order);
}, [rhythmNodes, bossNodes]);
```
- Remove the separate "Boss Battles" `<TrailSection>` block entirely.
- Use `trebleWithBoss`, `bassWithBoss`, `rhythmWithBoss` for tab content and progress counts.

**8. Render tab bar (LOCKED DECISIONS):**
- Filled pill/button style: active tab is filled rounded button with glass-morphism
- Inactive tabs: outlined/ghost style
- Tabs below header (Claude's discretion per research: below header, not bottom of viewport)
- Instant switch (Claude's discretion per research: no fade transition)
- Progress count shown under tab label

Tab bar JSX:
```jsx
<div role="tablist" aria-label={t('tabs.ariaLabel', { defaultValue: 'Learning paths' })} className="flex justify-center gap-2 px-4 py-3">
  {TRAIL_TABS.map((tab, index) => {
    const isActive = activeTab === tab.id;
    const nodes = tab.id === 'treble' ? trebleWithBoss :
                  tab.id === 'bass' ? bassWithBoss : rhythmWithBoss;
    // Note: these variables come from the boss merge logic in step 7
    const progress = getPathProgress(nodes);

    return (
      <button
        key={tab.id}
        ref={el => tabRefs.current[index] = el}
        role="tab"
        id={`${tab.id}-tab`}
        aria-selected={isActive}
        aria-controls={`${tab.id}-panel`}
        tabIndex={isActive ? 0 : -1}
        onKeyDown={(e) => handleTabKeyDown(e, index)}
        onClick={() => handleTabChange(tab.id)}
        className={`
          flex flex-col items-center px-5 py-2.5 rounded-full text-sm font-bold
          transition-colors
          ${isActive
            ? 'bg-white/15 backdrop-blur-sm border border-white/30 text-white shadow-lg'
            : 'bg-transparent border border-white/10 text-white/60 hover:text-white/80 hover:border-white/20'
          }
        `}
      >
        <span>{t(`tabs.${tab.id}`, { defaultValue: tab.label })}</span>
        <span className="text-[10px] font-normal opacity-70 mt-0.5">{progress}</span>
      </button>
    );
  })}
</div>
```

**9. Render active panel only (replace 3 simultaneous TrailSection renders):**
Remove the three separate TrailSection renders (treble, bass, rhythm) and the boss section.
Replace with a single panel that renders based on `activeTab`:

```jsx
<div
  id={`${activeTab}-panel`}
  role="tabpanel"
  aria-labelledby={`${activeTab}-tab`}
>
  {activeTab === 'treble' && (
    <TrailSection
      title={t('sections.trebleClef.title', { ns: 'trail' })}
      subtitle={t('sections.trebleClef.subtitle', { ns: 'trail' })}
      icon={<img src={trebleClefIcon} alt="" className="h-8 w-8 sm:h-12 sm:w-12 brightness-0 invert" />}
      nodes={trebleWithBoss}
      completedNodeIds={completedNodeIds}
      unlockedNodes={unlockedNodes}
      onNodeClick={setSelectedNode}
      getNodeProgress={getNodeProgress}
      findCurrentNode={findCurrentNode}
      category={NODE_CATEGORIES.TREBLE_CLEF}
      currentUnit={currentUnits.treble}
      t={t}
    />
  )}
  {/* Same for bass and rhythm */}
</div>
```

**10. Update the floating "Jump to Current" button:**
- Remove the 3-section ref logic (trebleSectionRef, bassSectionRef, rhythmSectionRef)
- Instead, the button can switch to the tab containing the most recently active node and scroll to top
- Or simplify: remove the button entirely since tabs already focus attention. (Claude's discretion: keep it but simplify to scroll-to-top behavior)

**11. Remove commented-out code:**
- Remove the commented-out progress summary banner
- Remove the commented-out reset progress button
- Keep the handleResetProgress function but keep it commented out

**Preserve existing behavior:**
- All data fetching (useEffect with getStudentProgress, etc.)
- getNodeProgress helper
- findCurrentNode helper
- selectedNode + TrailNodeModal rendering
- Loading state
- UnitSection and TrailSection sub-components stay unchanged internally
  </action>
  <verify>
Run `npm run build` to verify compilation. Navigate to /trail in dev mode:
1. Tab bar should show 3 tabs
2. Only one path visible at a time
3. Clicking tabs switches paths
4. URL should update to ?path=bass when clicking Bass tab
5. Browser back button should restore previous tab
6. Refresh should preserve current tab from URL
  </verify>
  <done>
TrailMap shows tab switcher with 3 filled-pill buttons. Only active path visible. URL persists tab selection via ?path= query param. Browser back/forward navigates tabs. ARIA tablist with keyboard navigation. Boss nodes merged into respective category tabs. Progress counts (e.g., "12/23") shown on each tab.
  </done>
</task>

</tasks>

<verification>
1. Navigate to /trail -- should see 3 tab buttons (Treble, Bass, Rhythm) with progress counts
2. Click Bass tab -- URL changes to /trail?path=bass, only bass nodes visible
3. Click browser back -- returns to previous tab
4. Refresh page -- same tab stays selected from URL
5. Press ArrowRight/ArrowLeft on keyboard -- tabs switch with focus management
6. Click a node -- TrailNodeModal opens normally
7. Boss nodes appear within their respective category tab (not as separate section)
</verification>

<success_criteria>
- Single path visible at a time via tab switching
- URL query param ?path= persists active tab
- Browser back/forward navigates between tabs
- ARIA tablist with proper aria-selected, aria-controls, tabIndex
- Keyboard navigation (ArrowLeft/ArrowRight) works
- Boss nodes integrated into category tabs
- TrailNodeModal works identically (no regression)
</success_criteria>

<output>
After completion, create `.planning/phases/20-component-integration-tab-navigation/20-02-SUMMARY.md`
</output>
