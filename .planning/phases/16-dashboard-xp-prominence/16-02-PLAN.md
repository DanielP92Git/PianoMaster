---
phase: 16-dashboard-xp-prominence
plan: 02
type: execute
wave: 2
depends_on: ["16-01"]
files_modified:
  - src/components/games/VictoryScreen.jsx
  - src/pages/TrailMapPage.jsx
autonomous: true

must_haves:
  truths:
    - "VictoryScreen shows XP gain with count-up animation from 0 to total over ~1 second"
    - "VictoryScreen shows mini XP progress bar that fills simultaneously with count-up"
    - "Level-up celebration triggers confetti only once per level (localStorage deduplication)"
    - "Trail map header shows compact XP summary (level icon + level name)"
    - "All animations respect AccessibilityContext reducedMotion setting"
  artifacts:
    - path: "src/components/games/VictoryScreen.jsx"
      provides: "XP count-up animation, mini progress bar, level-up celebration deduplication"
      contains: "useCountUp.*xpData"
    - path: "src/pages/TrailMapPage.jsx"
      provides: "Trail header with compact XP summary"
      contains: "getStudentXP|student-xp"
  key_links:
    - from: "src/components/games/VictoryScreen.jsx"
      to: "src/utils/levelUpTracking.js"
      via: "import and use for deduplication"
      pattern: "hasLevelBeenCelebrated|markLevelCelebrated"
    - from: "src/components/games/VictoryScreen.jsx"
      to: "src/utils/xpSystem.js"
      via: "getLevelProgress for mini bar calculations"
      pattern: "getLevelProgress"
    - from: "src/pages/TrailMapPage.jsx"
      to: "src/utils/xpSystem.js"
      via: "getStudentXP query for header display"
      pattern: "getStudentXP"
---

<objective>
Add XP count-up animation and mini progress bar to VictoryScreen, implement level-up celebration deduplication, and add compact XP summary to trail map header.

Purpose: Provide maximum visual feedback when XP is earned (rolling number + filling bar), ensure level-up celebrations only fire once per level, and keep XP visible while navigating the trail map.

Output: Modified VictoryScreen.jsx with XP animation + mini bar + level-up dedup, modified TrailMapPage.jsx with header XP summary.
</objective>

<execution_context>
@C:\Users\pagis\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\pagis\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/16-dashboard-xp-prominence/16-CONTEXT.md
@.planning/phases/16-dashboard-xp-prominence/16-RESEARCH.md
@.planning/phases/16-dashboard-xp-prominence/16-01-SUMMARY.md
@src/components/games/VictoryScreen.jsx
@src/pages/TrailMapPage.jsx
@src/utils/xpSystem.js
@src/utils/levelUpTracking.js
@src/utils/celebrationTiers.js
@src/components/celebrations/ConfettiEffect.jsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add XP count-up animation, mini progress bar, and level-up deduplication to VictoryScreen</name>
  <files>src/components/games/VictoryScreen.jsx</files>
  <action>
    Modify VictoryScreen.jsx to enhance the XP display section (currently lines ~735-788) with three additions:

    **1. XP Count-Up Animation:**
    Replace the static `+{xpData.totalXP} XP Earned` display with a count-up animation. Use the existing `useCountUp` hook already defined in VictoryScreen.jsx.

    Add near the top of the component (alongside other hooks):
    ```javascript
    const animatedXPGain = useCountUp(0, xpData?.totalXP || 0, 1000, !!xpData?.totalXP, reducedMotion);
    ```

    Then in the XP display section, replace:
    ```jsx
    <p className="text-sm font-bold text-blue-600 sm:text-base">
      +{xpData.totalXP} XP Earned
    </p>
    ```
    with:
    ```jsx
    <p className="text-sm font-bold text-blue-600 sm:text-base">
      +{animatedXPGain} XP Earned
    </p>
    ```

    **2. Mini XP Progress Bar:**
    After the XP breakdown section (after the bonus items and before the level-up indicator), add a compact progress bar showing the student's level progress after this XP gain.

    Use `getLevelProgress` from xpSystem.js to calculate progress. Import it if not already imported. Calculate progress based on `xpData.newTotalXP` (the post-award total).

    ```jsx
    {/* Mini XP progress bar - shows level context */}
    {xpData && !xpData.leveledUp && xpData.newTotalXP && (
      <div className="mt-2 space-y-1 rounded-lg bg-blue-50/80 p-2">
        <div className="flex items-center justify-between text-xs font-semibold text-blue-900">
          <span>{levelProgressData.currentLevel.title}</span>
          <span>Level {levelProgressData.currentLevel.level}</span>
        </div>
        <div className="h-2 w-full overflow-hidden rounded-full bg-blue-200">
          <div
            className={`h-full bg-gradient-to-r from-blue-500 to-indigo-600 ${
              reducedMotion ? 'transition-opacity duration-100' : 'transition-all duration-1000'
            }`}
            style={{ width: `${levelProgressData.progressPercentage}%` }}
          />
        </div>
        <div className="text-center text-xs text-blue-700">
          {levelProgressData.xpInCurrentLevel} / {levelProgressData.nextLevelXP - levelProgressData.currentLevel.xpRequired} XP
        </div>
      </div>
    )}
    ```

    Compute `levelProgressData` using a useMemo:
    ```javascript
    const levelProgressData = useMemo(() => {
      if (!xpData?.newTotalXP) return null;
      return getLevelProgress(xpData.newTotalXP);
    }, [xpData?.newTotalXP]);
    ```

    When `xpData.leveledUp` is true, HIDE the mini bar and show the full level-up celebration instead (the existing level-up indicator div).

    **3. Level-Up Celebration Deduplication:**
    Import `hasLevelBeenCelebrated` and `markLevelCelebrated` from `../../utils/levelUpTracking.js` (created in Plan 16-01).

    Add a useEffect AFTER the existing confetti trigger effect (the one that checks `isProcessingTrail` and `celebrationData.config.confetti`). This new effect handles level-up-specific confetti:

    ```javascript
    // Level-up celebration with deduplication
    useEffect(() => {
      if (!xpData?.leveledUp || !user?.id) return;
      if (reducedMotion) return;

      // Check if this level was already celebrated
      if (hasLevelBeenCelebrated(user.id, xpData.newLevel)) {
        return;
      }

      // Show confetti for level-up (this may already be showing from the tier-based trigger)
      setShowConfetti(true);

      // Mark as celebrated so it doesn't repeat
      markLevelCelebrated(user.id, xpData.newLevel);
    }, [xpData?.leveledUp, xpData?.newLevel, user?.id, reducedMotion]);
    ```

    Also enhance the existing level-up indicator div. Replace:
    ```jsx
    {xpData.leveledUp && (
      <div className={`${reducedMotion ? '' : 'animate-bounce'} mt-1 rounded-lg bg-gradient-to-r from-purple-500 to-pink-500 px-2 py-1 text-center text-xs font-bold text-white shadow-lg`}>
        Level {xpData.newLevel}!
      </div>
    )}
    ```
    With an enhanced version that shows the level name:
    ```jsx
    {xpData.leveledUp && (
      <div className={`${reducedMotion ? '' : 'animate-bounce'} mt-2 rounded-lg bg-gradient-to-r from-purple-500 to-pink-500 px-3 py-2 text-center shadow-lg`}>
        <div className="text-xs font-semibold text-white/90">Level Up!</div>
        <div className="text-base font-bold text-white">
          {getLevelProgress(xpData.newTotalXP)?.currentLevel?.title || `Level ${xpData.newLevel}`}
        </div>
      </div>
    )}
    ```

    **Important notes:**
    - Do NOT modify the existing celebration tier confetti trigger (the one gated by `isProcessingTrail` and `celebrationData.config.confetti`). The level-up dedup effect is ADDITIONAL to it.
    - The `useCountUp` hook is already defined at the top of VictoryScreen.jsx. Do NOT redefine it. Just call it with xpData values.
    - Make sure `getLevelProgress` is imported from xpSystem.js. Check current imports â€” `calculateSessionXP` and `awardXP` are imported but `getLevelProgress` may not be.
    - The mini XP bar should only show when xpData exists, has a positive totalXP, and the user did NOT level up (if they leveled up, the celebration banner replaces it).
  </action>
  <verify>
    - `npm run lint` passes with no errors
    - Grep for `hasLevelBeenCelebrated` and `markLevelCelebrated` in VictoryScreen.jsx
    - Grep for `getLevelProgress` import in VictoryScreen.jsx
    - Grep for `animatedXPGain` in VictoryScreen.jsx
    - `npm run build` completes without errors
  </verify>
  <done>
    VictoryScreen shows XP gain with count-up animation, displays mini progress bar below XP breakdown, and deduplicates level-up celebrations via localStorage.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add compact XP summary to Trail Map header</name>
  <files>src/pages/TrailMapPage.jsx</files>
  <action>
    Add a compact XP summary to the TrailMapPage navigation bar, in the right area alongside the existing "Free Practice" link.

    **Imports to add:**
    ```javascript
    import { useQuery } from '@tanstack/react-query';
    import { useUser } from '../features/authentication/useUser';
    import { getStudentXP } from '../utils/xpSystem';
    ```

    **Data fetching:** Inside the TrailMapPage component, add:
    ```javascript
    const { user } = useUser();
    const { data: xpData } = useQuery({
      queryKey: ['student-xp', user?.id],
      queryFn: () => getStudentXP(user.id),
      enabled: !!user?.id,
      staleTime: 60 * 1000, // 1 minute
    });
    ```

    **UI addition:** In the navigation bar div (the one with `mx-auto flex max-w-6xl items-center justify-between p-4`), modify the right side to include an XP summary BEFORE the "Free Practice" link.

    Replace the right-side Free Practice link with a flex container:
    ```jsx
    <div className={`flex items-center gap-3 ${isRTL ? 'flex-row-reverse' : ''}`}>
      {/* Compact XP display */}
      {xpData && (
        <div className="flex items-center gap-1.5 rounded-lg bg-white/10 px-2.5 py-1 text-sm">
          <span>{xpData.levelData.icon}</span>
          <span className="font-semibold text-white/90">{xpData.levelData.title}</span>
        </div>
      )}
      <Link
        to="/practice-modes"
        className="rounded-lg bg-white/10 px-3 py-1.5 text-sm text-white/70 transition-colors hover:bg-white/15 hover:text-white"
      >
        {t('freePracticeLink', { ns: 'trail' })}
      </Link>
    </div>
    ```

    This keeps the design minimal â€” just the level emoji icon + level name (e.g., "ðŸŽµ Note Finder"). No progress bar or XP numbers in the trail header â€” that level of detail belongs on the Dashboard XP card.

    The XP display gracefully handles loading state by not rendering until xpData is available (no flash of empty content).
  </action>
  <verify>
    - `npm run lint` passes with no errors
    - `npm run build` completes without errors
    - Grep for `getStudentXP` in TrailMapPage.jsx confirms XP data fetching
    - Grep for `levelData.title` in TrailMapPage.jsx confirms level name display
  </verify>
  <done>
    Trail map header shows compact XP summary with level icon and level name alongside the Free Practice link.
  </done>
</task>

</tasks>

<verification>
1. `npm run lint` passes with no errors
2. `npm run build` completes successfully
3. VictoryScreen.jsx uses `useCountUp` for XP gain animation (grep for `animatedXPGain`)
4. VictoryScreen.jsx has mini XP progress bar with `getLevelProgress` (grep for `levelProgressData`)
5. VictoryScreen.jsx imports and uses `hasLevelBeenCelebrated`/`markLevelCelebrated`
6. TrailMapPage.jsx imports `getStudentXP` and displays level name in header
7. All animations gated by `reducedMotion` check
</verification>

<success_criteria>
- VictoryScreen XP display animates from 0 to total over ~1 second (count-up effect)
- VictoryScreen shows mini progress bar below XP breakdown (not during level-up)
- Level-up confetti only fires once per level (localStorage deduplication)
- Level-up indicator shows new level name, not just number
- Trail map header shows level icon + level name in compact display
- All animations respect reducedMotion setting
- Build completes without errors
</success_criteria>

<output>
After completion, create `.planning/phases/16-dashboard-xp-prominence/16-02-SUMMARY.md`
</output>
