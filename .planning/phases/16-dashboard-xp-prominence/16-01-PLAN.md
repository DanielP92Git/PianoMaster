---
phase: 16-dashboard-xp-prominence
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/utils/levelUpTracking.js
  - src/components/dashboard/XPProgressCard.jsx
  - src/components/layout/Dashboard.jsx
autonomous: true

must_haves:
  truths:
    - "Dashboard displays XP progress bar showing current level title prominently (e.g., 'Apprentice')"
    - "Dashboard shows 'X XP to next level' indicator below progress bar"
    - "Dashboard shows current XP / threshold display (e.g., '200 / 350 XP')"
    - "XP card respects AccessibilityContext reducedMotion setting"
    - "Dashboard badge animates on first visit after level change (not every page load)"
  artifacts:
    - path: "src/utils/levelUpTracking.js"
      provides: "localStorage-based level-up celebration deduplication"
      exports: ["getCelebratedLevels", "markLevelCelebrated", "hasLevelBeenCelebrated", "getLastSeenLevel", "setLastSeenLevel"]
    - path: "src/components/dashboard/XPProgressCard.jsx"
      provides: "XP progress card component with level identity, progress bar, and XP stats"
      min_lines: 80
    - path: "src/components/layout/Dashboard.jsx"
      provides: "Dashboard with XPProgressCard integrated between Continue Learning and Daily Goals"
  key_links:
    - from: "src/components/dashboard/XPProgressCard.jsx"
      to: "src/utils/xpSystem.js"
      via: "getStudentXP() query"
      pattern: "getStudentXP"
    - from: "src/components/dashboard/XPProgressCard.jsx"
      to: "src/utils/levelUpTracking.js"
      via: "badge animation trigger"
      pattern: "getLastSeenLevel|setLastSeenLevel"
    - from: "src/components/layout/Dashboard.jsx"
      to: "src/components/dashboard/XPProgressCard.jsx"
      via: "import and render"
      pattern: "XPProgressCard"
---

<objective>
Create the Dashboard XP Progress Card and level-up tracking utility.

Purpose: Make the XP system visible and motivating on the Dashboard. The child should see their level title prominently ("Apprentice"), a Duolingo-style horizontal fill bar showing XP progress, current/threshold XP numbers, and XP-to-next-level count. When they level up, the card badge should pulse/animate once on first dashboard visit.

Output: New `levelUpTracking.js` utility, new `XPProgressCard.jsx` component, and updated `Dashboard.jsx` with XP card integrated.
</objective>

<execution_context>
@C:\Users\pagis\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\pagis\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/16-dashboard-xp-prominence/16-CONTEXT.md
@.planning/phases/16-dashboard-xp-prominence/16-RESEARCH.md
@src/utils/xpSystem.js
@src/components/dashboard/DailyGoalsCard.jsx
@src/components/layout/Dashboard.jsx
@src/contexts/AccessibilityContext.jsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create levelUpTracking utility and XPProgressCard component</name>
  <files>src/utils/levelUpTracking.js, src/components/dashboard/XPProgressCard.jsx</files>
  <action>
    **Create `src/utils/levelUpTracking.js`:**
    A small localStorage utility for tracking level-up celebration state per user. Based on the same pattern used by VictoryScreen's accessory unlock tracking (`SHOWN_UNLOCKS_VERSION`). Functions:
    - `getCelebratedLevels(userId)` - Returns array of level numbers already celebrated
    - `markLevelCelebrated(userId, level)` - Adds level to celebrated array
    - `hasLevelBeenCelebrated(userId, level)` - Boolean check
    - `getLastSeenLevel(userId)` - Returns the last level number the user saw on dashboard (for badge animation trigger)
    - `setLastSeenLevel(userId, level)` - Updates last seen level

    Storage keys: `celebrated-levels-${userId}-v1` and `last-seen-level-${userId}`. Include version constant for cache invalidation.

    **Create `src/components/dashboard/XPProgressCard.jsx`:**
    A dedicated XP card component matching DailyGoalsCard's visual weight. Follow the card styling from DailyGoalsCard.jsx (rounded-3xl, border-white/10, bg-white/5, shadow, backdrop-blur-md pattern).

    Component structure:
    1. **Header row:** "Your Progress" title on left, level badge icon on right (use the emoji from `XP_LEVELS[].icon` inside a color-coded rounded-full gradient badge)
    2. **Level name headline:** Large text centered, e.g., "Note Finder" (the child's identity). Use `text-2xl font-bold text-white` styling. This is THE focal point.
    3. **Level subtext:** Small "Level 3" beneath the title
    4. **Horizontal progress bar:** `h-3 w-full overflow-hidden rounded-full bg-white/20` container with gradient fill (`from-blue-400 to-indigo-600`). Width = `progressPercentage%`. Gate animation: use `transition-all duration-500` when `!reducedMotion`, use `transition-opacity duration-100` when `reducedMotion`.
    5. **XP stats row:** Left: "{xpInCurrentLevel} / {nextLevelXP - currentLevelXP} XP", Right: "{xpNeededForNext} XP to Level {level+1}"
    6. **Max level handling:** When at level 15, show "MAX LEVEL" and 100% bar

    Data fetching: Use TanStack Query with key `['student-xp', user?.id]` and `getStudentXP(user.id)` from xpSystem.js. Set `staleTime: 0` and `refetchInterval: 60 * 1000` for fresh data.

    Level badge color progression (colorblind-safe):
    - Levels 1-3: `from-gray-400 to-gray-500` (Bronze/starter)
    - Levels 4-6: `from-blue-400 to-blue-600` (Silver)
    - Levels 7-9: `from-amber-400 to-amber-600` (Gold)
    - Levels 10-12: `from-purple-400 to-purple-600` (Platinum)
    - Levels 13-15: `from-pink-400 via-purple-500 to-indigo-600` (Legend/Rainbow)

    Badge animation trigger: On mount, compare `getLastSeenLevel(userId)` with current level. If different (level changed since last dashboard visit), apply a CSS pulse animation (2 pulses of `animate-pulse` or `animate-bounce`, then stop). After animation, call `setLastSeenLevel(userId, currentLevel)`. If `reducedMotion`, skip animation entirely and just update localStorage.

    Loading state: Return a shimmer skeleton matching the card dimensions (same pattern as DailyGoalsCard loading state).

    Props: None needed — component fetches its own data via useUser + useQuery.

    Import `useAccessibility` from AccessibilityContext. Import `useUser` from features/authentication. Import `useTranslation` from react-i18next. Import `useQuery` from @tanstack/react-query. Import `getStudentXP`, `getLevelProgress`, `XP_LEVELS` from xpSystem.js. Import `getLastSeenLevel`, `setLastSeenLevel` from levelUpTracking.js.
  </action>
  <verify>
    - `npm run lint` passes with no errors
    - The component file imports all dependencies correctly
    - levelUpTracking.js exports all 5 functions
  </verify>
  <done>
    XPProgressCard renders level name, progress bar, XP stats, and badge with color progression. levelUpTracking.js provides localStorage utilities for deduplication.
  </done>
</task>

<task type="auto">
  <name>Task 2: Integrate XPProgressCard into Dashboard</name>
  <files>src/components/layout/Dashboard.jsx</files>
  <action>
    Add XPProgressCard to the student Dashboard layout.

    **Import:** Add `import XPProgressCard from '../dashboard/XPProgressCard';` at the top of Dashboard.jsx alongside DailyGoalsCard import.

    **Placement:** Insert XPProgressCard between the "Continue Learning" section and the "Daily Goals" section. This gives it equal visual prominence. The XP card should only render for students (`isStudent`).

    Add it as a new section:
    ```jsx
    {/* XP Progress Section (only for students) */}
    {isStudent && (
      <section>
        <XPProgressCard />
      </section>
    )}
    ```

    Place this block AFTER the Continue Learning `<section>` block (around line 647) and BEFORE the Daily Goals `<section>` block (around line 650).

    **No other changes needed** — XPProgressCard is self-contained (fetches its own data, handles loading state).

    **Do NOT modify** the existing Level Card in the stats grid (the one using `iconCrown` and `getLevelInfo`). That existing card uses the old points-based leveling. It can be replaced in a future cleanup phase, but for now both can coexist — the XP card shows the real XP-based level prominently at the top, while the old level card in the stats grid provides legacy consistency.
  </action>
  <verify>
    - `npm run lint` passes
    - `npm run build` completes without errors
    - Verify with grep that Dashboard.jsx imports XPProgressCard and renders it
  </verify>
  <done>
    Dashboard displays XPProgressCard between Continue Learning and Daily Goals sections for students. XP progress bar, level name, and XP stats are visible.
  </done>
</task>

</tasks>

<verification>
1. `npm run lint` passes with no errors
2. `npm run build` completes successfully
3. `src/utils/levelUpTracking.js` exists and exports getCelebratedLevels, markLevelCelebrated, hasLevelBeenCelebrated, getLastSeenLevel, setLastSeenLevel
4. `src/components/dashboard/XPProgressCard.jsx` exists and imports from xpSystem.js and levelUpTracking.js
5. `src/components/layout/Dashboard.jsx` imports and renders XPProgressCard for students
6. XPProgressCard uses `useAccessibility()` for reducedMotion
7. XPProgressCard uses TanStack Query with key `['student-xp', user?.id]`
</verification>

<success_criteria>
- Dashboard shows a dedicated XP card with the student's level title as headline text
- XP card shows horizontal progress bar with gradient fill
- XP card shows "X / Y XP" and "Z XP to Level N" indicators
- Badge animation only triggers on level change, not every page load
- All animations respect AccessibilityContext reducedMotion
- Build completes without errors
</success_criteria>

<output>
After completion, create `.planning/phases/16-dashboard-xp-prominence/16-01-SUMMARY.md`
</output>
