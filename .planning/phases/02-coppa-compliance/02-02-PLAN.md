---
phase: 02-coppa-compliance
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/components/auth/AgeGate.jsx
  - src/utils/ageUtils.js
autonomous: true

must_haves:
  truths:
    - "User can select month, day, year from dropdown menus"
    - "Component calculates age from selected DOB"
    - "Component calls onSubmit callback with DOB data and isUnder13 flag"
  artifacts:
    - path: "src/components/auth/AgeGate.jsx"
      provides: "DOB collection UI component"
      min_lines: 50
    - path: "src/utils/ageUtils.js"
      provides: "Age calculation utilities"
      exports: ["calculateAge", "isUnder13"]
  key_links:
    - from: "AgeGate.jsx"
      to: "ageUtils.js"
      via: "import"
      pattern: "import.*from.*ageUtils"
---

<objective>
Create the Age Gate UI component with DOB dropdowns (Month/Day/Year) for COPPA-compliant age verification during registration.

Purpose: COPPA requires neutral DOB collection (not "Are you 13?" checkbox) before account creation
Output: Reusable AgeGate component, age calculation utilities
</objective>

<execution_context>
@C:\Users\pagis\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\pagis\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/02-coppa-compliance/02-CONTEXT.md
@.planning/phases/02-coppa-compliance/02-RESEARCH.md
@src/components/auth/SignupForm.jsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Age Calculation Utilities</name>
  <files>src/utils/ageUtils.js</files>
  <action>
Create utility functions for age calculation:

```javascript
/**
 * Calculate age in years from a birth date
 * @param {Date} birthDate - The date of birth
 * @returns {number} Age in years
 */
export function calculateAge(birthDate) {
  const today = new Date();
  let age = today.getFullYear() - birthDate.getFullYear();
  const monthDiff = today.getMonth() - birthDate.getMonth();

  // Adjust if birthday hasn't occurred yet this year
  if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birthDate.getDate())) {
    age--;
  }

  return age;
}

/**
 * Check if a person is under 13 years old
 * @param {Date} birthDate - The date of birth
 * @returns {boolean} True if under 13
 */
export function isUnder13(birthDate) {
  return calculateAge(birthDate) < 13;
}

/**
 * Format DOB parts into a Date object
 * @param {{month: number, day: number, year: number}} dob - DOB parts
 * @returns {Date} Date object
 */
export function dobPartsToDate({ month, day, year }) {
  return new Date(year, month - 1, day);
}

/**
 * Validate DOB parts are reasonable
 * @param {{month: number, day: number, year: number}} dob - DOB parts
 * @returns {boolean} True if valid
 */
export function isValidDOB({ month, day, year }) {
  if (!month || !day || !year) return false;
  const date = dobPartsToDate({ month, day, year });
  const today = new Date();

  // Check date is valid and in the past
  return date instanceof Date &&
         !isNaN(date) &&
         date < today &&
         date.getFullYear() > today.getFullYear() - 120; // Reasonable age limit
}
```
  </action>
  <verify>
File exists at src/utils/ageUtils.js with exports: calculateAge, isUnder13, dobPartsToDate, isValidDOB
  </verify>
  <done>
Age utilities exist and handle edge cases (leap years, birthday not yet occurred this year).
  </done>
</task>

<task type="auto">
  <name>Task 2: Create AgeGate Component</name>
  <files>src/components/auth/AgeGate.jsx</files>
  <action>
Create the AgeGate component with three dropdown selectors:

```jsx
import { useState } from 'react';
import { dobPartsToDate, isUnder13, isValidDOB } from '../../utils/ageUtils';

const MONTHS = [
  'January', 'February', 'March', 'April', 'May', 'June',
  'July', 'August', 'September', 'October', 'November', 'December'
];

/**
 * Age Gate component for COPPA-compliant DOB collection
 * @param {Object} props
 * @param {Function} props.onSubmit - Called with { dob: Date, isUnder13: boolean }
 * @param {Function} props.onBack - Optional back button handler
 * @param {boolean} props.disabled - Disable inputs during submission
 */
export function AgeGate({ onSubmit, onBack, disabled = false }) {
  const [month, setMonth] = useState('');
  const [day, setDay] = useState('');
  const [year, setYear] = useState('');
  const [error, setError] = useState(null);

  const currentYear = new Date().getFullYear();
  const years = Array.from({ length: 100 }, (_, i) => currentYear - i);
  const days = Array.from({ length: 31 }, (_, i) => i + 1);

  const handleSubmit = (e) => {
    e.preventDefault();
    setError(null);

    const dob = {
      month: parseInt(month),
      day: parseInt(day),
      year: parseInt(year)
    };

    if (!isValidDOB(dob)) {
      setError('Please enter a valid date of birth');
      return;
    }

    const birthDate = dobPartsToDate(dob);
    onSubmit({
      dob: birthDate,
      isUnder13: isUnder13(birthDate)
    });
  };

  // Base input classes matching existing auth form styling
  const selectClass = `w-full px-2.5 md:px-3 py-1.5 md:py-2 text-sm rounded-lg border-2
    border-white/20 bg-white/15 backdrop-blur-sm focus:bg-white/25
    focus:ring-2 focus:ring-indigo-500 focus:border-indigo-400/50
    transition-all duration-300 text-white`;

  return (
    <form onSubmit={handleSubmit} className="space-y-4">
      <div className="text-center mb-2">
        <p className="text-white/90 text-sm">
          When is your birthday?
        </p>
      </div>

      {error && (
        <div className="p-2 text-xs text-red-200 bg-red-500/10 border border-red-200/20 rounded-lg">
          {error}
        </div>
      )}

      <div className="grid grid-cols-3 gap-2">
        <select
          value={month}
          onChange={(e) => setMonth(e.target.value)}
          className={selectClass}
          disabled={disabled}
          required
          aria-label="Birth month"
        >
          <option value="">Month</option>
          {MONTHS.map((m, i) => (
            <option key={m} value={i + 1}>{m}</option>
          ))}
        </select>

        <select
          value={day}
          onChange={(e) => setDay(e.target.value)}
          className={selectClass}
          disabled={disabled}
          required
          aria-label="Birth day"
        >
          <option value="">Day</option>
          {days.map(d => (
            <option key={d} value={d}>{d}</option>
          ))}
        </select>

        <select
          value={year}
          onChange={(e) => setYear(e.target.value)}
          className={selectClass}
          disabled={disabled}
          required
          aria-label="Birth year"
        >
          <option value="">Year</option>
          {years.map(y => (
            <option key={y} value={y}>{y}</option>
          ))}
        </select>
      </div>

      <div className="flex gap-2">
        {onBack && (
          <button
            type="button"
            onClick={onBack}
            disabled={disabled}
            className="flex-1 py-2 text-sm text-white/80 hover:text-white border-2 border-white/20 rounded-lg transition-colors"
          >
            Back
          </button>
        )}
        <button
          type="submit"
          disabled={disabled}
          className="flex-1 py-2 text-sm font-medium text-white bg-indigo-600 rounded-lg hover:bg-indigo-700 transition-colors disabled:opacity-50"
        >
          Continue
        </button>
      </div>
    </form>
  );
}

export default AgeGate;
```

Style the component to match existing auth forms (see SignupForm.jsx for patterns).
Use Tailwind classes consistent with the app's design system.
  </action>
  <verify>
File exists at src/components/auth/AgeGate.jsx.
Component imports from ageUtils.js.
Has three select elements for month, day, year.
Calls onSubmit with { dob, isUnder13 } on form submission.
  </verify>
  <done>
AgeGate component renders three dropdowns, validates input, calculates age, and returns DOB data with under-13 flag.
  </done>
</task>

</tasks>

<verification>
- [ ] src/utils/ageUtils.js exports calculateAge, isUnder13, dobPartsToDate, isValidDOB
- [ ] src/components/auth/AgeGate.jsx exists and exports AgeGate component
- [ ] AgeGate imports from ageUtils.js
- [ ] Component has accessible labels (aria-label on selects)
- [ ] Styling matches existing auth forms
</verification>

<success_criteria>
AgeGate component can be integrated into signup flow to collect DOB before account creation. Returns both the date and an isUnder13 boolean for routing decisions.
</success_criteria>

<output>
After completion, create `.planning/phases/02-coppa-compliance/02-02-SUMMARY.md`
</output>
