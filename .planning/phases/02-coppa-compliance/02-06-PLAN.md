---
phase: 02-coppa-compliance
plan: 06
type: execute
wave: 4
depends_on: ["02-04", "02-05"]
files_modified:
  - src/components/auth/ParentalConsentPending.jsx
  - src/hooks/useAccountStatus.js
  - src/pages/ConsentVerifyPage.jsx
  - src/App.jsx
autonomous: false

must_haves:
  truths:
    - "Suspended students see child-friendly waiting message instead of app"
    - "Parents can click email link to verify consent"
    - "After verification, student account becomes active"
    - "Route guard prevents suspended accounts from accessing app features"
  artifacts:
    - path: "src/components/auth/ParentalConsentPending.jsx"
      provides: "Child-friendly suspended account UI"
      min_lines: 40
    - path: "src/hooks/useAccountStatus.js"
      provides: "Account status check hook"
      exports: ["useAccountStatus"]
    - path: "src/pages/ConsentVerifyPage.jsx"
      provides: "Parent consent verification page"
      min_lines: 50
  key_links:
    - from: "App.jsx"
      to: "useAccountStatus"
      via: "route guard"
      pattern: "useAccountStatus"
    - from: "ConsentVerifyPage"
      to: "consentService"
      via: "verifyParentalConsent"
      pattern: "verifyParentalConsent"
---

<objective>
Create the suspended account experience for children awaiting parental consent, and the verification page parents use to approve accounts.

Purpose: Children must not use app until parent consents; parents need clear verification flow
Output: Suspended UI, account status hook, consent verification page, route integration
</objective>

<execution_context>
@C:\Users\pagis\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\pagis\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/02-coppa-compliance/02-CONTEXT.md
@.planning/phases/02-coppa-compliance/02-04-SUMMARY.md
@.planning/phases/02-coppa-compliance/02-05-SUMMARY.md
@src/App.jsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Account Status Hook</name>
  <files>src/hooks/useAccountStatus.js</files>
  <action>
Create a hook to check account status for route guarding:

```javascript
import { useEffect, useState } from 'react';
import supabase from '../services/supabase';

/**
 * Hook to check student account status
 * @param {string} userId - Student UUID (from auth)
 * @returns {{ status, loading, isSuspended, suspensionReason, parentEmail, refetch }}
 */
export function useAccountStatus(userId) {
  const [status, setStatus] = useState(null);
  const [parentEmail, setParentEmail] = useState(null);
  const [loading, setLoading] = useState(true);

  const fetchStatus = async () => {
    if (!userId) {
      setLoading(false);
      return;
    }

    try {
      const { data, error } = await supabase
        .from('students')
        .select('account_status, parent_email, deletion_scheduled_at')
        .eq('id', userId)
        .single();

      if (error) {
        // User might be a teacher, not a student
        if (error.code === 'PGRST116') {
          setStatus('active'); // Teachers don't have account_status
        } else {
          console.error('Error fetching account status:', error);
          setStatus('active'); // Default to active on error
        }
      } else {
        setStatus(data?.account_status || 'active');
        setParentEmail(data?.parent_email);
      }
    } catch (err) {
      console.error('Error in useAccountStatus:', err);
      setStatus('active');
    } finally {
      setLoading(false);
    }
  };

  useEffect(() => {
    fetchStatus();
  }, [userId]);

  const isSuspended = status === 'suspended_consent' || status === 'suspended_deletion';

  const suspensionReason = status === 'suspended_consent'
    ? 'consent'
    : status === 'suspended_deletion'
    ? 'deletion'
    : null;

  return {
    status,
    loading,
    isSuspended,
    suspensionReason,
    parentEmail,
    refetch: fetchStatus
  };
}

export default useAccountStatus;
```

Hook returns suspension reason so UI can show appropriate message.
  </action>
  <verify>
File exists at src/hooks/useAccountStatus.js
Exports useAccountStatus hook
Returns status, loading, isSuspended, suspensionReason, parentEmail, refetch
Handles case where user is teacher (no account_status)
  </verify>
  <done>
Account status hook enables route guarding and provides suspension details for UI.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create Suspended Account UI</name>
  <files>src/components/auth/ParentalConsentPending.jsx</files>
  <action>
Create the child-friendly suspended account component:

```jsx
import { useState } from 'react';
import { Mail, Clock, RefreshCw, Loader2 } from 'lucide-react';
import { resendConsentEmail } from '../../services/consentService';

/**
 * Displayed to under-13 users awaiting parental consent
 */
export function ParentalConsentPending({ studentId, parentEmail, onLogout }) {
  const [resending, setResending] = useState(false);
  const [resendSuccess, setResendSuccess] = useState(false);
  const [error, setError] = useState(null);

  const handleResendEmail = async () => {
    setResending(true);
    setError(null);
    setResendSuccess(false);

    try {
      await resendConsentEmail(studentId);
      setResendSuccess(true);
    } catch (err) {
      setError(err.message || 'Failed to resend email');
    } finally {
      setResending(false);
    }
  };

  // Mask parent email for privacy
  const maskedEmail = parentEmail?.replace(/(.{2}).*@/, '$1***@') || 'your parent';

  return (
    <div className="min-h-screen bg-gradient-to-b from-indigo-900 via-purple-900 to-indigo-900 flex items-center justify-center p-4">
      <div className="max-w-md w-full bg-white/10 backdrop-blur-lg rounded-2xl p-8 text-center">
        {/* Friendly illustration */}
        <div className="text-7xl mb-6 animate-bounce">
          <span role="img" aria-label="mailbox">ðŸ“¬</span>
        </div>

        <h1 className="text-2xl font-bold text-white mb-2">
          Almost there!
        </h1>

        <p className="text-lg text-white/90 mb-4">
          Ask your parent to check their email so you can start playing!
        </p>

        <div className="bg-white/10 rounded-lg p-4 mb-6">
          <div className="flex items-center justify-center gap-2 text-indigo-300 mb-2">
            <Mail className="w-4 h-4" />
            <span className="text-sm">Email sent to:</span>
          </div>
          <p className="text-white font-medium">{maskedEmail}</p>
        </div>

        <div className="flex items-center justify-center gap-2 text-white/70 text-sm mb-6">
          <Clock className="w-4 h-4" />
          <span>Waiting for parent approval...</span>
        </div>

        {error && (
          <div className="p-2 mb-4 text-xs text-red-200 bg-red-500/20 border border-red-200/30 rounded-lg">
            {error}
          </div>
        )}

        {resendSuccess && (
          <div className="p-2 mb-4 text-xs text-green-200 bg-green-500/20 border border-green-200/30 rounded-lg">
            Email sent! Ask your parent to check their inbox.
          </div>
        )}

        <div className="space-y-3">
          <button
            onClick={handleResendEmail}
            disabled={resending}
            className="w-full py-2.5 px-4 flex items-center justify-center gap-2 text-sm font-medium text-indigo-300 border-2 border-indigo-400/50 rounded-lg hover:bg-indigo-500/20 transition-colors disabled:opacity-50"
          >
            {resending ? (
              <Loader2 className="w-4 h-4 animate-spin" />
            ) : (
              <RefreshCw className="w-4 h-4" />
            )}
            Resend email to parent
          </button>

          <button
            onClick={onLogout}
            className="w-full py-2 text-sm text-white/60 hover:text-white/80 transition-colors"
          >
            Log out
          </button>
        </div>

        <p className="mt-6 text-xs text-white/50">
          Your parent will get an email with a link to approve your account.
          Once they click the link, you'll be able to start learning piano!
        </p>
      </div>
    </div>
  );
}

export default ParentalConsentPending;
```

Design matches the message from CONTEXT.md: "Ask your parent to check their email so you can start playing!"
Include ability to resend consent email.
  </action>
  <verify>
File exists at src/components/auth/ParentalConsentPending.jsx
Shows child-friendly message with mailbox emoji
Displays masked parent email
Has "Resend email" button that calls resendConsentEmail
Has logout option
  </verify>
  <done>
Suspended account UI provides friendly waiting experience with ability to resend consent email.
  </done>
</task>

<task type="auto">
  <name>Task 3: Create Consent Verification Page</name>
  <files>src/pages/ConsentVerifyPage.jsx</files>
  <action>
Create the page parents see when clicking the consent email link:

```jsx
import { useEffect, useState } from 'react';
import { useSearchParams, useNavigate } from 'react-router-dom';
import { CheckCircle, XCircle, Loader2, Shield, Music } from 'lucide-react';
import { verifyParentalConsent } from '../services/consentService';

/**
 * Page displayed when parent clicks consent verification link
 * URL: /consent/verify?token=xxx&student=yyy
 */
export function ConsentVerifyPage() {
  const [searchParams] = useSearchParams();
  const navigate = useNavigate();
  const [status, setStatus] = useState('verifying'); // verifying | success | error
  const [error, setError] = useState(null);

  const token = searchParams.get('token');
  const studentId = searchParams.get('student');

  useEffect(() => {
    const verify = async () => {
      if (!token || !studentId) {
        setStatus('error');
        setError('Invalid verification link. Please check the link from your email.');
        return;
      }

      try {
        await verifyParentalConsent(studentId, token);
        setStatus('success');
      } catch (err) {
        setStatus('error');
        setError(err.message || 'Verification failed. The link may have expired.');
      }
    };

    verify();
  }, [token, studentId]);

  return (
    <div className="min-h-screen bg-gradient-to-b from-indigo-900 via-purple-900 to-indigo-900 flex items-center justify-center p-4">
      <div className="max-w-md w-full bg-white/10 backdrop-blur-lg rounded-2xl p-8 text-center">

        {status === 'verifying' && (
          <>
            <Loader2 className="w-16 h-16 text-indigo-400 animate-spin mx-auto mb-6" />
            <h1 className="text-2xl font-bold text-white mb-2">
              Verifying...
            </h1>
            <p className="text-white/70">
              Please wait while we verify your consent.
            </p>
          </>
        )}

        {status === 'success' && (
          <>
            <div className="relative w-20 h-20 mx-auto mb-6">
              <div className="absolute inset-0 bg-green-500/20 rounded-full animate-ping" />
              <CheckCircle className="w-20 h-20 text-green-400 relative" />
            </div>
            <h1 className="text-2xl font-bold text-white mb-2">
              Account Approved!
            </h1>
            <p className="text-white/80 mb-6">
              Your child's account is now active. They can log in and start learning piano!
            </p>

            {/* Data collection summary */}
            <div className="bg-white/10 rounded-lg p-4 mb-6 text-left">
              <div className="flex items-center gap-2 text-indigo-300 mb-3">
                <Shield className="w-4 h-4" />
                <span className="text-sm font-medium">What we collect</span>
              </div>
              <ul className="text-xs text-white/70 space-y-1.5">
                <li>â€¢ Profile info (name, email)</li>
                <li>â€¢ Practice scores and progress</li>
                <li>â€¢ Daily practice goals</li>
                <li>â€¢ Unlocked achievements</li>
              </ul>
              <p className="text-xs text-white/50 mt-3">
                We never share your child's data with third parties.
                You can export or delete data anytime.
              </p>
            </div>

            <div className="flex gap-3">
              <a
                href="/"
                className="flex-1 py-2.5 px-4 flex items-center justify-center gap-2 text-sm font-medium text-white bg-indigo-600 rounded-lg hover:bg-indigo-700 transition-colors"
              >
                <Music className="w-4 h-4" />
                Go to App
              </a>
            </div>
          </>
        )}

        {status === 'error' && (
          <>
            <XCircle className="w-16 h-16 text-red-400 mx-auto mb-6" />
            <h1 className="text-2xl font-bold text-white mb-2">
              Verification Failed
            </h1>
            <p className="text-white/70 mb-6">
              {error}
            </p>
            <div className="space-y-3">
              <button
                onClick={() => navigate('/')}
                className="w-full py-2.5 px-4 text-sm font-medium text-white bg-indigo-600 rounded-lg hover:bg-indigo-700 transition-colors"
              >
                Go to Home
              </button>
              <p className="text-xs text-white/50">
                If your link expired, ask your child to resend the consent email from the app.
              </p>
            </div>
          </>
        )}

      </div>
    </div>
  );
}

export default ConsentVerifyPage;
```

Show data collection summary on success (COPPA requirement: inform parents what data is collected).
Handle expired/invalid tokens gracefully.
  </action>
  <verify>
File exists at src/pages/ConsentVerifyPage.jsx
Reads token and student from URL params
Calls verifyParentalConsent on mount
Shows success state with data collection summary
Shows error state with helpful message
  </verify>
  <done>
Consent verification page allows parents to approve accounts and informs them of data collection.
  </done>
</task>

<task type="auto">
  <name>Task 4: Integrate Route Guard in App.jsx</name>
  <files>src/App.jsx</files>
  <action>
Update App.jsx to:

1. **Add consent verification route**:
   ```jsx
   import ConsentVerifyPage from './pages/ConsentVerifyPage';

   // In routes (public, no auth required)
   <Route path="/consent/verify" element={<ConsentVerifyPage />} />
   ```

2. **Add account status check for protected routes**:
   - Import useAccountStatus hook
   - In the authenticated section, check account status
   - If suspended, show ParentalConsentPending instead of normal content

   The approach depends on current App.jsx structure. Common pattern:

   ```jsx
   import { useAccountStatus } from './hooks/useAccountStatus';
   import ParentalConsentPending from './components/auth/ParentalConsentPending';

   // Inside authenticated wrapper component:
   function AuthenticatedApp({ user }) {
     const { isSuspended, suspensionReason, parentEmail, loading } = useAccountStatus(user?.id);

     if (loading) {
       return <LoadingSpinner />;
     }

     // Show suspended UI for students awaiting consent
     if (isSuspended && suspensionReason === 'consent') {
       return (
         <ParentalConsentPending
           studentId={user.id}
           parentEmail={parentEmail}
           onLogout={() => supabase.auth.signOut()}
         />
       );
     }

     // Normal app content
     return <AppRoutes />;
   }
   ```

3. **Ensure teachers bypass this check** (they don't have account_status):
   The hook already handles this - returns 'active' for users not in students table.

Read existing App.jsx structure first and integrate appropriately.
Do NOT break existing routing or authentication flow.
  </action>
  <verify>
App.jsx has /consent/verify route
App.jsx imports and uses useAccountStatus
Suspended students see ParentalConsentPending component
Teachers and active students see normal app
Console verify with a test suspended account
  </verify>
  <done>
Route guard prevents suspended accounts from accessing app and shows appropriate pending UI.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Complete parental consent UX flow:
- Suspended account UI with resend email capability
- Consent verification page for parents
- Route guard blocking suspended accounts
  </what-built>
  <how-to-verify>
1. Create a test account with DOB making user under 13
2. Verify account is created with suspended_consent status
3. Verify app shows "Almost there!" waiting screen with mailbox
4. Check console for consent URL (development mode)
5. Open consent URL in incognito window
6. Verify parent sees approval page with data summary
7. Click approve, verify success message
8. Return to child account - verify app now accessible
  </how-to-verify>
  <resume-signal>Type "approved" or describe issues to fix</resume-signal>
</task>

</tasks>

<verification>
- [ ] useAccountStatus hook created and exported
- [ ] ParentalConsentPending component shows waiting UI
- [ ] ConsentVerifyPage handles verification flow
- [ ] /consent/verify route exists in App.jsx
- [ ] Suspended accounts see pending UI instead of app
- [ ] Parents can verify consent via email link
- [ ] After verification, account becomes active
</verification>

<success_criteria>
Complete consent UX: suspended children see friendly waiting screen, parents can verify via email link, accounts activate after verification.
</success_criteria>

<output>
After completion, create `.planning/phases/02-coppa-compliance/02-06-SUMMARY.md`
</output>
