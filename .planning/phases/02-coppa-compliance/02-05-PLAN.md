---
phase: 02-coppa-compliance
plan: 05
type: execute
wave: 3
depends_on: ["02-01", "02-02", "02-04"]
files_modified:
  - src/components/auth/SignupForm.jsx
  - src/components/auth/ParentEmailStep.jsx
  - src/features/authentication/useSignup.js
autonomous: true

must_haves:
  truths:
    - "New students see DOB collection step before account creation form"
    - "Under-13 students must provide parent email before signup completes"
    - "Under-13 accounts are created in suspended_consent status"
    - "Parent receives consent email after under-13 signup"
  artifacts:
    - path: "src/components/auth/SignupForm.jsx"
      provides: "Two-stage signup with age gate"
      contains: "AgeGate"
    - path: "src/components/auth/ParentEmailStep.jsx"
      provides: "Parent email collection for under-13"
      exports: ["ParentEmailStep"]
    - path: "src/features/authentication/useSignup.js"
      provides: "Signup hook with COPPA support"
      contains: "account_status"
  key_links:
    - from: "SignupForm.jsx"
      to: "AgeGate"
      via: "component import"
      pattern: "import.*AgeGate"
    - from: "useSignup.js"
      to: "consentService"
      via: "import"
      pattern: "sendParentalConsentEmail"
---

<objective>
Modify the signup flow to collect DOB first (via AgeGate), require parent email for under-13 users, and create suspended accounts that require parental consent.

Purpose: COPPA requires knowing age BEFORE collecting personal information from children
Output: Two-stage signup flow with conditional parent email step
</objective>

<execution_context>
@C:\Users\pagis\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\pagis\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/02-coppa-compliance/02-CONTEXT.md
@.planning/phases/02-coppa-compliance/02-02-SUMMARY.md
@.planning/phases/02-coppa-compliance/02-04-SUMMARY.md
@src/components/auth/SignupForm.jsx
@src/features/authentication/useSignup.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Parent Email Collection Step</name>
  <files>src/components/auth/ParentEmailStep.jsx</files>
  <action>
Create a component for collecting parent email when user is under 13:

```jsx
import { useState } from 'react';
import { Mail, ArrowLeft, Info } from 'lucide-react';

/**
 * Parent email collection step for under-13 users
 * @param {Object} props
 * @param {Function} props.onSubmit - Called with parent email
 * @param {Function} props.onBack - Go back to previous step
 * @param {boolean} props.disabled - Disable inputs during submission
 */
export function ParentEmailStep({ onSubmit, onBack, disabled = false }) {
  const [parentEmail, setParentEmail] = useState('');
  const [confirmEmail, setConfirmEmail] = useState('');
  const [error, setError] = useState(null);

  const handleSubmit = (e) => {
    e.preventDefault();
    setError(null);

    if (!parentEmail || !confirmEmail) {
      setError('Please fill in both fields');
      return;
    }

    if (parentEmail.toLowerCase() !== confirmEmail.toLowerCase()) {
      setError('Email addresses do not match');
      return;
    }

    // Basic email validation
    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    if (!emailRegex.test(parentEmail)) {
      setError('Please enter a valid email address');
      return;
    }

    onSubmit(parentEmail.toLowerCase().trim());
  };

  const inputClass = `w-full px-2.5 md:px-3 py-1.5 md:py-2 text-sm rounded-lg border-2
    border-white/20 bg-white/15 backdrop-blur-sm focus:bg-white/25
    focus:ring-2 focus:ring-indigo-500 focus:border-indigo-400/50
    transition-all duration-300 text-white placeholder-white/70`;

  return (
    <div className="space-y-4">
      {/* Info banner */}
      <div className="p-3 bg-indigo-500/20 border border-indigo-400/30 rounded-lg">
        <div className="flex gap-2">
          <Info className="w-4 h-4 text-indigo-300 flex-shrink-0 mt-0.5" />
          <div className="text-xs text-white/90">
            <p className="font-medium mb-1">Parent or Guardian Required</p>
            <p className="text-white/70">
              Since you're under 13, we need a parent or guardian's email to create your account.
              They'll receive an email to approve your account.
            </p>
          </div>
        </div>
      </div>

      <form onSubmit={handleSubmit} className="space-y-3">
        {error && (
          <div className="p-2 text-xs text-red-200 bg-red-500/10 border border-red-200/20 rounded-lg">
            {error}
          </div>
        )}

        <div className="space-y-2">
          <div className="group">
            <label
              htmlFor="parent-email"
              className="block text-xs font-medium text-white/90 mb-0.5"
            >
              Parent/Guardian Email
            </label>
            <div className="relative">
              <Mail className="absolute left-2.5 top-1/2 -translate-y-1/2 w-4 h-4 text-white/50" />
              <input
                type="email"
                id="parent-email"
                value={parentEmail}
                onChange={(e) => setParentEmail(e.target.value)}
                disabled={disabled}
                className={`${inputClass} pl-9`}
                placeholder="parent@example.com"
                required
              />
            </div>
          </div>

          <div className="group">
            <label
              htmlFor="confirm-parent-email"
              className="block text-xs font-medium text-white/90 mb-0.5"
            >
              Confirm Email
            </label>
            <div className="relative">
              <Mail className="absolute left-2.5 top-1/2 -translate-y-1/2 w-4 h-4 text-white/50" />
              <input
                type="email"
                id="confirm-parent-email"
                value={confirmEmail}
                onChange={(e) => setConfirmEmail(e.target.value)}
                disabled={disabled}
                className={`${inputClass} pl-9`}
                placeholder="Confirm parent email"
                required
              />
            </div>
          </div>
        </div>

        <div className="flex gap-2">
          <button
            type="button"
            onClick={onBack}
            disabled={disabled}
            className="flex items-center justify-center gap-1 px-3 py-2 text-sm text-white/80 hover:text-white border-2 border-white/20 rounded-lg transition-colors"
          >
            <ArrowLeft className="w-3.5 h-3.5" />
            Back
          </button>
          <button
            type="submit"
            disabled={disabled}
            className="flex-1 py-2 text-sm font-medium text-white bg-indigo-600 rounded-lg hover:bg-indigo-700 transition-colors disabled:opacity-50"
          >
            Continue to Create Account
          </button>
        </div>
      </form>
    </div>
  );
}

export default ParentEmailStep;
```

Style to match existing auth forms. Include clear explanation of why parent email is needed.
  </action>
  <verify>
File exists at src/components/auth/ParentEmailStep.jsx
Exports ParentEmailStep component
Has email and confirm email inputs
Validates emails match
Shows info banner explaining requirement
  </verify>
  <done>
ParentEmailStep component collects and validates parent email for under-13 users with clear explanation of why it's needed.
  </done>
</task>

<task type="auto">
  <name>Task 2: Modify SignupForm for Two-Stage Flow</name>
  <files>src/components/auth/SignupForm.jsx</files>
  <action>
Modify SignupForm to implement the two-stage signup flow:

1. **Add state for signup stages**:
   - `step`: 'age' | 'parent-email' | 'details' (current form)
   - `dobData`: { dob: Date, isUnder13: boolean } | null
   - `parentEmail`: string | null

2. **Import new components**:
   ```javascript
   import { AgeGate } from './AgeGate';
   import { ParentEmailStep } from './ParentEmailStep';
   ```

3. **Stage flow logic**:
   - Start at 'age' step (show AgeGate)
   - On AgeGate submit:
     - If isUnder13: go to 'parent-email' step
     - If 13+: go to 'details' step (existing form)
   - On ParentEmailStep submit: go to 'details' step
   - On details submit: create account with DOB and parent email

4. **Render based on step**:
   ```jsx
   {step === 'age' && (
     <AgeGate
       onSubmit={handleAgeSubmit}
       onBack={onBackToLogin}
       disabled={isPending}
     />
   )}

   {step === 'parent-email' && (
     <ParentEmailStep
       onSubmit={handleParentEmailSubmit}
       onBack={() => setStep('age')}
       disabled={isPending}
     />
   )}

   {step === 'details' && (
     // Existing signup form JSX
   )}
   ```

5. **Pass DOB and parent email to useSignup**:
   ```javascript
   await signup({
     email,
     password,
     firstName,
     lastName: lastName || "",
     role,
     dateOfBirth: dobData?.dob || null,
     parentEmail: parentEmail || null,
   });
   ```

6. **Update title based on step**:
   - 'age': "Let's Get Started"
   - 'parent-email': "Almost There!"
   - 'details': "Create Account" (existing)

Keep ALL existing form fields and functionality for the 'details' step.
Only add the new stages before the existing form.
  </action>
  <verify>
SignupForm.jsx imports AgeGate and ParentEmailStep
Has step state with 'age', 'parent-email', 'details' stages
Renders AgeGate first by default
Routes under-13 to parent-email step
Routes 13+ directly to details step
Passes dateOfBirth and parentEmail to signup hook
  </verify>
  <done>
SignupForm implements two-stage flow: DOB collection first, parent email for under-13, then existing account details.
  </done>
</task>

<task type="auto">
  <name>Task 3: Update useSignup Hook for COPPA</name>
  <files>src/features/authentication/useSignup.js</files>
  <action>
Update the useSignup hook to handle COPPA-required fields:

1. **Accept new parameters**:
   ```javascript
   mutationFn: async ({ email, password, firstName, lastName, role, dateOfBirth, parentEmail }) => {
   ```

2. **Calculate is_under_13 on client** (defense in depth - DB has computed column too):
   ```javascript
   const isUnder13 = dateOfBirth
     ? new Date() < new Date(dateOfBirth.getTime() + 13 * 365.25 * 24 * 60 * 60 * 1000)
     : false;
   ```

3. **Update student record creation** to include new fields:
   ```javascript
   const { error: studentError } = await supabase
     .from("students")
     .upsert([{
       id: userId,
       first_name: normalizedFirstName,
       last_name: normalizedLastName || "",
       email: normalizedEmail,
       username: `${normalizedFirstName.toLowerCase() || "student"}${Math.random().toString(36).substr(2, 4)}`,
       level: "Beginner",
       studying_year: "1st Year",
       // NEW COPPA fields
       date_of_birth: dateOfBirth ? dateOfBirth.toISOString().split('T')[0] : null,
       parent_email: parentEmail || null,
       account_status: isUnder13 ? 'suspended_consent' : 'active',
       // Generate musical nickname for all users (useful for future features)
       musical_nickname: null, // Let DB trigger generate it
     }], {
       onConflict: "id",
     });
   ```

4. **Send consent email for under-13**:
   ```javascript
   import { sendParentalConsentEmail } from '../../services/consentService';

   // After student record creation, if under 13:
   if (isUnder13 && parentEmail) {
     try {
       await sendParentalConsentEmail(userId, parentEmail);
     } catch (consentError) {
       console.warn('Failed to send consent email:', consentError);
       // Don't fail signup - account created, consent email can be resent
     }
   }
   ```

5. **Update success message** for under-13:
   ```javascript
   onSuccess: (data, variables) => {
     const { role, dateOfBirth, parentEmail } = variables;
     const isUnder13 = dateOfBirth
       ? new Date() < new Date(dateOfBirth.getTime() + 13 * 365.25 * 24 * 60 * 60 * 1000)
       : false;

     if (isUnder13) {
       toast.success(
         `Account created! We've sent an email to ${parentEmail?.replace(/(.{2}).*@/, '$1***@')} for approval.`
       );
     } else {
       toast.success(
         `${role === "teacher" ? "Teacher" : "Student"} account created! Check your email to confirm.`
       );
     }
     navigate("/");
   }
   ```

Keep existing teacher signup flow unchanged (teachers are adults).
  </action>
  <verify>
useSignup.js accepts dateOfBirth and parentEmail parameters
Student records include date_of_birth, parent_email, account_status fields
Under-13 accounts created with status 'suspended_consent'
Consent email sent after under-13 signup
Success message differs for under-13 vs adult
  </verify>
  <done>
Signup hook creates COPPA-compliant accounts with proper status and triggers consent email for under-13 users.
  </done>
</task>

</tasks>

<verification>
- [ ] SignupForm shows AgeGate as first step
- [ ] Under-13 users see ParentEmailStep after AgeGate
- [ ] 13+ users skip directly to account details
- [ ] useSignup accepts and stores dateOfBirth, parentEmail
- [ ] Under-13 accounts created with account_status = 'suspended_consent'
- [ ] Consent email sent after under-13 signup
- [ ] Teacher signup unchanged (adults don't need age gate)
</verification>

<success_criteria>
New students complete age-appropriate signup flow. Under-13 accounts are suspended until parent verifies consent.
</success_criteria>

<output>
After completion, create `.planning/phases/02-coppa-compliance/02-05-SUMMARY.md`
</output>
