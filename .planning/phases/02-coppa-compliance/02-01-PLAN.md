---
phase: 02-coppa-compliance
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - supabase/migrations/20260201000001_coppa_schema.sql
autonomous: true

must_haves:
  truths:
    - "Students table has date_of_birth, account_status, parent_email, consent columns"
    - "is_under_13 computed column correctly identifies children"
    - "parental_consent_log table tracks all consent events with timestamps"
    - "parental_consent_tokens table stores verification tokens with expiry"
  artifacts:
    - path: "supabase/migrations/20260201000001_coppa_schema.sql"
      provides: "COPPA compliance schema additions"
      contains: "date_of_birth"
  key_links:
    - from: "students.is_under_13"
      to: "students.date_of_birth"
      via: "computed column"
      pattern: "GENERATED ALWAYS AS"
---

<objective>
Add database schema required for COPPA compliance: DOB tracking, account status states, parental consent logging, and consent verification tokens.

Purpose: Foundation for all COPPA features - age gate, consent flow, account suspension
Output: Single migration file with all required schema changes
</objective>

<execution_context>
@C:\Users\pagis\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\pagis\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/02-coppa-compliance/02-CONTEXT.md
@.planning/phases/02-coppa-compliance/02-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create COPPA Schema Migration</name>
  <files>supabase/migrations/20260201000001_coppa_schema.sql</files>
  <action>
Create a migration file that adds COPPA-required columns and tables:

1. **Alter students table** - Add columns:
   - `date_of_birth DATE` - User's birthday for age calculation
   - `is_under_13 BOOLEAN GENERATED ALWAYS AS (date_of_birth > CURRENT_DATE - INTERVAL '13 years') STORED` - Computed column
   - `account_status TEXT DEFAULT 'active' CHECK (account_status IN ('active', 'suspended_consent', 'suspended_deletion', 'deleted'))` - Account state
   - `parent_email TEXT` - Parent/guardian email for consent
   - `consent_verified_at TIMESTAMPTZ` - When parent verified consent
   - `consent_revoked_at TIMESTAMPTZ` - When consent was revoked
   - `deletion_requested_at TIMESTAMPTZ` - Soft delete request time
   - `deletion_scheduled_at TIMESTAMPTZ` - When hard delete will occur
   - `musical_nickname TEXT` - Anonymized display name for shared features

2. **Create parental_consent_log table**:
   ```sql
   CREATE TABLE IF NOT EXISTS parental_consent_log (
     id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
     student_id UUID NOT NULL REFERENCES students(id) ON DELETE CASCADE,
     parent_email TEXT NOT NULL,
     action TEXT NOT NULL CHECK (action IN ('requested', 'verified', 'revoked', 'expired')),
     ip_address TEXT,
     user_agent TEXT,
     created_at TIMESTAMPTZ DEFAULT NOW()
   );
   ```

3. **Create parental_consent_tokens table**:
   ```sql
   CREATE TABLE IF NOT EXISTS parental_consent_tokens (
     id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
     student_id UUID NOT NULL REFERENCES students(id) ON DELETE CASCADE,
     token_hash TEXT NOT NULL,
     expires_at TIMESTAMPTZ NOT NULL,
     used_at TIMESTAMPTZ,
     created_at TIMESTAMPTZ DEFAULT NOW()
   );
   ```

4. **Enable RLS on new tables** with policies:
   - `parental_consent_log`: Students can read their own logs, teachers can read connected students' logs
   - `parental_consent_tokens`: No direct access (service functions only)

5. **Add indexes**:
   - `idx_students_account_status` on students(account_status)
   - `idx_students_deletion_scheduled` on students(deletion_scheduled_at) WHERE deletion_scheduled_at IS NOT NULL
   - `idx_consent_tokens_student` on parental_consent_tokens(student_id)
   - `idx_consent_log_student` on parental_consent_log(student_id)

6. **Create musical nicknames array** - Use a SECURITY DEFINER function to generate random nicknames:
   ```sql
   CREATE OR REPLACE FUNCTION generate_musical_nickname()
   RETURNS TEXT AS $$
   DECLARE
     adjectives TEXT[] := ARRAY['Happy', 'Funny', 'Bouncy', 'Sparkly', 'Silly', 'Jazzy', 'Groovy', 'Peppy', 'Merry', 'Zippy'];
     nouns TEXT[] := ARRAY['Composer', 'Pianist', 'Melody', 'Harmony', 'Rhythm', 'Note', 'Chord', 'Piano', 'Music', 'Beat'];
   BEGIN
     RETURN adjectives[1 + floor(random() * array_length(adjectives, 1))] || ' ' ||
            nouns[1 + floor(random() * array_length(nouns, 1))];
   END;
   $$ LANGUAGE plpgsql VOLATILE;
   ```

Use `ALTER TABLE ... ADD COLUMN IF NOT EXISTS` for idempotency.
  </action>
  <verify>
Run: `npx supabase db diff` to verify migration syntax is valid.
Grep migration file for: `date_of_birth`, `account_status`, `parental_consent_log`, `parental_consent_tokens`
  </verify>
  <done>
Migration file exists with all required schema changes. Tables and columns can be applied to database.
  </done>
</task>

</tasks>

<verification>
- [ ] Migration file exists at supabase/migrations/20260201000001_coppa_schema.sql
- [ ] Contains ALTER TABLE students with all 9 new columns
- [ ] Contains CREATE TABLE parental_consent_log
- [ ] Contains CREATE TABLE parental_consent_tokens
- [ ] RLS enabled on new tables
- [ ] Indexes created for query performance
- [ ] generate_musical_nickname function exists
</verification>

<success_criteria>
Database schema supports: age verification, account suspension states, parental consent tracking with audit log, soft delete scheduling, and anonymous nicknames.
</success_criteria>

<output>
After completion, create `.planning/phases/02-coppa-compliance/02-01-SUMMARY.md`
</output>
