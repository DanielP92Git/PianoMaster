---
phase: 02-coppa-compliance
plan: 07
type: execute
wave: 1
depends_on: []
files_modified:
  - src/components/layout/TeacherDashboard.jsx
  - src/components/teacher/DataExportModal.jsx
  - src/components/teacher/AccountDeletionModal.jsx
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "Teachers can export all student data as downloadable JSON file"
    - "Teachers can permanently delete student accounts with cascading removal"
  artifacts:
    - path: "src/components/teacher/DataExportModal.jsx"
      provides: "Data export UI with download button"
      min_lines: 80
    - path: "src/components/teacher/AccountDeletionModal.jsx"
      provides: "Deletion confirmation with name input and grace period display"
      min_lines: 120
  key_links:
    - from: "src/components/layout/TeacherDashboard.jsx"
      to: "src/components/teacher/DataExportModal.jsx"
      via: "import and render"
      pattern: "import.*DataExportModal"
    - from: "src/components/layout/TeacherDashboard.jsx"
      to: "src/components/teacher/AccountDeletionModal.jsx"
      via: "import and render"
      pattern: "import.*AccountDeletionModal"
    - from: "src/components/teacher/DataExportModal.jsx"
      to: "src/services/dataExportService.js"
      via: "import downloadStudentDataJSON"
      pattern: "downloadStudentDataJSON"
    - from: "src/components/teacher/AccountDeletionModal.jsx"
      to: "src/services/accountDeletionService.js"
      via: "import requestAccountDeletion"
      pattern: "requestAccountDeletion"
---

<objective>
Wire the existing COPPA data export and account deletion services into the Teacher Dashboard UI.

Purpose: The dataExportService.js and accountDeletionService.js are fully implemented (183 and 237 lines respectively) but orphaned - no UI component imports or uses them. This plan closes the gap by creating modal components and adding action buttons to the student card UI.

Output: Teachers can click "Export Data" and "Delete Account" buttons on student cards, triggering the existing service functions through new modal components.
</objective>

<execution_context>
@C:\Users\pagis\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\pagis\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-coppa-compliance/02-VERIFICATION.md

# Services to wire (already complete)
@src/services/dataExportService.js
@src/services/accountDeletionService.js

# UI target (add export/delete buttons to student cards)
@src/components/layout/TeacherDashboard.jsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create DataExportModal component</name>
  <files>src/components/teacher/DataExportModal.jsx</files>
  <action>
Create a modal component for exporting student data:

1. Import from dataExportService:
   - `downloadStudentDataJSON` for direct download
   - `getDataSummary` to show what will be exported

2. Modal structure:
   - Title: "Export Student Data"
   - Show student name prominently (use `student.student_name` - the computed display name from TeacherDashboard)
   - Display data summary (table names and record counts) using getDataSummary()
   - COPPA notice explaining this is all data collected
   - "Download JSON" button that:
     a. Calls downloadStudentDataJSON(student.student_id)
     b. Creates an anchor element with the blob URL
     c. Sets filename to `{student_name}_data_export_{date}.json`
     d. Triggers download and revokes blob URL

3. States:
   - Loading state while fetching data summary
   - Error state if export fails
   - Success state showing download initiated

4. Use existing Modal component from `../ui/Modal`
5. Use existing Button component from `../ui/Button`
6. Match TeacherDashboard modal styling (dark theme: bg-gray-900, text-white)

Props: { isOpen, onClose, student }
  - student object has: { student_id, student_name, first_name, last_name, ... }
  - Use student.student_id for API calls
  - Use student.student_name for display and filename
  </action>
  <verify>File exists with proper imports from dataExportService.js, renders Modal with download button</verify>
  <done>DataExportModal.jsx exists, imports downloadStudentDataJSON and getDataSummary, uses student.student_id for API calls and student.student_name for display</done>
</task>

<task type="auto">
  <name>Task 2: Create AccountDeletionModal component</name>
  <files>src/components/teacher/AccountDeletionModal.jsx</files>
  <action>
Create a modal component for account deletion with name confirmation:

1. Import from accountDeletionService:
   - `requestAccountDeletion` for initiating deletion
   - `getAccountDeletionStatus` to check current status
   - `cancelDeletionRequest` to cancel during grace period

2. Modal has two modes based on getAccountDeletionStatus():

   **Mode A - Not pending deletion:**
   - Title: "Delete Student Account"
   - Warning icon and red styling for severity
   - Explain: 30-day grace period, all data will be permanently deleted
   - Show what will be deleted (list tables from dataExportService.getExportedDataTypes())
   - Name confirmation input: "Type {student.student_name} to confirm"
   - Disabled "Delete Account" button until input matches student.student_name (case-insensitive)
   - On confirm: call requestAccountDeletion(student.student_id, confirmationName)

   **Mode B - Pending deletion (isPendingDeletion=true):**
   - Title: "Deletion Pending"
   - Show scheduled deletion date and days remaining
   - Warning: "Account will be permanently deleted on {date}"
   - "Cancel Deletion" button to restore account
   - On cancel: call cancelDeletionRequest(student.student_id)

3. States:
   - Loading while checking deletion status
   - Processing while deletion/cancel in progress
   - Error with retry option
   - Success with appropriate message

4. Use existing Modal, Button, Input components
5. Match TeacherDashboard dark theme styling
6. Use toast notifications for success/error (import from react-hot-toast)

Props: { isOpen, onClose, student, onDeletionRequested }
  - student object has: { student_id, student_name, first_name, last_name, ... }
  - Use student.student_id for API calls
  - Use student.student_name for display and name confirmation prompt
  </action>
  <verify>File exists with proper imports from accountDeletionService.js, has name confirmation and grace period UI</verify>
  <done>AccountDeletionModal.jsx exists, imports deletion service functions, uses student.student_id for API calls and student.student_name for name confirmation</done>
</task>

<task type="auto">
  <name>Task 3: Wire modals into TeacherDashboard</name>
  <files>src/components/layout/TeacherDashboard.jsx</files>
  <action>
Add data export and account deletion functionality to the teacher dashboard:

1. Add imports at top of file:
   ```javascript
   import DataExportModal from '../teacher/DataExportModal';
   import AccountDeletionModal from '../teacher/AccountDeletionModal';
   ```

2. Add Download and AlertTriangle icons to the existing lucide-react import block (lines 10-47).
   Insert alphabetically:
   - `AlertTriangle` after `Award` (around line 34)
   - `Download` after `ChevronDown` (around line 43)
   The import block starts with `import {` and ends with `} from "lucide-react";`

3. Add state variables in TeacherDashboard component (around line 1430 with other modal states):
   ```javascript
   const [showExportModal, setShowExportModal] = useState(false);
   const [showAccountDeletionModal, setShowAccountDeletionModal] = useState(false);
   const [studentForExport, setStudentForExport] = useState(null);
   const [studentForAccountDeletion, setStudentForAccountDeletion] = useState(null);
   ```

4. Add handler functions (near other handlers around line 1890):
   ```javascript
   const handleExportData = (student) => {
     setStudentForExport(student);
     setShowExportModal(true);
   };

   const handleAccountDeletion = (student) => {
     setStudentForAccountDeletion(student);
     setShowAccountDeletionModal(true);
   };

   const handleDeletionRequested = () => {
     // Refresh student list after deletion initiated
     queryClient.invalidateQueries(['teacher-students']);
     setShowAccountDeletionModal(false);
   };
   ```

5. Add two new action buttons to student cards. Find the Edit3 button (search for `<Edit3 className="h-3.5 w-3.5" />`), insert AFTER that button's closing `</button>` and BEFORE the Trash2 delete button:
   ```jsx
   <button
     onClick={(e) => {
       e.stopPropagation();
       handleExportData(student);
     }}
     className="min-w-0 rounded-lg p-1.5 text-cyan-400 transition-colors hover:bg-cyan-500/20 hover:text-cyan-300"
     title="Export Data"
   >
     <Download className="h-3.5 w-3.5" />
   </button>
   <button
     onClick={(e) => {
       e.stopPropagation();
       handleAccountDeletion(student);
     }}
     className="min-w-0 rounded-lg p-1.5 text-orange-400 transition-colors hover:bg-orange-500/20 hover:text-orange-300"
     title="Delete Account (COPPA)"
   >
     <AlertTriangle className="h-3.5 w-3.5" />
   </button>
   ```

6. Render modals at end of component (after other modals, before closing fragment):
   ```jsx
   <DataExportModal
     isOpen={showExportModal}
     onClose={() => setShowExportModal(false)}
     student={studentForExport}
   />
   <AccountDeletionModal
     isOpen={showAccountDeletionModal}
     onClose={() => setShowAccountDeletionModal(false)}
     student={studentForAccountDeletion}
     onDeletionRequested={handleDeletionRequested}
   />
   ```

7. IMPORTANT: Keep the existing Trash2 button (remove from teacher connection) - this is different from account deletion.
   The new AlertTriangle button = permanent COPPA account deletion
   The existing Trash2 button = remove from teacher's student list (not delete account)
  </action>
  <verify>npm run lint passes, DataExportModal and AccountDeletionModal are imported and rendered</verify>
  <done>TeacherDashboard imports both modals, renders export/delete buttons on student cards, wires handlers</done>
</task>

</tasks>

<verification>
After all tasks complete:
1. `npm run lint` passes with no errors
2. `grep -r "downloadStudentDataJSON" src/components/` shows DataExportModal import
3. `grep -r "requestAccountDeletion" src/components/` shows AccountDeletionModal import
4. `grep -r "DataExportModal" src/components/layout/TeacherDashboard.jsx` shows import
5. `grep -r "AccountDeletionModal" src/components/layout/TeacherDashboard.jsx` shows import
</verification>

<success_criteria>
1. DataExportModal component exists with downloadStudentDataJSON wiring
2. AccountDeletionModal component exists with name confirmation and grace period UI
3. TeacherDashboard has export and delete account buttons on each student card
4. Clicking export button opens DataExportModal for that student
5. Clicking delete account button opens AccountDeletionModal for that student
6. All existing service functions are now reachable from UI
</success_criteria>

<output>
After completion, create `.planning/phases/02-coppa-compliance/02-07-SUMMARY.md`
</output>
