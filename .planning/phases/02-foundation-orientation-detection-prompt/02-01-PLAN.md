---
phase: 02-foundation-orientation-detection-prompt
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/hooks/useOrientation.js
  - src/hooks/useRotatePrompt.js
  - src/components/orientation/RotatePromptOverlay.jsx
autonomous: true

must_haves:
  truths:
    - "useOrientation hook returns current orientation state synchronously on first render (no flash)"
    - "useRotatePrompt hook manages permanent dismiss via localStorage, auto-dismiss on landscape, and re-show-once logic"
    - "RotatePromptOverlay renders a full-screen blocking overlay with animated tilting phone icon and Play anyway dismiss button"
  artifacts:
    - path: "src/hooks/useOrientation.js"
      provides: "Reactive orientation detection via matchMedia"
      exports: ["useOrientation"]
    - path: "src/hooks/useRotatePrompt.js"
      provides: "Prompt visibility logic with permanent dismiss and re-show-once"
      exports: ["useRotatePrompt"]
    - path: "src/components/orientation/RotatePromptOverlay.jsx"
      provides: "Full-screen rotate prompt overlay component"
      exports: ["RotatePromptOverlay"]
  key_links:
    - from: "src/hooks/useRotatePrompt.js"
      to: "src/hooks/useOrientation.js"
      via: "imports useOrientation"
      pattern: "import.*useOrientation"
    - from: "src/components/orientation/RotatePromptOverlay.jsx"
      to: "framer-motion"
      via: "animation for tilting phone and fade transitions"
      pattern: "import.*framer-motion"
---

<objective>
Create the orientation detection hooks and rotate prompt overlay component.

Purpose: Provide reusable orientation detection and a playful rotate prompt that game components can integrate in Phase 02-02.
Output: Three files — useOrientation hook, useRotatePrompt hook, and RotatePromptOverlay component.
</objective>

<execution_context>
@C:/Users/pagis/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/pagis/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@src/hooks/useIsMobile.js — Follow this exact pattern for matchMedia listener setup, Safari fallback, and function initializer in useState
@src/utils/useMotionTokens.js — Use motion tokens for animation durations
@src/components/games/VictoryScreen.jsx — Reference for full-screen game overlay patterns (z-index, positioning)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create useOrientation and useRotatePrompt hooks</name>
  <files>src/hooks/useOrientation.js, src/hooks/useRotatePrompt.js</files>
  <action>
    **useOrientation.js** — Create a custom hook following the exact pattern in useIsMobile.js:
    - Use `useState(() => ...)` function initializer to read `window.matchMedia("(orientation: portrait)")` synchronously on first render (avoid flash of incorrect state)
    - SSR guard: if `typeof window === "undefined"`, default to `"portrait"`
    - In useEffect, create matchMedia listener with Safari fallback (`addEventListener` vs `addListener`)
    - Return object: `{ orientation, isPortrait, isLandscape }`
    - Empty dependency array — setup once, cleanup on unmount

    **useRotatePrompt.js** — Create a hook that encapsulates all prompt visibility logic:
    - Import `useOrientation` from `./useOrientation`
    - Import `useIsMobile` from `./useIsMobile`
    - Permanent dismiss: Read `localStorage.getItem("pianoapp-rotate-dismissed")` in useState initializer. On dismiss, set localStorage and state.
    - Auto-dismiss: When `isPortrait` transitions from true to false (landscape rotation), set `hasAutoDismissed` flag
    - Re-show once: Track `reshowUsed` ref (not state, to avoid extra renders). After first auto-dismiss, if user rotates back to portrait, show prompt ONE more time. After that second show (whether auto-dismissed or manually dismissed), stop showing.
    - Desktop filter: If `!isMobile`, never show prompt
    - Return object: `{ shouldShowPrompt, dismissPrompt }` where `dismissPrompt` stores to localStorage permanently
    - Logic summary for shouldShowPrompt:
      1. If permanentlyDismissed → false
      2. If !isMobile → false
      3. If !isPortrait → false (auto-dismiss happens via effect)
      4. If hasAutoDismissed AND reshowUsed → false
      5. Otherwise → true
  </action>
  <verify>
    - File exists: `src/hooks/useOrientation.js`
    - File exists: `src/hooks/useRotatePrompt.js`
    - Both files export named functions
    - useOrientation uses function initializer (not literal string) in useState
    - useOrientation has cleanup function in useEffect
    - useRotatePrompt imports useOrientation and useIsMobile
    - localStorage key is "pianoapp-rotate-dismissed"
  </verify>
  <done>useOrientation returns reactive orientation state with synchronous initial value. useRotatePrompt encapsulates all visibility logic including permanent dismiss, auto-dismiss, and re-show-once behavior.</done>
</task>

<task type="auto">
  <name>Task 2: Build RotatePromptOverlay component with animated phone icon</name>
  <files>src/components/orientation/RotatePromptOverlay.jsx</files>
  <action>
    Create `src/components/orientation/RotatePromptOverlay.jsx`:

    **Imports:**
    - `motion, AnimatePresence` from `framer-motion`
    - `Smartphone` from `lucide-react`
    - `useMotionTokens` from `../../utils/useMotionTokens`

    **Props:** `{ onDismiss }` — callback when user taps "Play anyway"

    **Structure:**
    - Wrap in `AnimatePresence` for exit animation
    - Outer `motion.div` with `fixed inset-0 z-[9999]` — full screen blocking overlay
    - Background: `bg-gradient-to-br from-slate-900/95 via-slate-800/95 to-slate-900/95` (per user decision: dark theme, slightly brighter, semi-transparent)
    - Flex centered column layout

    **Animated phone icon (per user decision: tilting animation, illustrated phone with piano/music):**
    - `motion.div` with `animate={{ rotate: [-15, 80] }}` — rocks from portrait (-15deg) toward landscape (80deg) in a gentle continuous loop
    - Transition: `duration: 1.5, repeat: Infinity, repeatType: "reverse", ease: "easeInOut"`
    - Inside: Lucide `Smartphone` icon at size 120, color `text-blue-400`, strokeWidth 1.5
    - Overlay mini piano keys on the phone screen using absolute-positioned div with small white and dark rectangles (5 keys pattern: white, black, white, black, white)
    - Add a small music note emoji or SVG near the phone for playfulness

    **Text (per user decision: playful, for 8-year-olds):**
    - Heading: "Turn Your Phone Sideways!" — `text-3xl font-bold text-white`
    - Subtext: "Games work best when your phone is sideways" — `text-lg text-white/80 text-center px-8`

    **Dismiss button (per user decision: text button, "Play anyway", no X icon):**
    - `<button>` with text "Play anyway"
    - Styling: `text-white/60 hover:text-white transition-colors` — subtle but visible
    - `onClick={onDismiss}`

    **Entry/exit animations:**
    - Entry: `initial={{ opacity: 0 }} animate={{ opacity: 1 }}` with duration from useMotionTokens
    - Exit: `exit={{ opacity: 0 }}` smooth fade-out (used when auto-dismissed on landscape rotation)

    **Note for Phase 05:** Add comment `// TODO Phase 05: Gate animation with AccessibilityContext reducedMotion` near the tilting animation

    Do NOT use i18n keys for text in this phase — Phase 05 handles translations.
  </action>
  <verify>
    - File exists: `src/components/orientation/RotatePromptOverlay.jsx`
    - Component exports `RotatePromptOverlay`
    - Uses framer-motion for animations
    - Has `fixed inset-0 z-[9999]` for full-screen overlay
    - Contains "Play anyway" button with onDismiss handler
    - Contains tilting phone animation with Smartphone icon
    - Contains mini piano keys illustration
    - Has Phase 05 TODO comment for reducedMotion
    - `npm run build` succeeds (no import errors)
  </verify>
  <done>RotatePromptOverlay renders a full-screen dark overlay with an animated tilting phone icon containing mini piano keys, playful text for young learners, and a "Play anyway" dismiss button. Smooth fade in/out transitions via framer-motion.</done>
</task>

</tasks>

<verification>
- `npm run build` succeeds with no errors
- All three files exist and export their named functions/components
- useOrientation follows useIsMobile.js pattern (matchMedia, Safari fallback, function initializer)
- useRotatePrompt handles: permanent dismiss (localStorage), auto-dismiss (landscape), re-show once, desktop filter
- RotatePromptOverlay matches all locked user decisions: tilting animation, illustrated phone, playful text, dark overlay, "Play anyway" button only
</verification>

<success_criteria>
- Three new files created with correct exports
- Build passes with zero errors
- Hook and component are ready for game integration in Plan 02-02
</success_criteria>

<output>
After completion, create `.planning/phases/02-foundation-orientation-detection-prompt/02-01-SUMMARY.md`
</output>
