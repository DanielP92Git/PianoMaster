---
phase: 14-node-type-visual-distinction
plan: 02
type: execute
wave: 2
depends_on: ["14-01"]
files_modified:
  - src/components/trail/TrailNode.jsx
  - src/components/trail/TrailNodeModal.jsx
autonomous: false

must_haves:
  truths:
    - "Each trail node displays a category-specific icon (treble clef, bass clef, metronome) or boss icon (trophy, crown)"
    - "Each trail node shows color-coded background matching its category (blue=treble, purple=bass, green=rhythm, gold=boss)"
    - "Boss nodes are visually larger (h-14 w-14 vs h-12 w-12) with a crown indicator"
    - "Locked nodes are fully grayed out with faint icon — no category color visible"
    - "Available/current nodes pulse to draw child's attention (respects reducedMotion)"
    - "TrailNodeModal header shows the same icon and color as the TrailNode for consistency"
    - "Stars display still works correctly on completed/mastered nodes"
  artifacts:
    - path: "src/components/trail/TrailNode.jsx"
      provides: "Node rendering with type-specific icons and colors"
      contains: "getNodeStateConfig"
    - path: "src/components/trail/TrailNodeModal.jsx"
      provides: "Modal with consistent node type icon and color"
      contains: "getNodeTypeIcon|getCategoryColors"
  key_links:
    - from: "src/components/trail/TrailNode.jsx"
      to: "src/utils/nodeTypeStyles.js"
      via: "imports getNodeStateConfig"
      pattern: "import.*getNodeStateConfig.*from.*nodeTypeStyles"
    - from: "src/components/trail/TrailNode.jsx"
      to: "src/contexts/AccessibilityContext.jsx"
      via: "useAccessibility for reducedMotion check"
      pattern: "useAccessibility"
    - from: "src/components/trail/TrailNodeModal.jsx"
      to: "src/utils/nodeTypeStyles.js"
      via: "imports getNodeTypeIcon and getCategoryColors"
      pattern: "import.*from.*nodeTypeStyles"
---

<objective>
Update TrailNode and TrailNodeModal to use the new node type style system, replacing generic state icons with category-specific icons and colors.

Purpose: Children need to recognize at a glance what kind of practice each node offers. This is the user-visible payoff of the style system built in Plan 01.

Output: TrailNode renders category icons with colored backgrounds, boss nodes stand out with gold treatment, and TrailNodeModal shows consistent icon/color in its header.
</objective>

<execution_context>
@C:\Users\pagis\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\pagis\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/14-node-type-visual-distinction/14-CONTEXT.md
@.planning/phases/14-node-type-visual-distinction/14-RESEARCH.md
@.planning/phases/14-node-type-visual-distinction/14-01-SUMMARY.md
@src/components/trail/TrailNode.jsx
@src/components/trail/TrailNodeModal.jsx
@src/utils/nodeTypeStyles.js
@src/data/nodeTypes.js
@src/data/constants.js
@src/contexts/AccessibilityContext.jsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update TrailNode with node type icons and category colors</name>
  <files>src/components/trail/TrailNode.jsx</files>
  <action>
Rewrite TrailNode.jsx to use the style system from nodeTypeStyles.js. The component's external API (props) stays the same. Only internal rendering changes.

**New imports to add:**
```javascript
import { useAccessibility } from '../../contexts/AccessibilityContext';
import { getNodeStateConfig } from '../../utils/nodeTypeStyles';
```

**Remove:** The entire `stateConfig` object (lines 35-92 in current file) which defines locked/available/current/completed/mastered with inline SVG icons and gradient strings. This is replaced by getNodeStateConfig.

**Replace the stateConfig lookup with:**
```javascript
const { IconComponent, colors, sizeClass, pulseClass, crownVisible } = useMemo(() => {
  return getNodeStateConfig(node.nodeType, node.category, nodeState, isBoss);
}, [node.nodeType, node.category, nodeState, isBoss]);
```

**Update the button element:**
- Replace `config.bgGradient` and `config.borderColor` and `config.glowColor` with `colors.bg`, `colors.border`, `colors.glow`
- Replace the fixed `h-12 w-12` with the dynamic `sizeClass` (returns h-14 w-14 for boss, h-12 w-12 for regular)
- Remove the old `${config.pulse ? 'animate-pulse' : ''}` — replace with `${pulseClass}` (which is 'animate-pulse-subtle' for current/available, '' otherwise)
- Add `${!reducedMotion ? pulseClass : ''}` — the CSS already handles this, but double-gating at component level is consistent with Phase 13 patterns
- Keep `rounded-xl` for regular nodes, `rounded-full` for boss nodes (existing behavior)
- Keep `transition-all duration-300`
- Keep `cursor-pointer hover:scale-110 active:scale-95` for unlocked, `cursor-not-allowed opacity-60` for locked

**Update the icon rendering area (replacing the old `config.icon` and `config.iconBg` div):**
```jsx
{/* Node type icon */}
<IconComponent
  size={isBoss ? 22 : 20}
  className={`${colors.text} ${colors.icon}`}
  strokeWidth={2}
/>
```
Remove the old `<div className={`flex items-center justify-center rounded-md p-0.5 ${config.iconBg}`}>` wrapper. The icon renders directly inside the button.

**Update boss crown indicator:**
- Change from always showing crown emoji on `isBoss` to using `crownVisible` (which hides crown when locked):
```jsx
{crownVisible && (
  <div className="absolute -top-4 text-lg drop-shadow-lg">
    <Crown size={18} className="text-yellow-400 fill-yellow-400" />
  </div>
)}
```
Import `Crown` from 'lucide-react' (it's already used in nodeTypeStyles but we need it directly here too for the overlay crown). Use the lucide Crown icon instead of the emoji &#128081; for visual consistency with the icon system.

**Keep unchanged:**
- Stars display (the three star SVGs above the node) — no changes needed
- Node name text below the button — no changes needed
- Best score percentage text — no changes needed
- `handleClick` function — no changes needed
- `useMemo` for nodeState derivation — no changes needed
- aria-label — no changes needed
- The `isFirstNode` prop and "Start here" / "Continue" label — no changes needed

**Important:** The node now needs `node.nodeType` and `node.category` from its data. Both fields already exist on all 93 nodes (verified in trebleUnit1Redesigned.js structure — every node has `nodeType` and `category` fields). The parent component (UnitSection in TrailMap.jsx) already passes the full `node` object.
  </action>
  <verify>
Run: `npm run build` — should complete with no errors.
Run: `npm run lint` — no new lint errors (pre-existing warnings are acceptable).
Grep: TrailNode.jsx should contain `getNodeStateConfig`, `useAccessibility`, `IconComponent`, `colors.bg`.
Grep: TrailNode.jsx should NOT contain the old `stateConfig` object or inline SVG icons for lock/play/checkmark.
  </verify>
  <done>TrailNode renders category-specific icons (treble clef, bass clef, metronome, trophy, crown) with color-coded backgrounds. Boss nodes are larger with crown overlay. Locked nodes are gray. Available nodes pulse. Build passes.</done>
</task>

<task type="auto">
  <name>Task 2: Update TrailNodeModal with consistent icon and color</name>
  <files>src/components/trail/TrailNodeModal.jsx</files>
  <action>
Update TrailNodeModal to show the node type icon and category color in the header area, consistent with how TrailNode displays it.

**New imports to add:**
```javascript
import { getNodeTypeIcon, getCategoryColors } from '../../utils/nodeTypeStyles';
```

**Update the header section** (the div containing h2 and boss emoji):
Replace the current header structure that shows `{node.isBoss && <span>&#128081;</span>}` with:

```jsx
<div className={`flex items-center gap-2 ${isRTL ? 'flex-row-reverse justify-end' : ''}`}>
  {/* Node type icon with category color background */}
  <div className={`flex h-8 w-8 items-center justify-center rounded-lg ${headerColors.bg} ${headerColors.border} border`}>
    <NodeIcon size={18} className={headerColors.text} strokeWidth={2} />
  </div>
  <h2 className="text-xl sm:text-2xl font-bold text-gray-900">{translateNodeName(node.name, t, i18n)}</h2>
</div>
```

Where `NodeIcon` and `headerColors` are computed at the top of the render:
```javascript
const NodeIcon = getNodeTypeIcon(node.nodeType, node.category);
const headerColors = getCategoryColors(
  node.isBoss ? 'boss' : node.category,
  isUnlocked ? 'available' : 'locked'
);
```

For the modal context, use 'available' state for unlocked nodes (shows full category color) and 'locked' state for locked nodes (shows gray).

**Note on modal color intensity:** The modal is on a white background, so the gradient backgrounds from getCategoryColors will work well as small icon badges. The 32px icon badge provides a subtle visual anchor matching the trail node's larger colored circle. Do NOT apply the category color to the entire modal — keep the modal white with just the icon badge colored.

**Update the skills badge colors** to match category:
The current skills section shows `bg-blue-100 text-blue-700` for all skills badges. Update to use the category color for consistency:
```jsx
{/* Determine skill badge colors based on category */}
const skillBadgeColors = node.isBoss
  ? 'bg-yellow-100 text-yellow-800'
  : node.category === 'treble_clef'
    ? 'bg-blue-100 text-blue-700'
    : node.category === 'bass_clef'
      ? 'bg-purple-100 text-purple-700'
      : node.category === 'rhythm'
        ? 'bg-emerald-100 text-emerald-700'
        : 'bg-blue-100 text-blue-700';
```
Use this for the `className` on the skill tag spans instead of the hardcoded blue.

**Keep unchanged:**
- All exercise list rendering
- Progress section
- XP reward section
- Action buttons (Cancel / Start Practice)
- Prerequisites section
- Modal overlay and close behavior
- All state management (exerciseProgress, nextExerciseIndex, isLoading)
  </action>
  <verify>
Run: `npm run build` — should complete with no errors.
Run: `npm run lint` — no new lint errors.
Grep: TrailNodeModal.jsx should contain `getNodeTypeIcon`, `getCategoryColors`, `NodeIcon`.
Grep: TrailNodeModal.jsx should NOT contain the old bare crown emoji pattern `&#128081;` in the header (may still exist elsewhere for backwards compat but should not be the primary display).
  </verify>
  <done>TrailNodeModal header shows node type icon with category-colored badge. Skills tags use category-appropriate colors. Modal is visually consistent with TrailNode. Build passes.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Complete node type visual distinction system across 93 trail nodes: category-specific icons (treble clef, bass clef, metronome) with color-coded backgrounds (blue, purple, green, gold for boss), state hierarchy (locked=gray, available=pulse, boss=crown+gold), and consistent modal display.</what-built>
  <how-to-verify>
1. Run `npm run dev` and navigate to the Trail Map page (/trail)
2. Check **treble clef section**: Nodes should show a treble clef icon with blue gradient background
3. Check **bass clef section**: Nodes should show a bass clef icon with purple gradient background
4. Check **rhythm section**: Nodes should show a metronome icon with green/emerald gradient background
5. Check **boss nodes**: Should be larger (h-14 vs h-12), show trophy/crown icon, gold gradient, crown overlay on top
6. Check **locked nodes**: Should be completely gray with faint icon — no category color visible
7. Check **available/current nodes**: Should have subtle pulse animation (glowing ring effect)
8. Click any node to open the modal: The modal header should show a small icon badge with category-appropriate color matching the trail node
9. Check that skills tags in the modal match category color (blue for treble, purple for bass, green for rhythm)
10. If accessibility settings allow, toggle reduced motion ON: Available nodes should stop pulsing
11. Check on mobile viewport (resize browser): All elements should remain legible and properly sized
  </how-to-verify>
  <resume-signal>Type "approved" or describe any visual issues to fix</resume-signal>
</task>

</tasks>

<verification>
1. `npm run build` passes with no errors
2. `npm run lint` shows no new errors
3. All 93 trail nodes display category-specific icons instead of generic state icons
4. Boss nodes are visually distinct (larger, gold, crown)
5. Locked nodes are gray, available nodes pulse, completed nodes show earned stars
6. TrailNodeModal shows consistent icon and color with TrailNode
7. Reduced motion disables pulse animation
8. No regressions in trail navigation (clicking nodes, opening modals, starting exercises)
</verification>

<success_criteria>
- VISUAL-01: Each node type displays an icon (treble clef, bass clef, metronome, trophy, crown, etc.)
- VISUAL-02: Each node shows color-coded background matching its category
- VISUAL-03: Boss nodes display crown icon and gold accent making them visually distinct
- VISUAL-04: Icon system uses lucide-react icons (plus custom SVGs for musical notation)
- VISUAL-05: TrailNodeModal displays node type icon and color consistently with TrailNode
- VISUAL-06: Locked/available/mastered states remain clear with new visual distinction
- All animations respect reducedMotion accessibility setting
</success_criteria>

<output>
After completion, create `.planning/phases/14-node-type-visual-distinction/14-02-SUMMARY.md`
</output>
