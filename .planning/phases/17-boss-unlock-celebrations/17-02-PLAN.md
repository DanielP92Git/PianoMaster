---
phase: 17-boss-unlock-celebrations
plan: 02
type: execute
wave: 2
depends_on: ["17-01"]
files_modified:
  - src/components/celebrations/BossUnlockModal.jsx
  - src/components/games/VictoryScreen.jsx
autonomous: false

must_haves:
  truths:
    - "Boss unlock modal shows 3 stages in sequence: celebration with confetti, unlock animation, next unit preview"
    - "Continue button appears after ~1 second delay on each stage"
    - "Auto-advance fallback progresses stages for distracted children after 10-12 seconds"
    - "Modal only appears once per boss node per user (localStorage tracking prevents repetition)"
    - "Reduced motion users see a single collapsed summary screen instead of 3 stages"
    - "Musical confetti uses gold/amber/white colors with music symbol particle shapes"
    - "Fanfare sound plays on stage 1 when user clicks Continue"
    - "Preview stage shows next unit name or path-complete message for final bosses"
    - "CTA button in preview stage navigates to first exercise of next unlocked node"
  artifacts:
    - path: "src/components/celebrations/BossUnlockModal.jsx"
      provides: "3-stage boss unlock celebration modal"
      exports: ["BossUnlockModal"]
      min_lines: 100
    - path: "src/components/games/VictoryScreen.jsx"
      provides: "Boss modal trigger integration"
      contains: "BossUnlockModal"
  key_links:
    - from: "src/components/games/VictoryScreen.jsx"
      to: "src/components/celebrations/BossUnlockModal.jsx"
      via: "conditional render when boss node first complete"
      pattern: "showBossModal.*BossUnlockModal"
    - from: "src/components/celebrations/BossUnlockModal.jsx"
      to: "src/hooks/useBossUnlockTracking.js"
      via: "localStorage show-once check"
      pattern: "useBossUnlockTracking"
    - from: "src/components/celebrations/BossUnlockModal.jsx"
      to: "src/utils/musicSymbolShapes.js"
      via: "drawShape prop for confetti particles"
      pattern: "getRandomMusicShape|MUSIC_SHAPES"
    - from: "src/components/celebrations/BossUnlockModal.jsx"
      to: "src/utils/fanfareSound.js"
      via: "playFanfare call on Continue button click"
      pattern: "playFanfare"
---

<objective>
Build the BossUnlockModal component with 3-stage celebration sequence and integrate it into VictoryScreen as a post-completion overlay for boss nodes.

Purpose: This is the centerpiece of Phase 17 — the memorable milestone moment when players defeat a boss node. The modal layers after VictoryScreen (z-[10000]) and fires once per boss node.

Output: BossUnlockModal component + VictoryScreen trigger integration.
</objective>

<execution_context>
@C:\Users\pagis\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\pagis\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/17-boss-unlock-celebrations/17-CONTEXT.md
@.planning/phases/17-boss-unlock-celebrations/17-RESEARCH.md
@.planning/phases/17-boss-unlock-celebrations/17-01-SUMMARY.md

Key existing files to reference:
- src/components/celebrations/ConfettiEffect.jsx — existing confetti wrapper (tier configs, accessibility)
- src/components/celebrations/CelebrationWrapper.jsx — accessibility wrapper pattern (skip, keyboard)
- src/utils/celebrationConstants.js — CELEBRATION_TIERS (boss: 3000ms), SKIP_KEYS
- src/utils/nodeTypeStyles.js — getCategoryColors (boss gold theme), getNodeTypeIcon
- src/components/games/VictoryScreen.jsx — trigger point (has celebrationData.isBoss, nodeComplete, nextNode)
- src/data/skillTrail.js — getNodeById, getNodesByCategory, SKILL_NODES
- src/services/skillProgressService.js — getNextNodeInPath (already called in VictoryScreen)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create BossUnlockModal component with 3-stage sequence</name>
  <files>src/components/celebrations/BossUnlockModal.jsx</files>
  <action>
  Create a multi-stage modal component for boss unlock celebrations.

  **Component: BossUnlockModal**
  Props:
  - `nodeId` (string) — completed boss node ID
  - `nodeName` (string) — display name of boss node
  - `nextNode` (object|null) — next recommended node from getNextNodeInPath, or null if path complete
  - `stars` (number) — stars earned on this boss (1-3)
  - `onClose` () — callback when modal dismissed/completed
  - `onNavigateToNext` () — callback to navigate to next node's first exercise

  **Stage Machine (useState):**
  Stages: CELEBRATION -> UNLOCK -> PREVIEW -> (done)

  Use `useState('celebration')` for current stage. Each stage transition:
  1. Reset `showContinueButton` to false
  2. Start 1-second timeout to show Continue button
  3. Start auto-advance timeout (10s for celebration, 8s for unlock, 12s for preview)

  **Stage 1: CELEBRATION**
  - Full-screen overlay at z-[10000] with `bg-black/70` backdrop
  - "Boss Defeated!" headline (or "PERFECT VICTORY!" if stars === 3) — large, gold text with text-shadow
  - Star display showing earned stars (reuse star rendering pattern from VictoryScreen)
  - Musical confetti: Use react-confetti directly with drawShape from musicSymbolShapes.js
    - numberOfPieces: 400 (elevated over standard 500 epic, since shapes are smaller)
    - colors: ['#FFD700', '#FFC107', '#FFA000', '#FFFFFF', '#FFE082'] — gold/amber/white
    - gravity: 0.25 (slower fall for dramatic effect)
    - recycle: false
    - drawShape: call getRandomMusicShape() for each particle
  - Continue button appears after 1 second at bottom

  **Stage 2: UNLOCK**
  - Same overlay background
  - Boss node visual (Crown or Trophy icon from nodeTypeStyles.js) centered, with golden glow animation
  - "Unit Complete!" subheading
  - Node name displayed: e.g., "Treble Unit 1 Boss"
  - Brief badge/achievement feel — a subtle scale-up animation on the icon (CSS keyframe)
  - Play fanfare sound when this stage activates (call playFanfare from user gesture on Continue click in Stage 1)
  - Continue button after 1 second

  **Stage 3: PREVIEW**
  - Same overlay background
  - If nextNode exists:
    - "New Path Unlocked!" headline
    - Next node name: e.g., "Next: C, D, E" with the node type icon
    - Show 3-4 upcoming nodes as small circles/icons in a horizontal row (mini trail snippet)
    - Get upcoming nodes: filter SKILL_NODES for same category as nextNode, orderInUnit >= nextNode.orderInUnit, limit 4
    - Each mini node: small circle (24px) with category color, locked appearance
    - CTA button: "Start Next Node" (calls onNavigateToNext)
  - If nextNode is null (final boss):
    - "Path Complete!" headline with crown icon
    - Congratulatory message based on category: "You've mastered all Treble Clef notes!" / "Bass Clef Master!" / "Rhythm Champion!"
    - CTA button: "Back to Trail" (calls onClose)
  - Auto-advance timeout: 12 seconds (more time to read)

  **Continue Button Pattern:**
  - Each stage has a Continue button that appears after 1 second delay (prevents accidental double-tap)
  - Button style: rounded-full, white bg, dark text, subtle shadow, min-width for touch target (48px height)
  - Button text: "Continue" for stages 1-2, "Start Next Node" or "Back to Trail" for stage 3
  - Disable pointer-events on button during the 1s delay (opacity-0 transition)

  **Auto-Advance Fallback:**
  - Each stage has a timeout that auto-advances to next stage
  - Timeouts: Stage 1: 10s, Stage 2: 8s, Stage 3: 12s
  - Clear timeout when user clicks Continue manually
  - Clear all timeouts on unmount

  **Reduced Motion:**
  - Import useAccessibility from AccessibilityContext
  - If reducedMotion is true: collapse entire modal to single summary screen:
    - "Boss Cleared!" headline
    - Star display
    - If nextNode: "Unit X Unlocked" + "Start Next Node" button
    - If no nextNode: "Path Complete!" + "Back to Trail" button
    - No confetti, no stage transitions, no animations
    - Single CTA button, no delay

  **Accessibility:**
  - role="dialog" on modal container
  - aria-modal="true"
  - aria-label="Boss unlock celebration"
  - Focus trap: auto-focus Continue button when it appears
  - Escape key dismisses modal (call onClose)

  **Styling:**
  - Dark backdrop: fixed inset-0 z-[10000] bg-black/70
  - Content card: max-w-sm mx-auto, dark card bg (bg-slate-800/95 backdrop-blur-sm), rounded-2xl, p-6
  - Gold accent colors for text and borders (text-yellow-400, border-yellow-500/30)
  - Smooth opacity transitions between stages (fade-in/out)
  </action>
  <verify>
  - File exists: `ls src/components/celebrations/BossUnlockModal.jsx`
  - Has all imports: grep for useBossUnlockTracking, musicSymbolShapes, fanfareSound, useAccessibility
  - Has 3 stages: grep for 'celebration', 'unlock', 'preview' strings
  - Has reduced motion check: grep for 'reducedMotion'
  - Has confetti integration: grep for 'Confetti' or 'drawShape'
  - Build passes: `npm run build 2>&1 | tail -5`
  </verify>
  <done>
  - BossUnlockModal renders 3 stages with Continue button advancement
  - Musical confetti with gold theme on Stage 1
  - Fanfare plays on Stage 2 entry
  - Preview shows next unit or path-complete message
  - Reduced motion collapses to single summary
  - Auto-advance timeouts prevent stuck state
  - Accessibility: dialog role, aria-modal, escape key, focus management
  </done>
</task>

<task type="auto">
  <name>Task 2: Integrate BossUnlockModal into VictoryScreen</name>
  <files>src/components/games/VictoryScreen.jsx</files>
  <action>
  Add boss unlock modal trigger to VictoryScreen when a boss node is completed for the first time.

  **Add imports:**
  - Import `BossUnlockModal` from '../celebrations/BossUnlockModal'
  - Import `useBossUnlockTracking` from '../../hooks/useBossUnlockTracking'

  **Add state:**
  - `const [showBossModal, setShowBossModal] = useState(false);`

  **Add tracking hook:**
  Call `useBossUnlockTracking(user?.id, nodeId)` at top level of component (unconditional hook call).
  Destructure: `const { shouldShow: shouldShowBossModal, markAsShown: markBossAsShown } = useBossUnlockTracking(user?.id, nodeId);`

  **Add trigger effect:**
  After trail processing completes, check if boss modal should show:
  ```
  useEffect(() => {
    if (!isProcessingTrail && nodeComplete && celebrationData.isBoss && shouldShowBossModal) {
      // Short delay to let VictoryScreen render first
      const timer = setTimeout(() => setShowBossModal(true), 500);
      return () => clearTimeout(timer);
    }
  }, [isProcessingTrail, nodeComplete, celebrationData.isBoss, shouldShowBossModal]);
  ```

  **Add close handler:**
  ```
  const handleBossModalClose = useCallback(() => {
    markBossAsShown();
    setShowBossModal(false);
  }, [markBossAsShown]);
  ```

  **Render BossUnlockModal:**
  Add after the existing ConfettiEffect render but still inside the main container:
  ```jsx
  {showBossModal && (
    <BossUnlockModal
      nodeId={nodeId}
      nodeName={getNodeById(nodeId)?.name || 'Boss'}
      nextNode={nextNode}
      stars={stars}
      onClose={handleBossModalClose}
      onNavigateToNext={() => {
        handleBossModalClose();
        navigateToNextNode();
      }}
    />
  )}
  ```

  **Important details:**
  - The boss modal renders ON TOP of VictoryScreen (z-[10000] vs z-[9999])
  - VictoryScreen content remains visible behind the darkened backdrop
  - The modal's confetti is separate from VictoryScreen's confetti (both can show)
  - The 500ms delay before showing boss modal gives VictoryScreen time to render XP/stars
  - useBossUnlockTracking must be called unconditionally (React hook rules) — it handles null userId/nodeId internally
  - When boss modal closes via "Start Next Node", it both marks as shown AND navigates to next node
  - When boss modal closes via "Back to Trail" (final boss), it marks as shown AND stays on VictoryScreen
  </action>
  <verify>
  - Import BossUnlockModal: `grep "BossUnlockModal" src/components/games/VictoryScreen.jsx`
  - Import useBossUnlockTracking: `grep "useBossUnlockTracking" src/components/games/VictoryScreen.jsx`
  - Shows boss modal state: `grep "showBossModal" src/components/games/VictoryScreen.jsx`
  - Build passes: `npm run build 2>&1 | tail -5`
  </verify>
  <done>
  - VictoryScreen imports and renders BossUnlockModal
  - Boss modal triggers when: trail processing complete + node complete + isBoss + shouldShow
  - Boss modal marked as shown on close (localStorage tracking)
  - "Start Next Node" navigates to next exercise
  - "Back to Trail" stays on VictoryScreen for final bosses
  - Hook called unconditionally at top level
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
  Boss unlock celebration system with 3-stage modal (celebration, unlock animation, next unit preview), musical confetti with gold theme, fanfare sound, and VictoryScreen integration.
  </what-built>
  <how-to-verify>
  1. Run `npm run dev` and open http://localhost:5174
  2. Log in as a student and navigate to the Trail Map
  3. Play a boss node (any node with isBoss: true — look for Trophy icons on the trail)
  4. Complete the boss node exercises with at least 60% score (to earn 1+ stars)
  5. On VictoryScreen, after ~500ms, the BossUnlockModal should appear:
     - **Stage 1**: "Boss Defeated!" with gold confetti and music symbols
     - Click "Continue" (appears after 1 second)
     - **Stage 2**: Boss node icon with gold glow + "Unit Complete!"
     - Click "Continue"
     - **Stage 3**: Next unit preview with upcoming node icons OR "Path Complete!" for final bosses
     - Click "Start Next Node" or "Back to Trail"
  6. Return to trail and complete the same boss again — the modal should NOT appear a second time
  7. Test reduced motion: Enable reduced motion in Accessibility settings, complete another boss node — should see single collapsed summary screen
  8. Check console for any errors during the celebration flow
  </how-to-verify>
  <resume-signal>Type "approved" or describe issues to fix</resume-signal>
</task>

</tasks>

<verification>
1. Boss modal shows exactly 3 stages in correct order (celebration -> unlock -> preview)
2. Musical confetti particles are recognizable music symbols in gold/amber/white
3. Continue button has ~1 second appearance delay per stage
4. Auto-advance works after 10/8/12 seconds per stage
5. Modal only shows once per boss node (repeat completion shows no modal)
6. Reduced motion shows collapsed single-screen summary
7. Fanfare sound plays (if AudioContext available)
8. Preview stage shows next unit or path-complete message
9. "Start Next Node" CTA navigates correctly
10. `npm run build` passes without errors
</verification>

<success_criteria>
- CELEB-06 met: 3-stage sequence with celebration, unlock animation, next unit preview
- CELEB-07 met: localStorage tracking prevents repetition
- Phase 17 success criteria #1: Boss unlock modal shows 3-stage sequence
- Phase 17 success criteria #2: Modal only shows once per boss node
- Phase 17 success criteria #3: Modal dismisses via Continue button or auto-advance timer
- Phase 17 success criteria #4: Boss confetti uses musical-themed particles with elevated intensity
</success_criteria>

<output>
After completion, create `.planning/phases/17-boss-unlock-celebrations/17-02-SUMMARY.md`
</output>
