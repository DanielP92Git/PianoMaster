---
phase: 17-boss-unlock-celebrations
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/hooks/useBossUnlockTracking.js
  - src/utils/musicSymbolShapes.js
  - src/utils/fanfareSound.js
autonomous: true

must_haves:
  truths:
    - "Boss unlock tracking hook correctly reads and writes localStorage with user-scoped keys"
    - "Music symbol canvas drawing functions produce recognizable note/clef/sharp shapes"
    - "Fanfare sound plays a 1-2 second triumphant arpeggio via Web Audio API"
    - "All utilities handle edge cases (Safari private mode, missing AudioContext, invalid inputs)"
  artifacts:
    - path: "src/hooks/useBossUnlockTracking.js"
      provides: "localStorage-based show-once tracking for boss unlock modals"
      exports: ["useBossUnlockTracking"]
    - path: "src/utils/musicSymbolShapes.js"
      provides: "Canvas drawing functions for musical confetti particles"
      exports: ["drawQuarterNote", "drawEighthNote", "drawTrebleClef", "drawSharp", "drawFlat", "MUSIC_SHAPES", "getRandomMusicShape"]
    - path: "src/utils/fanfareSound.js"
      provides: "Web Audio API fanfare synthesis"
      exports: ["playFanfare", "createFanfareContext"]
  key_links:
    - from: "src/hooks/useBossUnlockTracking.js"
      to: "localStorage"
      via: "getItem/setItem with try-catch"
      pattern: "localStorage\\.(get|set)Item"
    - from: "src/utils/fanfareSound.js"
      to: "Web Audio API"
      via: "AudioContext oscillators"
      pattern: "createOscillator|AudioContext"
---

<objective>
Build the utility foundations for boss unlock celebrations: a localStorage tracking hook, canvas-based music symbol drawing functions, and Web Audio API fanfare synthesis.

Purpose: These building blocks are consumed by the BossUnlockModal component (Plan 02). Isolating them in Plan 01 ensures clean separation of concerns and testability.

Output: Three utility files ready for integration.
</objective>

<execution_context>
@C:\Users\pagis\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\pagis\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/17-boss-unlock-celebrations/17-CONTEXT.md
@.planning/phases/17-boss-unlock-celebrations/17-RESEARCH.md

Key existing patterns:
- src/utils/levelUpTracking.js — localStorage tracking pattern (hasLevelBeenCelebrated, markLevelCelebrated)
- src/components/celebrations/ConfettiEffect.jsx — react-confetti with drawShape support (z-[9998])
- src/utils/celebrationConstants.js — CELEBRATION_TIERS, SKIP_KEYS
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create useBossUnlockTracking hook and music symbol shapes</name>
  <files>src/hooks/useBossUnlockTracking.js, src/utils/musicSymbolShapes.js</files>
  <action>
  **useBossUnlockTracking.js:**
  Create a custom React hook for tracking which boss unlock celebrations have been shown.

  - Key format: `boss-unlocked-${userId}-${nodeId}` — scoped per user per node
  - Returns `{ shouldShow, markAsShown, isLoading }`
  - `shouldShow`: true when localStorage key doesn't exist (first time)
  - `markAsShown()`: sets localStorage key to 'true', updates state to shouldShow=false
  - `isLoading`: briefly true during initial check
  - All localStorage calls wrapped in try-catch for Safari private mode safety
  - If localStorage unavailable, fall back to `shouldShow = true` (show once per session) with console.warn
  - Follow the pattern from `src/utils/levelUpTracking.js` for localStorage access style
  - Hook params: `(userId, nodeId)` — both required, returns `shouldShow: false` if either is null/undefined

  **musicSymbolShapes.js:**
  Create canvas drawing functions for custom confetti particles. These functions receive a CanvasRenderingContext2D and draw music symbols at the origin.

  Functions to create:
  1. `drawQuarterNote(ctx)` — filled oval note head (slightly tilted ellipse) + vertical stem line
  2. `drawEighthNote(ctx)` — same as quarter note + flag curve at top of stem
  3. `drawTrebleClef(ctx)` — simplified S-curve using bezier curves (recognizable outline, not pixel-perfect)
  4. `drawSharp(ctx)` — two vertical lines + two angled horizontal lines (# symbol)
  5. `drawFlat(ctx)` — vertical line + small curved bump (b symbol)

  Export a `MUSIC_SHAPES` array containing all 5 functions for random selection.
  Export a `getRandomMusicShape()` function that returns a random drawing function.

  All drawing should:
  - Use relative coordinates centered at (0, 0)
  - Scale to approximately 8-12px for visibility as confetti particles
  - Use `ctx.fillStyle` and `ctx.strokeStyle` (not hardcoded colors — react-confetti sets colors via the particle)
  - Call `ctx.save()` at start and `ctx.restore()` at end
  </action>
  <verify>
  - File exists: `ls src/hooks/useBossUnlockTracking.js`
  - File exists: `ls src/utils/musicSymbolShapes.js`
  - Verify exports: `grep -c "export" src/hooks/useBossUnlockTracking.js` shows at least 1
  - Verify exports: `grep -c "export" src/utils/musicSymbolShapes.js` shows at least 7 (5 functions + MUSIC_SHAPES + getRandomMusicShape)
  - No import errors: `npx vite build --mode development 2>&1 | head -20` (check for resolution errors)
  </verify>
  <done>
  - useBossUnlockTracking hook exports correctly with userId/nodeId params
  - musicSymbolShapes.js exports 5 drawing functions + MUSIC_SHAPES array + getRandomMusicShape
  - All localStorage calls use try-catch
  - Canvas drawing functions use save/restore pattern
  </done>
</task>

<task type="auto">
  <name>Task 2: Create fanfareSound utility with Web Audio API synthesis</name>
  <files>src/utils/fanfareSound.js</files>
  <action>
  Create a Web Audio API-based fanfare sound utility for boss unlock celebrations.

  **playFanfare(audioContext?):**
  - Accepts optional AudioContext (creates one if not provided)
  - Synthesizes a triumphant 1.5-second fanfare: C5 -> E5 -> G5 -> C6 (major arpeggio)
  - Each note: ~300ms duration, staccato-like (sharp attack, moderate decay)
  - Use two oscillators slightly detuned for richness:
    - osc1: 'triangle' waveform (mellow brass-like tone)
    - osc2: 'square' waveform at 1.01x frequency (adds harmonics)
  - Gain envelope per note:
    - Attack: 0 -> 0.3 in 30ms (sharp)
    - Decay: 0.3 -> 0.15 in 100ms
    - Release: 0.15 -> 0 in 100ms
  - Total volume: moderate (0.3 peak) — not startling for children
  - Notes played as arpeggio: each starts 250ms after the previous
  - Final note held slightly longer (400ms) for resolution
  - Returns a Promise that resolves when playback completes
  - Wraps everything in try-catch — silently fails if AudioContext unavailable (no crash)

  **createFanfareContext():**
  - Creates and returns an AudioContext (or reuses global singleton)
  - Uses singleton pattern to avoid "too many AudioContexts" browser error
  - Must be called from a user gesture context (click handler) to satisfy autoplay policy
  - Returns null if AudioContext is not supported

  **Important considerations:**
  - Guard against `window.AudioContext` and `window.webkitAudioContext` for Safari
  - Keep volume child-friendly (max gain 0.3)
  - Don't throw errors — audio is enhancement, not critical functionality
  - Export both functions for flexibility
  </action>
  <verify>
  - File exists: `ls src/utils/fanfareSound.js`
  - Verify exports: `grep "export" src/utils/fanfareSound.js` shows playFanfare and createFanfareContext
  - No syntax errors: `npx vite build --mode development 2>&1 | head -20`
  </verify>
  <done>
  - fanfareSound.js exports playFanfare and createFanfareContext
  - Fanfare plays C5-E5-G5-C6 arpeggio over ~1.5 seconds
  - Uses singleton AudioContext pattern
  - Silently fails if Web Audio API unavailable
  - Volume kept child-friendly (max 0.3 gain)
  </done>
</task>

</tasks>

<verification>
1. All three files exist and export correctly
2. `npm run build` completes without errors (no broken imports)
3. localStorage operations wrapped in try-catch
4. Canvas drawing functions use save/restore pattern
5. Audio synthesis uses try-catch and graceful fallback
</verification>

<success_criteria>
- Three utility files created with correct exports
- Build passes without errors
- All edge cases handled (Safari private mode, missing AudioContext, null params)
- Ready for consumption by BossUnlockModal component in Plan 02
</success_criteria>

<output>
After completion, create `.planning/phases/17-boss-unlock-celebrations/17-01-SUMMARY.md`
</output>
