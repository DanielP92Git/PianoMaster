---
phase: 01-critical-security-fixes
plan: 03
type: execute
wave: 2
depends_on: ["01-02"]
files_modified:
  - src/services/apiAuth.js
  - src/locales/en/common.json
  - src/locales/he/common.json
autonomous: true
user_setup: []

must_haves:
  truths:
    - "Logout clears all user-specific localStorage keys including migration flags, cached progress, and user data"
    - "App-wide preferences (language, accessibility) are preserved after logout"
    - "Authorization error messages are child-friendly and translated in both English and Hebrew"
  artifacts:
    - path: "src/services/apiAuth.js"
      provides: "Complete logout with comprehensive localStorage cleanup"
      contains: "keysToRemove"
    - path: "src/locales/en/common.json"
      provides: "Child-friendly error messages in English"
      contains: "errors"
    - path: "src/locales/he/common.json"
      provides: "Child-friendly error messages in Hebrew"
      contains: "errors"
  key_links:
    - from: "src/services/apiAuth.js"
      to: "localStorage"
      via: "iteration and removal of user-specific keys"
      pattern: "localStorage\\.key.*keysToRemove"
    - from: "src/locales/en/common.json"
      to: "i18next"
      via: "translation keys"
      pattern: "errors.*unauthorized"
---

<objective>
Complete the secure logout implementation with comprehensive localStorage cleanup and add child-friendly i18n error messages for authorization failures.

Purpose: Prevents data leakage on shared devices (school computers, family tablets) and ensures 8-year-old users understand authorization errors without technical jargon.

Output: Enhanced logout function and i18n translations for error messages in both English and Hebrew.
</objective>

<execution_context>
@C:\Users\pagis\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\pagis\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-critical-security-fixes/01-CONTEXT.md
@.planning/phases/01-critical-security-fixes/01-RESEARCH.md

# Existing patterns
@src/services/apiAuth.js
@src/locales/en/common.json

# Authorization utilities created in Plan 02
@src/services/authorizationUtils.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Enhance logout with comprehensive localStorage cleanup</name>
  <files>src/services/apiAuth.js</files>
  <action>
Enhance the existing logout function to clear ALL user-specific localStorage while preserving app-wide preferences.

Current logout (lines 185-208) already clears some keys. Expand to include:

**Keys to REMOVE (user-specific):**
- `migration_completed_*` - XP migration flags (prevents double XP)
- `dashboard_reminder_*` - User-specific reminder state
- `*_student_*` - Any key containing student ID
- `*_user_*` - Any key containing user reference
- `xp_migration_complete` - Legacy migration flag
- `cached_user_progress` - Cached progress data
- `sb-*-auth-token` - Supabase auth tokens (may persist after signOut)
- Keys matching UUID pattern (user IDs stored as keys)

**Keys to PRESERVE (app-wide):**
- `i18nextLng` - Language preference
- `accessibility_*` - Accessibility settings
- `theme` - Color theme preference
- `security_update_shown` - One-time security notice (created in future migration)

Updated logout function:
```javascript
export async function logout() {
  // Clear user-specific localStorage keys before signing out
  // This prevents data leakage on shared devices
  if (typeof window !== "undefined") {
    const keysToRemove = [];
    const keysToPreserve = ['i18nextLng', 'theme'];
    const prefixesToPreserve = ['accessibility_'];

    // UUID pattern for detecting user ID keys
    const uuidPattern = /^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i;

    for (let i = 0; i < localStorage.length; i++) {
      const key = localStorage.key(i);
      if (!key) continue;

      // Skip preserved keys
      if (keysToPreserve.includes(key)) continue;
      if (prefixesToPreserve.some(prefix => key.startsWith(prefix))) continue;

      // Remove user-specific keys
      const shouldRemove =
        key.startsWith('migration_completed_') ||
        key.startsWith('dashboard_reminder_') ||
        key.includes('_student_') ||
        key.includes('_user_') ||
        key === 'xp_migration_complete' ||
        key === 'cached_user_progress' ||
        key.startsWith('sb-') ||  // Supabase keys
        uuidPattern.test(key);     // Keys that are UUIDs

      if (shouldRemove) {
        keysToRemove.push(key);
      }
    }

    keysToRemove.forEach((key) => localStorage.removeItem(key));

    // Log cleanup count in development only
    if (process.env.NODE_ENV === 'development') {
      console.log(`Logout: Cleared ${keysToRemove.length} user-specific localStorage keys`);
    }
  }

  // Then sign out from Supabase
  const { error } = await supabase.auth.signOut();
  if (error) throw new Error(error.message);
}
```

Also add a confirmation dialog check (from CONTEXT.md decision):
- The UI should show "Are you sure?" before calling logout()
- This is a UI concern, not the service concern, but add a JSDoc comment noting this requirement
  </action>
  <verify>
Run: `grep -c "keysToRemove" src/services/apiAuth.js` should return 3+ (definition, push, forEach).
Run: `grep -c "accessibility_\|i18nextLng" src/services/apiAuth.js` should return 2+ (preserved keys).
Run: `grep "sb-" src/services/apiAuth.js` should show Supabase key clearing.
  </verify>
  <done>
logout() function clears all user-specific keys (migration flags, student data, Supabase tokens) while preserving app-wide preferences (language, accessibility, theme). UUID pattern matching catches any user ID stored as key.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add child-friendly error messages to English locale</name>
  <files>src/locales/en/common.json</files>
  <action>
Add an "errors" section to the English locale file with child-friendly authorization messages.

Add this section after the existing top-level keys (app, common, auth, etc.):

```json
"errors": {
  "auth": {
    "notAuthenticated": "Please log in to continue.",
    "sessionExpired": "Your session ended. Please log in again."
  },
  "authorization": {
    "unauthorized": "Oops! You can't see that.",
    "noAccess": "Oops! That's not yours to see.",
    "teacherNoConnection": "You need to connect with this student first.",
    "selfOnly": "You can only do this for yourself."
  },
  "rateLimited": {
    "student": "Slow down! Try again in a few minutes.",
    "teacher": "Too many attempts. Please wait {{minutes}} minutes.",
    "generic": "Please wait a moment and try again."
  },
  "network": {
    "offline": "You're offline. Connect to the internet to continue.",
    "timeout": "That took too long. Please try again."
  },
  "generic": {
    "somethingWrong": "Oops! Something didn't work.",
    "tryAgain": "Please try again.",
    "contactSupport": "If this keeps happening, ask a grown-up for help."
  }
}
```

Design principles for these messages (from CONTEXT.md):
- Very simple vocabulary for 8-year-olds
- Friendly tone ("Oops!" not "Error:")
- Action-oriented when possible ("Please log in" not "You are not logged in")
- No technical jargon (no "unauthorized", "authentication failed", "403")
- Short sentences (under 10 words ideal)

Place this section alphabetically among other top-level keys in the JSON.
  </action>
  <verify>
Run: `grep -c "Oops" src/locales/en/common.json` should return 3+ (child-friendly messages).
Run: `grep "unauthorized\|notAuthenticated" src/locales/en/common.json` should show translation keys exist.
Run: `node -e "JSON.parse(require('fs').readFileSync('src/locales/en/common.json'))"` should succeed (valid JSON).
  </verify>
  <done>
English locale has "errors" section with child-friendly messages. Messages use simple vocabulary, friendly tone, and no technical jargon. JSON is valid.
  </done>
</task>

<task type="auto">
  <name>Task 3: Add child-friendly error messages to Hebrew locale</name>
  <files>src/locales/he/common.json</files>
  <action>
Add the corresponding "errors" section to the Hebrew locale file.

Hebrew translations should maintain the same friendly, simple tone:

```json
"errors": {
  "auth": {
    "notAuthenticated": "בבקשה התחבר כדי להמשיך.",
    "sessionExpired": "ההתחברות שלך הסתיימה. בבקשה התחבר שוב."
  },
  "authorization": {
    "unauthorized": "אופס! אתה לא יכול לראות את זה.",
    "noAccess": "אופס! זה לא שלך לראות.",
    "teacherNoConnection": "צריך להתחבר לתלמיד הזה קודם.",
    "selfOnly": "אתה יכול לעשות את זה רק בשביל עצמך."
  },
  "rateLimited": {
    "student": "לאט לאט! נסה שוב בעוד כמה דקות.",
    "teacher": "יותר מדי ניסיונות. בבקשה המתן {{minutes}} דקות.",
    "generic": "בבקשה המתן רגע ונסה שוב."
  },
  "network": {
    "offline": "אתה לא מחובר לאינטרנט. התחבר כדי להמשיך.",
    "timeout": "זה לקח יותר מדי זמן. בבקשה נסה שוב."
  },
  "generic": {
    "somethingWrong": "אופס! משהו לא עבד.",
    "tryAgain": "בבקשה נסה שוב.",
    "contactSupport": "אם זה ממשיך לקרות, בקש עזרה ממבוגר."
  }
}
```

Hebrew-specific considerations:
- Use informal/friendly register (not formal Hebrew)
- "אופס!" is a common interjection in Israeli Hebrew (borrowed from "Oops!")
- Use masculine forms as default (common in Hebrew apps for children)
- Keep sentences short for RTL readability
- {{minutes}} placeholder uses same i18next format

Ensure the JSON structure exactly matches the English version (same keys, same nesting).
  </action>
  <verify>
Run: `grep -c "אופס" src/locales/he/common.json` should return 3+ (matching English "Oops").
Run: `node -e "JSON.parse(require('fs').readFileSync('src/locales/he/common.json'))"` should succeed (valid JSON).
Run: `node -e "const en = JSON.parse(require('fs').readFileSync('src/locales/en/common.json')); const he = JSON.parse(require('fs').readFileSync('src/locales/he/common.json')); console.log(JSON.stringify(Object.keys(en.errors)) === JSON.stringify(Object.keys(he.errors)))"` should print "true" (matching structure).
  </verify>
  <done>
Hebrew locale has "errors" section matching English structure. Messages use friendly, informal Hebrew appropriate for children. JSON is valid and structure matches English exactly.
  </done>
</task>

</tasks>

<verification>
After all tasks complete:

1. Logout clears user data comprehensively:
   ```bash
   grep -A 30 "export async function logout" src/services/apiAuth.js
   # Should show comprehensive key matching logic
   ```

2. Error messages are translated in both languages:
   ```bash
   node -e "
     const en = JSON.parse(require('fs').readFileSync('src/locales/en/common.json'));
     const he = JSON.parse(require('fs').readFileSync('src/locales/he/common.json'));
     console.log('EN errors:', Object.keys(en.errors));
     console.log('HE errors:', Object.keys(he.errors));
   "
   # Should show matching error categories in both
   ```

3. Messages are child-appropriate:
   ```bash
   grep "Oops\|אופס" src/locales/*/common.json
   # Should show friendly messages in both languages
   ```
</verification>

<success_criteria>
- logout() clears all user-specific localStorage (migration flags, student data, Supabase tokens)
- logout() preserves app-wide preferences (language, accessibility, theme)
- English locale has "errors" section with child-friendly messages
- Hebrew locale has matching "errors" section with translated messages
- Both JSON files are valid and parseable
- Error messages avoid technical jargon and use friendly tone
</success_criteria>

<output>
After completion, create `.planning/phases/01-critical-security-fixes/01-03-SUMMARY.md`
</output>
