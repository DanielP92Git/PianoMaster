# Milestone v1.1: Parental Consent Email Service

**Status:** SHIPPED 2026-02-02
**Phases:** 5
**Total Plans:** 2

## Overview

Enable working parental consent emails so under-13 children can complete COPPA-required consent flow. This milestone adds the email delivery capability that was scaffolded in v1.0 but left with a TODO placeholder.

## Phases

### Phase 5: Parental Consent Email

**Goal**: Enable working parental consent emails so under-13 children can complete COPPA-required consent flow.
**Depends on**: v1.0 Security Hardening (database schema, consent tokens, client service)
**Plans**: 2 plans

Plans:
- [x] 05-01: Create Edge Function with Brevo API and email template
- [x] 05-02: Client integration, 406 fix, and error handling

**Requirements covered:**
- EMAIL-01: Edge Function sends consent verification email via Brevo API
- EMAIL-02: Email contains child-friendly branding and clear CTA for parent
- EMAIL-03: Consent URL in email works end-to-end (verify → activate account)
- FIX-01: Eliminate 406 console errors during role detection
- FIX-02: Handle edge cases (resend, expired tokens, invalid links)

**Success criteria (all met):**
1. Parent receives email within 30 seconds of child signup/resend request
2. Email displays correctly in Gmail, Outlook, Apple Mail
3. Clicking consent link activates child's account (status → 'active')
4. No 406 errors appear in browser console during any auth flow
5. Resend button works and invalidates previous tokens
6. Expired/invalid token links show helpful error message

**Files created:**
- `supabase/functions/send-consent-email/index.ts` (341 lines)
- `supabase/functions/.env.example`

**Files modified:**
- `src/services/consentService.js` - Edge Function integration
- `src/services/apiAuth.js` - .maybeSingle() for role detection
- `src/pages/ConsentVerifyPage.jsx` - Enhanced error handling
- `src/App.jsx` - Public route bypass for /consent/verify
- `src/features/authentication/useSignup.js` - Session conflict resolution
- `src/services/authorizationUtils.js` - .maybeSingle() for teacher check

---

## Milestone Summary

**Key Decisions:**

| Decision | Rationale | Outcome |
|----------|-----------|---------|
| Switch from Resend to Brevo | Resend free tier domain limitation | Good - 300 emails/day free |
| Use .maybeSingle() for optional queries | .single() throws 406 when no rows | Good - eliminated errors |
| SignOut before SignUp | Prevent session conflicts | Good - clean state |
| Public route bypass for consent verify | Parents need access regardless of child status | Good - flow works |
| Table-based HTML email layout | Outlook uses Word rendering engine | Good - cross-client compatible |
| 30-second timeout on API calls | Prevent hanging requests | Good - better UX |

**Issues Resolved:**

- CORS preflight failing (OPTIONS needed explicit 200 status)
- Resend domain limitation (switched to Brevo)
- Consent page not rendering (AuthenticatedWrapper was intercepting)
- Session conflicts (previous user session persisted)
- 406 errors in role detection (changed to .maybeSingle())

**Issues Deferred:**

- None

**Technical Debt Incurred:**

- None new (2 pre-existing items from v1.0 remain)

---

*For current project status, see .planning/ROADMAP.md (created for next milestone)*

---
*Archived: 2026-02-02 as part of v1.1 milestone completion*
